#set(pageId=RandomUtil.random(6))
#set(iYear=DateUtil.getYear())
#set(precisionConfig1=JBoltGlobalConfigCache.getConfigValue("precision_config1"))
#set(precisionConfig4=JBoltGlobalConfigCache.getConfigValue("precision_config4"))
#set(precisionConfig5=JBoltGlobalConfigCache.getConfigValue("precision_config5"))
<div class="jbolt_page_title">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="col">
                        #if(readonly != 'readonly')
                        <button onclick="submitThisForm()" class="btn btn-outline-secondary btn-sx">保存</button>
                        #end
                        #if(subcontractsaleorderm.iAutoId?? && subcontractsaleorderm.iorderstatus != 7)
                        #include("/_view/_common/_approval_btns.html", uri="/admin/subcontractsaleorderm",
                        formSn="Co_SubcontractSaleOrderM", o=subcontractsaleorderm, primaryKeyName="iAutoId",
                        className="cn.rjtech.admin.subcontractsaleorderm.SubcontractsaleordermService",  permissionKeyPrefix="subcontractsaleorderm")
                        #end
                        <button onclick="closeHandler()" class="btn btn-outline-secondary btn-sx">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form onsubmit="return false;" id="subcontractsaleorderm_Form_#(pageId)" action="#(action)" method="post">
                        
                        #if(subcontractsaleorderm.iAutoId??)
                        <input type="hidden" name="subcontractsaleorderm.iAutoId" id="subsaleiautoid" value="#(subcontractsaleorderm.iAutoId??)"/>
                        #end
                        
                        <input type="hidden" name="subcontractsaleorderm.iOrderStatus" value="#(subcontractsaleorderm.iOrderStatus??1)"/>
                        <input type="hidden" name="subcontractsaleorderm.iAuditStatus" value="#(subcontractsaleorderm.iAuditStatus??0)"/>
                        <input type="hidden" name="subcontractsaleorderm.isDeleted" value="#(subcontractsaleorderm.isDeleted??0)"/>
                        <input type="hidden" name="subcontractsaleorderm.dOrderDate" value="#datetime(subcontractsaleorderm.dOrderDate??DateUtil.getNow(),'yyyy-MM-dd')"/>
                        
						<div class="form-group row">
							<label class="col-sm-1 col-form-label">订单号</label>
							<div class="col">
								<input type="text" data-rule="required" data-notnull="true" data-tips="请输入订单号" data-with-clearbtn="true" autocomplete="off" class="form-control" placeholder="请输入订单号" maxlength="40" name="subcontractsaleorderm.cOrderNo" value="#(subcontractsaleorderm.cOrderNo??)"/>	
							</div>	
							<label class="col-sm-1 col-form-label">订单日期</label>
							<div class="col">
	                            <input type="text"
	                                   data-rule="required"
	                                   data-date
	                                   autocomplete="off"
	                                   class="form-control"
	                                   disabled
	                                   maxlength="20"
	                                   value="#datetime(subcontractsaleorderm.dOrderDate??DateUtil.getNow(),'yyyy-MM-dd')"/>								
							</div>
							<label class="col-sm-1 col-form-label">业务类型</label>
							<div class="col">
								<select class="form-control"
										name="subcontractsaleorderm.iBusType"
										data-autoload
										data-url="admin/dictionary/options?key=order_business_type"
										data-value-attr="sn"
										data-text-attr="name"
										data-text="=请选择业务类型="
										data-select="#(subcontractsaleorderm.iBusType??)">
								</select>								
							</div>
							<label class="col-sm-1 col-form-label">销售类型</label>
							<div class="col">
								<select class="form-control"
										name="subcontractsaleorderm.iSaleTypeId"
										data-autoload
										data-url="/admin/saletype/selectData"
										data-value-attr="iautoid"
										data-text-attr="cstname"
										data-text="=请选择="				
										data-select="#(subcontractsaleorderm.iSaleTypeId??)">
								</select>								
							</div>	
						</div>
						<div class="form-group row">
                            <input type="hidden" name="subcontractsaleorderm.icustomerid" value="#(subcontractsaleorderm.icustomerid??)" id="icustomerid" data-sync-attr="iautoid"/>
                            <label class="col-sm-1 col-form-label">客户名称</label>
                            <div class="col">
                                <div class="input-group">
                                    <div class="ac_input_box">
                                        <input type="text" class="form-control"
                                               data-autocomplete
                                               id="ccusname"
                                               data-url="admin/customer/autocomplete"
                                               data-rule="required"
                                               data-sync-ele="#icustomerid"
                                               data-text-attr="ccusname"
                                               data-value-attr="iautoid"
                                               data-column-attr="ccuscode,ccusname"
                                               placeholder="请选择"
                                               data-tips="请选择"
                                               data-header="客户编码,客户名称"
                                               maxlength="40"
                                               value="#(subcontractsaleorderm.ccusname??)">
                                    </div>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" data-dialogbtn
                                                data-link-para-ele="#icustomerid" data-area="1280,600"
                                                data-title="选择数据（单选）"
                                                data-url="admin/annualorderm/ccusname_dialog_index"><i
                                                class="fa fa-search"></i></button>
                                    </div>
                                </div>
                            </div>
							<label class="col-sm-1 col-form-label">付款条件</label>
							<div class="col">
								<input type="text" data-with-clearbtn="true" autocomplete="off"  class="form-control" placeholder="请输入付款条件" maxlength="100" name="subcontractsaleorderm.cPaymentTerm" value="#(subcontractsaleorderm.cPaymentTerm??)"/>
							</div>
							<label class="col-sm-1 col-form-label">销售部门</label>
							<div class="col">
								<select class="form-control" name="subcontractsaleorderm.iDepartmentId"
									data-autoload
									data-with-clearbtn="true"
									data-select-type="select2"
									data-tips="请选择"
									data-url="admin/dept/enableOptions"
									data-text="=请选择="
									data-text-attr="name"
									data-value-attr="id"
									data-width="218"
									data-select="#(subcontractsaleorderm.iDepartmentId??)">
								</select>									
							</div>		
							<label class="col-sm-1 col-form-label">业务员</label>
							<div class="col">
                                <input type="hidden" id="ipersonid_#(pageId)" name="subcontractsaleorderm.ibuspersonid" value="#(subcontractsaleorderm.ibuspersonid??)"/>
                                <input type="text" autocomplete="off"
                                       class="form-control"
                                       placeholder="==请选择人员=="
                                       data-jboltinput
                                       data-width="600"
                                       data-height="450"
                                       data-rule="required"
                                       data-refresh="true"
                                       data-hidden-input="ipersonid_#(pageId)"
                                       data-load-type="ajaxportal"
                                       data-url="admin/workregionm/personTable"
                                       value="#(subcontractsaleorderm.cpsnname??)"
                                />
							</div>
						</div>
						<div class="form-group row">
							<label class="col-sm-1 col-form-label">税率</label>
							<div class="col">
								<input type="text" data-with-clearbtn="true" data-rule="pnumber;fix<=#(precisionConfig5)" data-notnull="false" autocomplete="off"  class="form-control" placeholder="请输入税率" maxlength="6" name="subcontractsaleorderm.iTaxRate" value="#(subcontractsaleorderm.iTaxRate??)"/>
							</div>	
							<label class="col-sm-1 col-form-label">币种</label>
							<div class="col">
								<select class="form-control"
										name="subcontractsaleorderm.cCurrency"
										data-autoload
										data-url="admin/dictionary/options?key=cCurrency"
										data-value-attr="sn"
										data-text-attr="name"
										data-text="=请选择="				
										data-select="#(subcontractsaleorderm.cCurrency??)">
								</select>									
							</div>
							<label class="col-sm-1 col-form-label">汇率</label>
							<div class="col">
								<input type="text" data-with-clearbtn="true" data-rule="pnumber;fix<=#(precisionConfig4)" data-notnull="false" autocomplete="off"  class="form-control" placeholder="请输入汇率" maxlength="10" name="subcontractsaleorderm.iExchangeRate" value="#(subcontractsaleorderm.iExchangeRate??)"/>
							</div>		
							<label class="col-sm-1 col-form-label">备注</label>
							<div class="col">
								<input type="text" data-with-clearbtn="true" autocomplete="off"  class="form-control" placeholder="请输入备注" maxlength="200" name="subcontractsaleorderm.cMemo" value="#(subcontractsaleorderm.cMemo??)"/>		
							</div>							
						</div>
						<div class="form-group row">
							<label class="col-sm-1 col-form-label">年份</label>
							<div class="col-2">
	                            <input type="text"
	                                   data-rule="required"
	                                   data-date
	                                   data-type="year"
	                                   data-fmt="yyyy"
	                                   autocomplete="off"
	                                   class="form-control"
	                                   maxlength="20"
	                                   name="subcontractsaleorderm.iYear"
	                                   value="#datetime(subcontractsaleorderm.iYear??DateUtil.getNow(),'yyyy')"/>										  	
							</div>	
							<label class="col-sm-1 col-form-label">月份</label>
							<div class="col-2">
                                <select class="form-control"
                                        data-autoload
                                        name="subcontractsaleorderm.iMonth"
                                        data-select="#datetime(subcontractsaleorderm.iMonth??DateUtil.getNow(),'M')">
                                    <option value="">=月份=</option>
                                    <option value="1">1月</option>
                                    <option value="2">2月</option>
                                    <option value="3">3月</option>
                                    <option value="4">4月</option>
                                    <option value="5">5月</option>
                                    <option value="6">6月</option>
                                    <option value="7">7月</option>
                                    <option value="8">8月</option>
                                    <option value="9">9月</option>
                                    <option value="10">10月</option>
                                    <option value="11">11月</option>
                                    <option value="12">12月</option>
                                </select>
                            </div>
						</div>															            
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

### 新增之后，并且为审核流
#if(subcontractsaleorderm.iautoid?? && subcontractsaleorderm.iauditway == 2 && subcontractsaleorderm.iauditstatus > 0)
#include("/_view/admin/approvalm/form_approval_flow.html", formAutoId=subcontractsaleorderm.iAutoId, primaryKeyName="iAutoId", formSn="Co_SubcontractSaleOrderM", btnNeed=1, pId=pageId, className="cn.rjtech.admin.subcontractsaleorderm.SubcontractsaleordermService", o=subcontractsaleorderm)
#end

<div class="jbolt_page_content">
    <script type="text/template" id="jboltTable_demotpl_#(pageId)">
        {@each datas as data,index}
        <tr data-id="${data.iautoid}" class="${data.iinventoryid?'':'table-danger'}" {@if data.error} tooltip title='${data.error}' {@/if}>
            <td>${pageNumber,pageSize,index | rownum}</td>
            <td>
                #if(readonly != 'readonly')
                <a onclick="jboltTableRemoveRow(this)" tooltip data-title="移除行" data-handler="removeTr" data-confirm="确定删除此数据？" class="btn btn-danger bat-sm">移除行</a>
                #end
            </td>
            <td>${data.cinvcode}</td>
            <td>${data.cinvcode1}</td>
            <td>${data.cinvname1}</td>
            <td>${data.cinvstd}</td>
            <td>${data.cuomname}</td>
            <td>${data.iqty1|tofixed_2}</td>
            <td>${data.iqty2|tofixed_2}</td>
            <td>${data.iqty3|tofixed_2}</td>
            <td>${data.iqty4|tofixed_2}</td>
            <td>${data.iqty5|tofixed_2}</td>
            <td>${data.iqty6|tofixed_2}</td>
            <td>${data.iqty7|tofixed_2}</td>
            <td>${data.iqty8|tofixed_2}</td>
            <td>${data.iqty9|tofixed_2}</td>
            <td>${data.iqty10|tofixed_2}</td>
            <td>${data.iqty11|tofixed_2}</td>
            <td>${data.iqty12|tofixed_2}</td>
            <td>${data.iqty13|tofixed_2}</td>
            <td>${data.iqty14|tofixed_2}</td>
            <td>${data.iqty15|tofixed_2}</td>
            <td>${data.iqty16|tofixed_2}</td>
            <td>${data.iqty17|tofixed_2}</td>
            <td>${data.iqty18|tofixed_2}</td>
            <td>${data.iqty19|tofixed_2}</td>
            <td>${data.iqty20|tofixed_2}</td>
            <td>${data.iqty21|tofixed_2}</td>
            <td>${data.iqty22|tofixed_2}</td>
            <td>${data.iqty23|tofixed_2}</td>
            <td>${data.iqty24|tofixed_2}</td>
            <td>${data.iqty25|tofixed_2}</td>
            <td>${data.iqty26|tofixed_2}</td>
            <td>${data.iqty27|tofixed_2}</td>
            <td>${data.iqty28|tofixed_2}</td>
            <td>${data.iqty29|tofixed_2}</td>
            <td>${data.iqty30|tofixed_2}</td>
            <td>${data.iqty31|tofixed_2}</td>
            <td>${data.isum|tofixed_2}</td>
        </tr>
        {@/each}
    </script>
    
    <div class="jbolt_table_toolbar" id="subcontractsaleorderm_toolbar_#(pageId)">
        #if(readonly != 'readonly')
        <div class="btn-group btn-group-sm" role="group" aria-label="btn-group">
            <button onclick="jboltTableAppendEmptyRow(this)" class="btn btn-primary btn-sm">添加行</button>

            <button onclick="jboltTableRemoveCheckedRow(this, true, false)"
                    data-confirm="确定删除选中数据？" class="btn btn-danger btn-sm" >
                <i class="fa fa-trash"></i> 删除行</button>
            <button onclick="checkDetails(this)" class="btn btn-secondary btn-sm">检查明细</button>
            <button onclick="saveData(this)" class="btn btn-secondary btn-sm" hidden id="save_btn_#(pageId)"></button>
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="importMenuButton"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> 数据导入
            </button>
            <div class="dropdown-menu" aria-labelledby="importMenuButton">
                <a data-downloadbtn href="/admin/subcontractsaleorderm/downloadTpl" class="btn dropdown-item"><i
                        class="fa fa-file-excel-o"></i>&nbsp;&nbsp;模板下载</a>
                <div class="j_upload_file_box"
                     data-name="file"
                     data-btn-class="btn dropdown-item"
                     data-placeholder="上传导入"
                     data-form="subcontractsaleorderm_Form_#(pageId)"
                     data-confirm="确认导入数据？"
                     data-accept="excel"
                     data-maxsize="20480"
                     data-handler="uploadFile"
                     data-upload-success-handler="uploadHandler"
                     data-url="/admin/dataimport/importExcelData">
                </div>
            </div>
        </div>
        #end
    </div>
    
    <table class="jbolt_table thead_font_normal table-bordered table-center"
           data-jbolttable
           #if(subcontractsaleorderm.iAutoId??)
           data-ajax="true"
           data-url="admin/subcontractsaleorderd/findEditTableDatas?isubcontractsaleordermid=#(subcontractsaleorderm.iAutoId??)"
           #end
           id="jbolt_Table_#(pageId)"
           data-column-resize="true"
           data-tfoot-fixed="true"
           data-column-prepend="1:checkbox"
           data-rowtpl="jboltTable_demotpl_#(pageId)"
           data-toolbar="subcontractsaleorderm_toolbar_#(pageId)"
           data-editable="true"
           data-height="500"
           ###data-fixed-columns-right="-1"
           data-editable-option="getEditableTableOptions_#(pageId)">
        <thead>
        <tr>
            <th data-width="60" data-column="index">序号</th>
            <th data-width="100">操作</th>
            <th data-width="150" data-column="cinvcode">存货编码</th>
            <th data-width="150" data-column="cinvcode1">客户部番</th>
            <th data-width="150" data-column="cinvname1">部品名称</th>
            <th data-width="150" data-column="cinvstd">规格</th>
            <th data-width="100" data-column="cuomname">库存主单位</th>
            <th data-column="iqty1">1日</th>
            <th data-column="iqty2">2日</th>
            <th data-column="iqty3">3日</th>
            <th data-column="iqty4">4日</th>
            <th data-column="iqty5">5日</th>
            <th data-column="iqty6">6日</th>
            <th data-column="iqty7">7日</th>
            <th data-column="iqty8">8日</th>
            <th data-column="iqty9">9日</th>
            <th data-column="iqty10">10日</th>
            <th data-column="iqty11">11日</th>
            <th data-column="iqty12">12日</th>
            <th data-column="iqty13">13日</th>
            <th data-column="iqty14">14日</th>
            <th data-column="iqty15">15日</th>
            <th data-column="iqty16">16日</th>
            <th data-column="iqty17">17日</th>
            <th data-column="iqty18">18日</th>
            <th data-column="iqty19">19日</th>
            <th data-column="iqty20">20日</th>
            <th data-column="iqty21">21日</th>
            <th data-column="iqty22">22日</th>
            <th data-column="iqty23">23日</th>
            <th data-column="iqty24">24日</th>
            <th data-column="iqty25">25日</th>
            <th data-column="iqty26">26日</th>
            <th data-column="iqty27">27日</th>
            <th data-column="iqty28">28日</th>
            <th data-column="iqty29">29日</th>
            <th data-column="iqty30">30日</th>
            <th data-column="iqty31">31日</th>
            <th data-column="isum">合计</th>
        </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
        <tr>
            <th></th>
            <th>合计</th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        <tr>
        </tfoot>
    </table>
</div>
#define js()
<script>
    hideParentLayerDialogBtn(0);
    hideParentLayerDialogBtn(1);

    // 保存方法
    function submitThisForm()
    {
        // 调用保存处理
        $('#save_btn_#(pageId)').click();
    }

    // 保存是否提审处理，默认为false, 在点击提审时，修改此变量值
    var submit = false;
    function submitThisForm_#(pageId)(s) {
        // 保存并提交
        if (s) {
            submit = s;
        }
        // 调用保存处理
        $('#save_btn_#(pageId)').click();
    }

    function submitApproveSubSale() {
        let result = $('#save_btn_#(pageId)').click();
        if (result){
            let subsaleiautoid = $("#subsaleiautoid").val();
            let url = "admin/subcontractsaleorderm/approve?id="+subsaleiautoid;
            Ajax.get(url,function(res){
                LayerMsgBox.success("审批成功!");
            });
        }
    }

    /**
     * 新增/修改/提审
     */
    function successHandler(msg, iautoid) {
        LayerMsgBox.success(msg, 600, function () {
            // 新增/修改，均跳转到详情页
            location.href = '/admin/subcontractsaleorderm/edit?iautoid=' + iautoid + '&_jb_rqtype_=dialog';
            parent.refreshPjaxContainer();
        });
    }

    //获得配置参数
    function getEditableTableOptions_#(pageId)() {
        var editableTableOptions = {
            submit: {
                withForm: ["subcontractsaleorderm_Form_#(pageId)"],
                name: 'subcontractsaleordermForm',
                type: "all",
                url: "/admin/subcontractsaleorderm/submitAll",
                success: function (res) {
                    // 表格保存之后，判断是否需要提审处理
                    if (res.state === 'ok') {
                        // 提交审核（审批）调用
                        if (submit) {
                            // 提审
                            submit_#(pageId)(res.data.iautoid, function (data) {

                                successHandler('提审成功', res.data.iautoid);
                            });
                        } else {
                            successHandler(res.msg, res.data.iautoid);
                        }
                    } else {
                        LayerMsgBox.alert(res.msg, 2);
                    }
                }
            },
            maxRowCount: 9999,
            cols: {
                iautoid: {
                    submitAttr: "iautoid",
                },
                cinvcode: {
                    required:true,
                    type:"dialogbtn",
                    placeholder:"选择存货",
                    maxLength:100,
                    dialog:{
                        url:"admin/manualorderm/inventory_dialog_index",
                        area:"80%,80%",
                        title:"选择存货",
                        btn:"选择,关闭"
                    },
                    columnAttr:"iinventoryid,cinvcode1,cinvname1,cinvstd,cuomname",
                    changeColumns: [
                        {column:"cuomname",use:"cuomname"},
                        {column:"cinvstd",use:"cinvstd"},
                        {column:"cinvname1",use:"cinvname1"},
                        {column:"cinvcode1",use:"cinvcode1"},
                        {column:"iinventoryid",use:"iautoid"},
                    ]
                },
                iqty1: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty2: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty3: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty4: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty5: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty6: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty7: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty8: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty9: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty10: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty11: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty12: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty13: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty14: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty15: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty16: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty17: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty18: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty19: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty20: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty21: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty22: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty23: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty24: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty25: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty26: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty27: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty28: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty29: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty30: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                iqty31: {
                    type: "amount",
                    placeholder: '数量',
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                },
                isum: {
                    summary: [{
                        dir: "h",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "iqty1+iqty2+iqty3+iqty4+iqty5+iqty6+iqty7+iqty8+iqty9+iqty10+iqty11+iqty12+iqty13+iqty14+iqty15+iqty16+iqty17+iqty18+iqty19+iqty20+iqty21+iqty22+iqty23+iqty24+iqty25+iqty26+iqty27+iqty28+iqty29+iqty30+iqty31"
                    }],
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }]
                }
            }
        };
        return editableTableOptions;
    }

    /**
     * 检查明细
     */
    function checkDetails(ele) {
        var rowDatas = jboltTableGetAllDatas(ele);

        if (rowDatas && rowDatas.length > 0) {
            $.each(rowDatas, function (idx, row) {

                if (row.iinventoryid) {
                    removeClass(idx);
                }
            });
        } else {
            LayerMsgBox.alert('请维护导入数据!', 2);
        }
    }

    function removeClass(idx) {
        var $tr = $('tr[data-index="' + idx + '"]');
        $tr.removeAttr('tooltip');
        $tr.removeAttr('title');
        $tr.removeClass('table-danger');
    }

    /**
     * 保存清空错误数据
     * @param ele
     */
    function saveData(ele) {
        var rowDatas = jboltTableGetAllDatas(ele);
        removeEmptyRow(ele, rowDatas);
        jboltTableSubmit(ele);
    }

    function removeEmptyRow(ele, datas) {
        var count = 0;
        $.each(datas, function (idx, row) {
            if (!row.iiventoryid) {
                count++;
            }
        });

        for (var i = 0; i < count; i++) {
            delRow(ele);
        }
    }

    function delRow(ele) {
        var datas = jboltTableGetAllDatas(ele);
        if (datas && datas.length > 0) {
            var jboltTable = getJBoltTable(ele)
            var table = getJBoltTableInst(jboltTable);

            for (var i = 0; i < datas.length; i++) {
                var data = datas[i];
                if (!data.iinventoryid) {
                    table.me.removeRow(table, i);
                    break;
                }
            }
            return true;
        }
        return false;
    }

    function uploadHandler(uploader, type, fileInput, res) {
        jboltTableClear("#jbolt_Table_#(pageId)");

        var data = res.data;
        if (!data || data.length === 0) {
            LayerMsgBox.alert('导入数据不能为空', 2);
            return;
        }

        var arr = [];

        $.each(data, function (idx, row) {
            if (row.cinvcode1) {
                arr.push(row.cinvcode1);
            }
        });

        var para = {
            cinvcode1: arr.join(',')
        };

        var index = LayerMsgBox.loading('正在匹配存货信息...', 10000);

        Ajax.post('admin/inventory/fetchByCinvcode1s', para, function (ret) {

            LayerMsgBox.close(index);

            if (ret.state === 'ok') {

                // 导入行数据
                $.each(data, function (idx, r) {

                    // 存货数据
                    $.each(ret.data, function (idx, row) {

                        if (r.cinvcode1 === row.cinvcode1) {
                            if (row.cnt === 0) {
                                r.error = '部品番号不存在！';
                            } else if (row.cnt === 1) {
                                r.iinventoryid = row.iautoid;
                                r.cinvcode = row.cinvcode;
                                r.cinvcode1 = row.cinvaddcode;
                                r.cinvname1 = row.cinvname1;
                                r.cinvstd = row.cinvstd;
                            } else {
                                r.error = '存在' + row.cnt + '条匹配的存货记录，请手工选择存货！';
                            }
                        }

                    });

                    if (!r.error) {
                        if (r.cinvcode1 && !r.iinventoryid) {
                            r.error = '部品番号缺少对应存货！';
                        }
                    }

                    // 数量精度处理
                    $.each(r, function (key, val) {
                        if (key.startsWith('iqty')) {
                            var iqty = parseFloat(val);
                            iqty = parseFloat(iqty);
                            r[key] = iqty.toFixed(0);
                        }
                    });

                });

                jboltTableInsertRow('#jbolt_Table_#(pageId)', data);
            } else {
                LayerMsgBox.alert(ret.msg, 2);
            }
        }, function () {
            LayerMsgBox.close(index);
        });
    }

    function setChooseDialogSelectResult(data){
        $('#icustomerid').val(data.ccusname);
    }

    // 选择客户名称
    function instCcusname(data)
    {
        $("#icustomerid").val(data.iautoid);
        $("#ccusname").val(data.ccusname);
    }
</script>
#end

