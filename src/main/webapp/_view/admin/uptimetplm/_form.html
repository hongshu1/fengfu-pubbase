<form onsubmit="return false;" id="UptimeTplM_Form" action="#(action)" method="post">
    #if(uptimeTplM.iautoid??)
    <input type="hidden" name="uptimeTplM.iAutoId" value="#(uptimeTplM.iautoid??)"/>
    #end
    <input type="hidden" id="uptimetplcategorydatas" name="uptimetplcategorydatas" value=""/>
    <input type="hidden" id="uptimetpltabledatas" name="uptimetpltabledatas" value=""/>
    <div class="row">
        <div class="col">
            <div class="form-group row">
                <label class="col-sm-1 col-form-label">产线名称:</label>
                <div class="col-2">
                    <select class="form-control"
                            data-autoload
                            data-url="admin/workregionm/options"
                            data-select-type="select"
                            name="uptimeTplM.iWorkRegionMid"
                            data-refresh="true"
                            data-rule="select"
                            data-notnull="true"
                            data-tips="请选择产线名称"
                            data-text="=请选择="
                            data-value-attr="iautoid"
                            data-text-attr="cworkname"
                            data-select="#(uptimeTplM.iworkregionmid??)"
                    ></select>
                </div>
                <label class="col-sm-1 col-form-label">班次名称:</label>
                <div class="col-2">
                    <select class="form-control"
                            data-autoload
                            data-url="admin/workshiftm/getSelect"
                            data-select-type="select"
                            name="uptimeTplM.iWorkShiftMid"
                            data-refresh="true"
                            data-rule="select"
                            data-notnull="true"
                            data-tips="请选择班次"
                            data-text="=请选择="
                            data-value=""
                            data-value-attr="iautoid"
                            data-text-attr="cworkshiftname"
                            data-select="#(uptimeTplM.iworkshiftmid??)"
                    ></select>
                </div>
                <label class="col-sm-1 col-form-label">是否启用:</label>
                <div class="col-2">
                    <div class="radio radio-primary"
                         data-radio
                         data-name="uptimeTplM.isEnabled"
                         data-value-attr="sn"
                         data-default="options_first"
                         data-url="admin/dictionary/options?key=options_enable"
                         data-width="col-sm-2,col-10"
                         data-select="#(uptimeTplM.isenabled??)"
                         data-notnull="true"
                         data-inline="true">
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-1 col-form-label">基本稼动时间(分钟):</label>
                <div class="col-2">
                    <input type="text" data-notnull="true" data-rule="required" data-tips="请输入基本稼动时间"
                           data-with-clearbtn="true"
                           autocomplete="off" class="form-control" placeholder="请输入基本稼动时间" maxlength="40"
                           name="uptimeTplM.iBaseMins"
                           value="#(uptimeTplM.ibasemins??)"/>
                </div>
                <label class="col-sm-1 col-form-label">不稼动时间(分钟):</label>
                <div class="col-2">
                    <input type="text" data-notnull="true" data-rule="required" data-tips="请输入不稼动时间"
                           data-with-clearbtn="true"
                           autocomplete="off" class="form-control" placeholder="请输入不稼动时间" maxlength="40"
                           name="uptimeTplM.iStopMins"
                           value="#(uptimeTplM.istopmins??)"/>
                </div>
                <label class="col-sm-1 col-form-label">机种切换时间(分钟):</label>
                <div class="col-2">
                    <input type="text" data-notnull="true" data-rule="required" data-tips="请输入机种切换时间"
                           data-with-clearbtn="true"
                           autocomplete="off" class="form-control" placeholder="请输入机种切换时间" maxlength="40"
                           name="uptimeTplM.iSwitchMins"
                           value="#(uptimeTplM.iswitchmins??)"/>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-1 col-form-label">加班时间(分钟):</label>
                <div class="col-2">
                    <input type="text" data-notnull="true" data-tips="请输入加班时间"
                           data-with-clearbtn="true"
                           autocomplete="off" class="form-control" placeholder="请输入加班时间" maxlength="40"
                           name="uptimeTplM.iOtMins"
                           value="#(uptimeTplM.iotmins??)"/>
                </div>
                <label class="col-sm-1 col-form-label">工作时间(分钟):</label>
                <div class="col-2">
                    <input type="text" data-notnull="true" data-tips="请输入工作时间"
                           data-with-clearbtn="true"
                           autocomplete="off" class="form-control" placeholder="请输入工作时间" maxlength="40"
                           name="uptimeTplM.iWorkMins"
                           value="#(uptimeTplM.iworkmins??)"/>
                </div>
            </div>
        </div>
    </div>
</form>
<form onsubmit="return false;">
    <div class="row">
        <div class="col">
            <div class="form-group row">
                <label class="col-sm-1 col-form-label">不稼动时间列表</label>
                <div class="col-10">
                    <div class="jbolttable_master_slave_box">
                        <div class="card">
                                <div class="card-header py-2">
                                    <div class="row">
                                        <div class="col pt-2"><label>表格分类</label></div>
                                        <div class="col-md-auto">
                                            <form></form>
                                        </div>
                                    </div>
                                    <div class="card-body overflow-auto" style="height: 300px;">
                                        #include("UptimeTplCategory.html")
                                    </div>
                                </div>
                            </div>
                        <div class="card">
                                <div class="card-header py-2">
                                    <div class="row">
                                        <div class="col pt-2"><label>表格内容</label></div>
                                        <div class="col-md-auto">
                                            <form></form>
                                        </div>
                                    </div>
                                    <div class="card-body overflow-auto" style="height: 300px;">
                                        #include("UptimeTplTable.html")
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
</form>
#define js()
<script>
    // 表格分类可编辑
    function jbolt_table_edittable_#(pageId)()
    {
        var editableTableOptions = {
            submit: {
                withForm: ["UptimeTplM_Form"],
                type: "all",
                name:"Tpls",
                url: "/admin/uptimeTplM/submitAll",
                success: function (res, table, td) {
                    if (res.state === 'ok') {
                        LayerMsgBox.success(res.msg, 1000, function () {
                            parent.LayerMsgBox.closeAll();
                            parent.refreshPjaxContainer();
                        });
                    } else {
                        LayerMsgBox.alert(res.msg, 2);
                    }
                }
            },
            cols: {
                index: {
                    submitAttr: "iseq",
                },
                imins:{
                    type:"amount",
                    placeholder: '分钟',
                    required: true,
                    handler: function (table, td, text, value, jsonData) {
                        editTplDatas();
                    }
                }
            }
        };
        return editableTableOptions;
    }

    // 表格内容可编辑
    function instDatas(datas) {
        // 插入表格分类
        jboltTableInsertRow("jbolt_table_uptime_tpl_category", datas);
        $("#uptimetplcategorydatas").val(JSON.stringify(datas));

        var iUptimeCategoryIds = [];
        for (let i in datas) {
            iUptimeCategoryIds.push(datas[i].iautoid);
        }

        Ajax.get("admin/uptimeCategory/uptimeTplTableDatas?iuptimecategoryids=" + iUptimeCategoryIds, function (res) {
            if (res.data) {
                jboltTableInsertRow("jbolt_table_uptimetpltable_split", res.data);
                $("#uptimetpltabledatas").val(JSON.stringify(res.data));
            }
        });

        editTplDatas();
    }

    // 封装表格数据
    function editTplDatas() {
        var categoryDatas = getJboltTableAllDatas("jbolt_table_uptime_tpl_category");
        // 过滤分类名称为空的数据
        $("#uptimetplcategorydatas").val(JSON.stringify(categoryDatas));
        var tableDatas = getJboltTableAllDatas("jbolt_table_uptimetpltable_split");
        $("#uptimetpltabledatas").val(JSON.stringify(tableDatas));
    }

    // 获取不需要新增数据
    function getNotIuptimecategoryids() {
        var datas = getJboltTableAllDatas("jbolt_table_uptime_tpl_category");
        var notIuptimecategoryids = [];
        if (datas) {
            for (let i in datas) {
                notIuptimecategoryids.push(datas[i].iautoid);
            }
            return notIuptimecategoryids
        }
        return notIuptimecategoryids;
    }

    function removeTplTable(iuptimecategoryid) {
        updateTable("jbolt_table_uptimetpltable_split", iuptimecategoryid, "iuptimecategoryid");
    }

    // 修改表格数据
    function updateTable(tableId, iuptimecategoryid, attrName) {
        var datas = getJboltTableAllDatas(tableId);
        var newDats = [];
        if (datas) {
            for (let i in datas) {
                var tpliuptimecategoryid = datas[i][attrName];
                if (iuptimecategoryid != tpliuptimecategoryid) {
                    newDats.push(datas[i]);
                }
            }
        }

        jboltTableClear(tableId);
        if (newDats.length > 0) {
            jboltTableInsertRow(tableId, newDats);
        }

        editTplDatas();
    }

    // 删除表格内容校验是否删除表格分类
    function checkOrUpdateTplCategory(iuptimecategoryid) {
        var tableDatas = getJboltTableAllDatas("jbolt_table_uptimetpltable_split");
        var deleteLogo = false;
        if (!tableDatas) {
            deleteLogo = true;
        } else {
            for (let i in tableDatas) {
                // 还存在相关分类数据
                if (iuptimecategoryid == tableDatas[i].iuptimecategoryid) {
                    deleteLogo = false;
                    return;
                }
            }
            deleteLogo = true
        }

        if (deleteLogo) {
            updateTable("jbolt_table_uptime_tpl_category", iuptimecategoryid, "iautoid");
        }
    }
</script>
#include("/_view/_admin/common/_formjs.html",formId="UptimeTplM_Form")
#end
