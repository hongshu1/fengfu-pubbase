#@jboltLayout()
#define main()
<div class="jbolt_page">
  <div class="jbolt_page_content">
    <form onsubmit="return false;" id="rcvdocqcformmform_#(pageId)" data-pjaxsubmit action="#(action)" method="post">
      #if(record.iautoid??)
      <input type="hidden" name="record.iautoid" value="#(record.iautoid??)"/>
      #end
      <div>
        <div style="font-size: 20px;vertical-align: sub;text-align: center;">检查成绩表</div>
        <table id="jbolt_table_checkouttableparam_split__#(pageId)1" border="1"
               style="text-align: center;left: 60px;margin-left:50px;width: 1300px;">

          <tr height="28" style="mso-height-source:userset;height:21pt" id="r0">
            <td height="26" class="x74" width="117" style="height:19.5pt;width:87.75pt;">机型</td>
            <td class="x71" width="260" style="width:195pt;">#(record.cequipmentname??)</td>
            <td colspan="4" class="x72" width="514" style="border-right:1px solid windowtext;border-bottom:1px solid windowtext;">
              测定目的
            </td>
          </tr>
          <tr height="28" style="mso-height-source:userset;height:21pt" id="r1">
            <td height="26" class="x74" style="height:19.5pt;">客户部番</td>
            <td>#(record.cinvcode1??)</td>
            <td colspan="4" rowspan="2" height="54" class="x74"
                style="border-right:1px solid windowtext;border-bottom:1px solid windowtext;height:40.5pt;">
              <div class="form-group row  col-8"
                   id="cMeaSurePurpose"
                   data-checkbox
                   data-rule="checkbox"
                   data-default=""
                   data-url="admin/dictionary/options?key=cmeasurepurpose"
                   data-value-attr="sn"
                   data-text-attr="cmeasurepurpose"
                   data-inline="true"
                   data-value="#(record.cmeasurepurpose??)"
                   data-name="cmeasurepurpose">
              </div>
            </td>
          </tr>
          <tr height="28" style="mso-height-source:userset;height:21pt" id="r2">
            <td height="26" class="x74" style="height:19.5pt;">部品名称</td>
            <td>#(record.cinvname1??)</td><!--class="x71"-->
          </tr>
          <tr height="28" style="mso-height-source:userset;height:21pt" id="r5">
            <td>批次号</td>
            <td>#(record.cbatchno??)</td>
            <td class="x74" width="100px">批次大小</td>
            <td width="250">#(record.cbatchno??)</td>
            <td class="x74" width="100px">检测日期</td>
            <td width="250">#(record.dupdatetime??)</td>
          </tr>
          <tr height="28" style="mso-height-source:userset;height:21pt" id="r4">
            <td height="26" class="x74" style="height:19.5pt;">测定理由</td>
            <td colspan="3">
              <input id="cMeaSureReason" type="text" autocomplete="off" placeholder="=请输入测定理由=" name="cmeasurereason"
                     value="#(record.cmeasurereason??)" maxlength="355" data-rule="required" style="width: 630px"/>
            </td>
            <td class="x74">设变号</td>
            <td class="x71" width="250">
              #(record.cdcno??)
            </td>
          </tr>
          <tr height="300px">
            <td colspan="6">
              <div class="col">
                <div class="py-2" style="padding:.5rem 0rem;">
                </div>

                <input type="hidden" id="recordImages" placeholder="=测试==" name="recordImages"
                       value="#(record.imgList??)" class="form-control"/>

                <div class="form-group row">
                  <label class="col-form-label col-sm-2 text-left">检验图片：</label>
                  <input name="cpics" id="cpics" value="#(record.cpics??)" type="hidden"/>
                  <img data-photobtn tooltip data-title="点击查看大图"  style="width: 700px;height:450px;" src="#(record.cpics??)"
                       onerror="this.src='assets/img/noimg.png'"/>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td>测定单位</td>
            <td>
              <div class="form-group row  col-8"
                   id="cMeaSureUnit"
                   data-radio
                   data-rule="radio"
                   data-default=""
                   data-url="admin/dictionary/options?key=cmeasureunit"
                   data-value-attr="sn"
                   data-text-attr="cmeasureunit"
                   data-inline="true"
                   data-value="#(record.cmeasureunit??)"
                   data-name="cmeasureunit">
              </div>
            </td>
          </tr>
        </table>
        <table id="jbolt_table_checkouttableparam_split__#(pageId)2" border="3"
               style="text-align: center;left: 60px;margin-left:50px" width="1200" cellpadding="2">
          <div style="left: 60px;margin-left:50px;height: 50px;width: 500px;">
            <button type="button" onclick="insertRow(10)" class="btn btn-success"
                    style="background-color: #1006F1;margin-top: 11px">新增页
            </button>
          </div>
        </table>

        <!-- 检验表格项目表的的数据模板定义-->
        <textarea class="jb_tpl_box" id="checkoutType_tpl_#(pageId)">
          {@each datas as data,index}
          <tr data-id="${data.iautoid}">
            <td>${+index+1}</td>
            {@each data.paramnamelist as paramname,indextest}
            <td title="${paramname}">${paramname}</td>
            {@/each}
            {@each data.cvaluelist as value,indextest}
            <td>
              {@if data.itype == '1'}
              <input name="cA${value.name}" type="number" class="cA01" value="${value.cvalue}"
                     title="最大值：${data.imaxval}，标准值：${data.istdval}，最小值：${data.iminval}"/>
              {@else if data.itype == '2'}
              <input name="cA${value.name}" type="text" class="cA01" title="${value.coptions}" value="${value.cvalue}"/>
              {@else if data.itype == '3'}
              <select name="cA${value.name}" class="form-control cA01" data-url="admin/dictionary/options?key=overallsize"
                      data-autoload data-text="=整体尺寸=" data-value-attr="sn" value="${value.cvalue}"
                      data-select="${value.coptions}" title="=整体尺寸="></select>
              {@else if data.itype == '4'}
              <input name="cA${value.name}" type="text" class="cA01" title="${value.cvalue}"/>
              {@else if data.itype == '5'}
              <select name="appearance${value.name}" class="form-control cA01" data-url="admin/dictionary/options?key=appearance"
                      data-autoload data-text="=整体外观=" data-value-attr="sn" value="${value.cvalue}" multiple
                      data-select-type="select2" data-select="${value.cvalue}" title="=整体外观="></select>
              {@else if data.itype == '6'}
              <select name="cA${value.name}" class="form-control cA01" data-url="admin/dictionary/options?key=overallsize"
                      data-autoload data-text="=整体尺寸=" data-value-attr="sn" data-value="${value.cvalue}"
                      data-select="${value.coptions}"></select>
              {@else if data.itype == '7'}
              <input name="cA${value.name}" data-date data-type="date" data-fmt="yyyy-MM-dd" readonly="readonly" autocomplete="off"
                     class="form-control cA01" placeholder="结束日期" data-tips="结束时间" maxlength="23"
                     value="${value.cvalue}">
              {@else data.itype == '8'}
              <input name="cA${value.name}" type="text" class="form-control cA01" data-date data-type="time" data-fmt="HH:mm:ss"
                     value="${value.cvalue}">
              {@/if}
            </td>
            {@/each}
          </tr>
          {@/each}
        </textarea>

        <!--#(record.iAutoId??)-->
        <div class="card-body overflow-auto" style="left: 30px;margin-left: 30px;">
          <table id="jbolt_table_checkouttableparam_split_#(pageId)3" class="table-center jbolt_table thead_font_normal"
                 data-jbolttable
                 data-width="fill"
                 data-height="fill"
                 data-editable="true"
                 data-ajax="true"
                 data-column-resize="true"
                 data-conditions-form="rcvdocqcformmform_#(pageId)"
                 data-url="admin/rcvdocqcformm/getCheckOutTableDatas?ircvdocqcformmid=#(record.iAutoId??)"
                 data-rowtpl="checkoutType_tpl_#(pageId)"
                 data-copy-to-excel="false"
                 data-toolbar="rcvdocqcformmform_toolbar_#(pageId)">
              <thead>
                <tr class="colspan biaotoucolor">
                  <th data-column="index">序号</th>
                  #for(data:columns??)
                  <th data-width="200" data-column="#(data.iqcitemid??)">
                    #(data.cqcitemname??)
                  </th>
                  #end
                  #for(i = 1; i <= 10; i++)
                  <th style="width: 120px">#(i)</th>
                  #end
                </tr>
             </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <table id="jbolt_table_checkouttableparam_split__#(pageId)4" border="1"
               style="text-align: center;left: 60px;margin-left:50px" width="1200">
          <tr height="60" style="mso-height-source:userset;height:21pt" id="r3">
            <td height="26" class="x74" width="117" style="height:19.5pt;width:87.75pt;">备注</td>
            <td width="850px">
              <div>
                <textarea id="cMemo" class="form-control" data-auto-height="100" autocomplete="off" data-show-count
                          placeholder="=请输入备注="
                          data-tips="请输入备注" maxlength="200" name="cmemo" value="">#(record.cmemo??)</textarea>
              </div>
            </td>
            <td width="300px">
              <div class="form-group row  col-9"
                   id="isok"
                   data-radio
                   data-rule="radio"
                   data-default=""
                   data-label="判定是否合格："
                   data-url="admin/dictionary/options?key=isok"
                   data-value-attr="sn"
                   data-text-attr="isok"
                   data-inline="true"
                   data-value="#(record.isok??)"
                   data-name="isok">
              </div>
            </td>
          </tr>
        </table>
      </div>
    </form>

  </div>
</div>
#end
#define js()

<style>

  .cA01 {
    width: 78px;
  }

  .trd td {
    overflow: hidden;
    height: 100%;
    font-size: 14px;
    text-align: center;
    white-space: nowrap;
  }

  .trd td input {
    width: 100%;
    overflow: hidden;
    height: 100%;
    font-size: 14px;
    text-align: center;
  }

  .colspan {
    text-align: center;
  }

  .x71 {
    mso-style-parent: style0;
    mso-number-format: General;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    background: white;
    mso-pattern: auto;
    color: #000000;
    font-size: 12pt;
    font-weight: 700;
    font-style: normal;
    font-family: "宋体", "sans-serif";
    border-top: 1px solid windowtext;
    border-right: 1px solid windowtext;
    border-bottom: 1px solid windowtext;
    border-left: 1px solid windowtext;
    mso-diagonal-down: none;
    mso-diagonal-up: none;
    mso-protection: locked visible;
  }

  .biaotoucolor {
    background-color: #b1dfbb;
  }

  .setStyle {
    width: 100px;
  }
</style>

<script>
  /*
 * @desc：新增行
 * @param：rows:行数
 * */
  function insertRow(rows) {
    /*let jboltTableAllDatas = getJboltTableAllDatas("#jbolt_table_checkouttableparam_split_#(pageId)3");

    //添加10列到表头
    let length = jboltTableAllDatas[0].cvaluelist.length;
    for (let col = 0; col < rows; col++) {
      let newVar = length + col + 1;
      var firstLie = '<th class="setStyle">' + newVar + '</th>';
      $(".table>thead>tr").append(firstLie);
    }

    for (let i = 0; i < jboltTableAllDatas.length; i++) {
      let cvaluelist = jboltTableAllDatas[i].cvaluelist;
      let element = cvaluelist[0];
      //给cvaluelist添加10列
      let cvalueLength = cvaluelist.length;
      for (let arr = 0; arr < rows; arr++) {
        var cvalue = {
          coptions: element.coptions,
          cqcitemname: element.cqcitemname,
          cqcparamname: element.cqcparamname,
          cvalue: "",
          iautoid: "",
          iformparamid: element.iformparamid,
          ircvdocqcformmid: element.ircvdocqcformmid,
          imaxval: element.imaxval,
          iminval: element.iminval,
          iqcformid: element.iqcformid,
          iseq: element.iseq,
          istdval: element.istdval,
          isubseq: element.isubseq,
          itype: element.itype,
          lineiautoid: "",
          name: "cA" + cvalueLength + 1
        };
        //最后push到cvaluelist
        cvaluelist.push(cvalue);
      }
      jboltTableAllDatas[i].cvaluelist = cvaluelist;
    }*/

    let jboltTableAllDatas = getJboltTableAllDatas("#jbolt_table_checkouttableparam_split_#(pageId)3");

    //添加10列到表头
    let length = jboltTableAllDatas[0].cvaluelist.length;
    for (let col = 0; col < rows; col++) {
      let newVar = length + col + 1;
      var firstLie = '<th class="setStyle">' + newVar + '</th>';
      $(".table>thead>tr").append(firstLie);
    }

    for (let i = 0; i < jboltTableAllDatas.length; i++) {
      //将cvaluelist加10即可
      let cvaluelist = jboltTableAllDatas[i].cvaluelist;
      for (let arr = 1; arr <= rows; arr++) {
        let element = cvaluelist[arr];
        let cvalue = {
          cvalue: "",
          ircvdocqcformdid: element.ircvdocqcformdid,
          iseq: element.iseq,
          name: cvaluelist.length,
          iautoid:""
        }
        cvaluelist.push(cvalue);
      }
    }

    //jboltTableInsertRow
    clearJboltTable("#jbolt_table_checkouttableparam_split_#(pageId)3");
    jboltTableInsertRow("#jbolt_table_checkouttableparam_split_#(pageId)3", jboltTableAllDatas, false, false, false);
  }
</script>

<script>

  function submitThisForm() {
    //获取整个form的数据
    let serializeArray = $("#rcvdocqcformmform_#(pageId)").serializeArray();
    //过滤出只有name=cA和appearance的数据
    let filterserializeArray = serializeArray.filter((ele) => {
      return ele.name.startWith("cA") || ele.name.startWith("appearance");
    });

    //如果是多选框，让参数放在同一个cA上
    for (let ele = 0; ele < filterserializeArray.length; ele++) {
      if (filterserializeArray[ele].name.startsWith('appearance')) {
        let lastElement = filterserializeArray[ele];
        let nextElement = filterserializeArray[ele + 1];
        if (nextElement == undefined || nextElement == null) {
          continue;
        }
        if (lastElement.name == nextElement.name) {
          if (lastElement.value != '' && nextElement.value != '') {
            filterserializeArray[ele].value = lastElement.value + "," + nextElement.value;
          } else if (lastElement.value == '' && nextElement.value != '') {
            filterserializeArray[ele].value = nextElement.value;
          } else if (lastElement.value != '' && nextElement.value == '') {
            filterserializeArray[ele].value = lastElement.value;
          }
          //移除下一个同名的cA
          filterserializeArray.splice(ele + 1, 1);
          ele = ele - 1;
        }
      }
    }

    /*
    * 把二维数组filterserializeArray分成10个一维数组
    * */
    function _chunk(arr, num) {
      let j = 0,
          o = j;
      let newArray = [];
      while (j < arr.length) {
        j += num;
        newArray.push([arr.slice(o, j)]);
        o = j;
      }
      return newArray;
    }

    const allDatas = getJboltTableAllDatas("#jbolt_table_checkouttableparam_split_#(pageId)3");
    let length = allDatas[0].cvaluelist.length;
    var serializeGroupbyList = _chunk(filterserializeArray, length);

    var subMilasUrlArr = [];//存储每一行数据
    for (let i = 0; i < serializeGroupbyList.length; i++) {
      let data = allDatas[i];
      let dataCvaluelist = data.cvaluelist;
      let serializeElement = serializeGroupbyList[i];
      let elements = serializeElement[0];
      for (let num = 0; num < elements.length; num++) {
        let element = elements[num];
        let dataCvalue = dataCvaluelist[num];
        dataCvalue.cvalue = element.value;
      }
      /*var tableData = {
        coptions: data.coptions,
        cqcformparamids: data.cqcformparamids,
        cqcitemname: data.cqcitemname,
        cqcparamname: data.cqcparamname,
        iautoid: data.iautoid,
        iformparamid: data.iformparamid,
        imaxval: data.imaxval,
        iminval: data.iminval,
        iqcformid: data.iqcformid,
        ircvdocqcformmid: data.ircvdocqcformmid,
        iseq: data.iseq,
        istdval: data.istdval,
        isubseq: data.isubseq,
        itype: data.itype,
        cvaluelist:data.cvaluelist,
        serializeElement: serializeElement
      };
      subMilasUrlArr.push(tableData);
      */
    }

    //测试目的
    var cmeasurepurpose = "";
    let cmeasurereasonList = serializeArray.filter((ele) => {
      return ele.name == 'cmeasurepurpose';
    });
    for (let purpose = 0; purpose < cmeasurereasonList.length; purpose++) {
      cmeasurepurpose += cmeasurereasonList[purpose].value + ",";
    }
    let cmeasurepurpose2 = cmeasurepurpose.substring(0, cmeasurepurpose.lastIndexOf(','));

    //测定理由
    var cmeasurereason = $("#cMeaSureReason").val();
    var cmeasureunit = $('input[name="cmeasureunit"]').filter(':checked').val();//测定单位
    var isok = $('input[name="isok"]').filter(':checked').val();//是否合格
    var cmemo = $("#cMemo").val(); //备注
    var cdcno = $("#cDcNo").val(); //设变号
    var iautoid = $('input[name="record.iautoid"]').val();//主页面的主键
    const submitDatas = {
      // serializeSubmitList: JSON.stringify(subMilasUrlArr),
      serializeSubmitList: JSON.stringify(allDatas),
      cmeasurereason: cmeasurereason,
      cmeasurepurpose: cmeasurepurpose2,
      cmeasureunit: cmeasureunit,
      cmemo: cmemo,
      cdcno: cdcno,
      isok: isok,
      docqcformmiautoid: iautoid
    }
    LayerMsgBox.loading("正在更新,请稍等...", 30000);
    Ajax.post("admin/rcvdocqcformm/saveEditTable", submitDatas, function (res) {
      if (res.state === "ok") {
        LayerMsgBox.success(res.msg, 1000, function () {
          refreshPjaxContainer();
          parent.LayerMsgBox.closeAll();
          parent.refreshPjaxContainer();
        });
      } else {
        LayerMsgBox.alert(res.msg, 2);
      }
    })
  }

</script>

<script>

</script>

#end


