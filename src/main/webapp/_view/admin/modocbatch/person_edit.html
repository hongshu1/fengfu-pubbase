#@adminDialogLayout()

#define css()
<link href="assets/plugins/Grape/16.0.2/css/gc.spread.sheets.16.0.2.css" rel="stylesheet">
<style>
    .spread-container {
        height:75.5vh;
    }

    .gc-statusbar {
        height: 25px;
        min-height: 25px;
        background: #217346;
        font-size: 0.6rem;
        color: aliceblue;
    }
    body,p {
        margin: 0px;
        padding: 0px;
        font-size: 12px;
        color: black;
    }

    #box {
        height: 100vh;
        font-weight: bold;
    }
    /* 头部用户数据 */
    .nav_title {
        text-indent: 1rem;
        padding: 10px 0px;
        font-size: 0.9rem;
        color: #5C5C5C;
        border: 1px solid #CCCCCC;
    }

    .search {
        display: flex;
        padding: 10px 0px;
    }

    /* 下拉框文字样式 */
    .select {
        margin-right: 15px;
    }

    .span {
        color: #333333;
    }

    .select:nth-child(1) {
        margin-left: 10px;
    }

    /* 搜索重置按钮样式 */
    .button {
        margin: 0px 10px;
        padding: 3px 10px;
        background-color: #fff;
        border: #797979 1px solid;
    }
    /* 表格工具 */
    .but_box {
        padding: 15px 0px;
        padding-left: 15px;
        border-bottom: none;
    }

    /* 表格按钮 */
    .but_box button {
        padding: 3px 10px;
        margin-right: 8px;
        background-color: #fff;
        border: #797979 1px solid;
        border-radius: 5px;
    }
    /*    */
    /* 设置Dialog的样式 */
    .dialog-mask {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: none;
    }

    .dialog-wrapper {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px;
        background-color: #fff;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .dialog-header {
        padding: 10px;
        background-color: #f5f7fa;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        border-bottom: 1px solid #ebeef5;
    }

    .dialog-title {
        font-size: 16px;
        font-weight: bold;
        color: #303133;
    }

    .dialog-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 18px;
        color: #909399;
        cursor: pointer;
    }

    .dialog-body {
        padding: 20px;
        font-size: 14px;
        color: #606266;
    }

    .dialog-footer {
        padding: 10px;
        text-align: right;
        border-top: 1px solid #ebeef5;
    }

    .dialog-btn {
        display: inline-block;
        padding: 10px 20px;
        font-size: 14px;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
    }

    .dialog-btn-cancel {
        background-color: #c0c4cc;
        margin-right: 10px;
    }

    .dialog-btn-ok {
        background-color: #409eff;
    }
</style>
#end

#define main()
#set(pageId=RandomUtil.random(6))
<div class="jbolt_page">
    <div class="jbolt_page_title">
        <!-- 头部标题开始 -->
        <nav>
            <p class="nav_title">制造工单人员安排</p>
        </nav>
        <!-- 头部标题结束 -->
        <!-- 搜索工具类开始 -->
        <div class="search">
            <div class="select">
                <div class="select">
                    <span>日期:</span>
                    <input style="width:150px;height:20px;" id="cinvcode1" disabled/>
                    <input style="width:150px;height:20px;" id="cinvcode2" disabled/>
                </div>
            </div>
            <div class="select">
                <div class="select">
                    <span>生产部门:</span>
                    <input style="width:150px;height:20px;" id="cinvcode3" disabled/>
                </div>
            </div>
        </div>
        <!-- 搜索工具类结束 -->
    </div>
    <div class="jbolt_page_content">
        <div class="sample-container">
            <!-- 表格 -->
            <div id="table-tool">
                <!-- 表格工具开始 -->
                <div class="but_box">
                    <button class="button">数据导出</button>
                    <button class="button">数据导入</button>
                    <button class="button">保存</button>
                    <button class="button">提交审批</button>
                </div>
                <!-- 创建表格目标DOM元素，id为ss的HTML -->
                <div id="ss" class="spread-container"></div>
                <div id="statusBar" class="gc-statusbar"></div>
            </div>
        </div>
    </div>
    <!--    -->
    <!-- 创建Dialog结构 -->
    <div class="dialog-mask" id="dialog-mask">
        <div class="dialog-wrapper">
            <div class="dialog-header">
                <span class="dialog-title">提示</span>
                <span class="dialog-close" id="dialog-close">×</span>
            </div>
            <div class="dialog-body">
                这是一个弹出框dialog
            </div>
            <div class="dialog-footer">
                <button class="dialog-btn dialog-btn-cancel" id="dialog-btn-cancel">取消</button>
                <button class="dialog-btn dialog-btn-ok" id="dialog-btn-ok">确定</button>
            </div>
        </div>
    </div>
</div>

#end

#define js()
<script type="text/javascript" src="assets/plugins/Grape/gc.spread.sheets.all.12.0.7.min.js"></script>
<script type="text/javascript">
    hideParentLayerDialogBtn(0);
    hideParentLayerDialogBtn(1);
    /**
     * @param Api 公共接口
     */
    var Api = '/';
    var spread = new GC.Spread.Sheets.Workbook(document.getElementById('ss'), {sheetCount: 1});
    //设置状态栏
    var statusBar = new GC.Spread.Sheets.StatusBar.StatusBar(document.getElementById('statusBar'));
    var sheet = spread.getSheet(0);//按照下标获取表单
    //设置全局内容水平垂直居中
    sheet.getRange(-1,-1,-1,-1).hAlign(GC.Spread.Sheets.HorizontalAlign.center).vAlign(GC.Spread.Sheets.VerticalAlign.center);
    //设置全局的字体样式
    sheet.getRange(-1, -1,-1,-1).font('宋体 bold 10px');
    //状态栏
    statusBar.bind(spread);
    spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
    var parmsDefault = {
        RowCount:200,           //一列多少单元格
        ColumnCount:500,         //一行多少单元格
        rowindex:0,				//x轴索引
        columnindex:0,			//y轴索引
        dayRow:10,              //day渲染起始下标
        weekRow:10,             //week渲染起始下标
        tableData:[],           //接收添加的数据
    };
    var parmsArr = [Object.assign({},parmsDefault)];
    //添加属性
    parmsArr[0]['spread'] = spread;
    parmsArr[0]['activeSheet'] = spread.getSheet(0);//获取指定的表单
    var parms = parmsArr[0];

    //设置全局表单的背景颜色
    spread.options.grayAreaBackColor = '#fff';

    loadInit();
    initData();
    initDate();
    /**
     * 初始化产线数据
     * @param loadInit
     */
    function loadInit(){
        //设置单元格内容的对齐方式
        var style = new GC.Spread.Sheets.Style();
        style.hAlign = GC.Spread.Sheets.HorizontalAlign.center;
        style.vAlign = GC.Spread.Sheets.VerticalAlign.center;
        spread.sheets.forEach(function(sheet) {
            sheet.setDefaultStyle(style, GC.Spread.Sheets.SheetArea.viewport);
        });
        //设置全局的列宽行高
        sheet.defaults.colWidth = 80;
        sheet.defaults.rowHeight = 30;
        spread.getSheet(0).setRowCount(parms.RowCount); //设置一列单元格的个数
        spread.getSheet(0).setColumnCount(parms.ColumnCount); //设置一行有多少个单元格
        //设置value值和该单元格的对齐方式
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex).text("序号");
        parms.activeSheet.setColumnWidth(parms.columnindex, 40);//设置指定单元格的width
        sheet.addSpan(0,0,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+1).text("产线名称");
        parms.activeSheet.setColumnWidth(parms.columnindex+1, 60);//设置指定单元格的width
        parms.activeSheet.addSpan(0,1,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+2).text("存货编码");
        parms.activeSheet.addSpan(0,2,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+3).text("客户部番");
        parms.activeSheet.addSpan(0,3,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+4).text("部品名称");
        parms.activeSheet.addSpan(0,4,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+4, 100);//设置指定单元格的width
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+5).text("设备名称");
        parms.activeSheet.addSpan(0,5,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+5, 140);//设置指定单元格的width
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+6).text("工序名称");
        parms.activeSheet.addSpan(0,6,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+6, 140);//设置指定单元格的width
    }
    /*工作簿暂停活性*/
    function spreadSuspend() {
        spread.suspendPaint(); //渲染前失活(提升性能)
        spread.suspendCalcService(); //暂停计算服务
    }
    /*工作簿开启活性*/
    function spreadResume() {
        spread.resumeCalcService(); //开启计算服务
        spread.resumePaint(); //恢复绘制
    }
    //双击单元格事件
    sheet.bind(GC.Spread.Sheets.Events.CellDoubleClick, function (sender, args) {
        showDialog();
    });
    /**
     * 获取接口返回的日期数据
     * @param initDate
     * @param parms 自定义对象，用户接收数据
     * @param sheet 当前活动表单
     */
    function initDate() {
        let url = `admin/modocbatch/personEditHeaderDatas?taskid=1668495051179982848`
        $.ajax({
            url,
            type:'get',
            dataType:'json',
            success:function (respons){
                let tableHeadArray = respons.data.datas;
                spreadSuspend();//暂停绘制
                //渲染头部数据
                let startDate = document.getElementById("cinvcode1");
                startDate.value=respons.data.startdate;
                let endDate = document.getElementById("cinvcode2");
                endDate.value=respons.data.stopdate;
                let depname = document.getElementById("cinvcode3");
                depname.value=respons.data.depname;
                //渲染日期班次
                let dateCol = 7;
                let dateRow = 0;
                let colSpan = 5;
                spread.getActiveSheet().setRowVisible(1, false);//隐藏第2行
                for (let i = 0; i < tableHeadArray.length; i++) {
                    for (let j = 0; j < tableHeadArray[i].length; j++) {
                        colSpan=colSpan+tableHeadArray[i].length-1;
                        if(j<tableHeadArray[i].length-1){
                            sheet.setValue(dateRow, dateCol++,tableHeadArray[i].at(-1).yeartodate);
                            sheet.setValue(dateRow+2, dateCol-1,tableHeadArray[i][j].weeks);
                            sheet.setValue(dateRow+3, dateCol-1,tableHeadArray[i][j].cworkshiftcode);
                        }
                        parms.activeSheet.addSpan(0,colSpan,1,tableHeadArray[i].length-1);
                        sheet.setValue(dateRow+1, dateCol-1,tableHeadArray[i].at(-1).yeartodate);
                    }
                }
                spreadResume();// 恢复绘制
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * 初始化产线数据
     * @param initData
     */
    function initData(){
        let url = `admin/modocbatch/getModocStaffEditorDatas?taskid=1668495051179982848`
        $.ajax({
            url,
            type:'get',
            dataType:'json',
            success:function (respons){
                const jsonData = respons;
                console.log(jsonData)
                spreadSuspend();//暂停绘制
                let rowIndex = 4;
                let colIndex=0;
                let serialCol = 1;
                let a1 = 4;
                let A = 5;
                let B = 6;
                let Q = 4;
                let W = 5;
                parms.activeSheet.setColumnWidth(1, 150);//设置指定单元格的width
                parms.activeSheet.setColumnWidth(2, 100);//设置指定单元格的width
                parms.activeSheet.setColumnWidth(3, 150);//设置指定单元格的width
                parms.activeSheet.setColumnWidth(4, 150);//设置指定单元格的width
                let leg=4;//接收上一次数组的长度
                let productionLength=0;//产线数据长度
                for (let i = 0; i <jsonData.data.length; i++) {
                    if(i==0){
                        //序号
                        sheet.setValue(rowIndex, colIndex,i+1);
                        sheet.addSpan(rowIndex,colIndex,jsonData.data[i].rowdatas.length+4,1);
                        //产线名称
                        sheet.setValue(rowIndex, serialCol,jsonData.data[i].cworkname);
                        parms.activeSheet.addSpan(rowIndex,serialCol,jsonData.data[i].rowdatas.length+4,1);
                        //存货编码
                        sheet.setValue(rowIndex, serialCol+1,jsonData.data[i].cinvcode);
                        parms.activeSheet.addSpan(rowIndex,serialCol+1,jsonData.data[i].rowdatas.length+4,1);
                        //客户部番
                        sheet.setValue(rowIndex, serialCol+2,jsonData.data[i].cinvcode1);
                        parms.activeSheet.addSpan(rowIndex,serialCol+2,jsonData.data[i].rowdatas.length+4,1);
                        //部品名称
                        sheet.setValue(rowIndex, serialCol+3,jsonData.data[i].cinvname1);
                        parms.activeSheet.addSpan(rowIndex,serialCol+3,jsonData.data[i].rowdatas.length+4,1);
                        rowIndex = rowIndex+jsonData.data[i].rowdatas.length+4;
                        //设置工作安排统计区域value
                        //设备名称
                        sheet.setValue(a1+jsonData.data[i].rowdatas.length, A,"工单号");
                        const style_1S = new GC.Spread.Sheets.Style();
                        style_1S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(a1+jsonData.data[i].rowdatas.length, A,style_1S);
                        parms.activeSheet.addSpan(a1+jsonData.data[i].rowdatas.length,A,1,2);
                        //
                        sheet.setValue(a1+jsonData.data[i].rowdatas.length+1, A,"生产计划量");
                        const style_2S = new GC.Spread.Sheets.Style();
                        style_2S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(a1+jsonData.data[i].rowdatas.length+1, A,style_2S);
                        parms.activeSheet.addSpan(a1+jsonData.data[i].rowdatas.length+1,A,1,2);
                        //
                        sheet.setValue(a1+jsonData.data[i].rowdatas.length+2, A,"小计人数");
                        const style_3S = new GC.Spread.Sheets.Style();
                        style_3S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(a1+jsonData.data[i].rowdatas.length+2, A,style_3S);
                        parms.activeSheet.addSpan(a1+jsonData.data[i].rowdatas.length+2,A,1,2);
                        //
                        sheet.setValue(a1+jsonData.data[i].rowdatas.length+3, A,"产线组长");
                        const style_4S = new GC.Spread.Sheets.Style();
                        style_4S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(a1+jsonData.data[i].rowdatas.length+3, A,style_4S);
                        parms.activeSheet.addSpan(a1+jsonData.data[i].rowdatas.length+3,A,1,2);
                        a1=jsonData.data[i].rowdatas.length;
                    }else{
                        //序号
                        sheet.setValue(rowIndex, colIndex,i+1);
                        sheet.addSpan(rowIndex,colIndex,jsonData.data[i].rowdatas.length+4,1);
                        //产线名称
                        sheet.setValue(rowIndex, serialCol,jsonData.data[i].cworkname);
                        parms.activeSheet.addSpan(rowIndex,serialCol,jsonData.data[i].rowdatas.length+4,1);
                        //存货编码
                        sheet.setValue(rowIndex, serialCol+1,jsonData.data[i].cinvcode);
                        parms.activeSheet.addSpan(rowIndex,serialCol+1,jsonData.data[i].rowdatas.length+4,1);
                        //客户部番
                        sheet.setValue(rowIndex, serialCol+2,jsonData.data[i].cinvcode1);
                        parms.activeSheet.addSpan(rowIndex,serialCol+2,jsonData.data[i].rowdatas.length+4,1);
                        //部品名称
                        sheet.setValue(rowIndex, serialCol+3,jsonData.data[i].cinvname1);
                        parms.activeSheet.addSpan(rowIndex,serialCol+3,jsonData.data[i].rowdatas.length+4,1);
                        rowIndex = rowIndex+jsonData.data[i].rowdatas.length+4;
                        //设置工作安排统计区域value
                        //设备名称
                        sheet.setValue(rowIndex-4, A,'工单号');
                        const style_1S = new GC.Spread.Sheets.Style();
                        style_1S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(rowIndex-4, A,style_1S);
                        parms.activeSheet.addSpan(rowIndex-4,A,1,2);
                        //
                        sheet.setValue(rowIndex-3, A,'生产计划量');
                        const style_2S = new GC.Spread.Sheets.Style();
                        style_2S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(rowIndex-3, A,style_2S);
                        parms.activeSheet.addSpan(rowIndex-3,A,1,2);
                        //
                        sheet.setValue(rowIndex-2, A,'小计人数');
                        const style_3S = new GC.Spread.Sheets.Style();
                        style_3S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(rowIndex-2, A,style_3S);
                        parms.activeSheet.addSpan(rowIndex-2,A,1,2);
                        //
                        sheet.setValue(rowIndex-1, A,'产线组长');
                        const style_4S = new GC.Spread.Sheets.Style();
                        style_4S.backColor = "#F0F0F0";
                        parms.activeSheet.setStyle(rowIndex-1, A,style_4S);
                        parms.activeSheet.addSpan(rowIndex-1,A,1,2);
                    }
                    jsonData.data[i].rowdatas.forEach((item,k)=>{
                            sheet.setValue(leg+k, W,item.cequipment.cequipmentname);
                            sheet.setValue(leg+k, W+1,item.coperation.coperationname);
                            item.user.forEach((it,ind)=>{
                                sheet.setValue(leg+k, 7+ind,ind);
                                sheet.setValue(rowIndex-4, 7+ind,ind);
                                sheet.setValue(rowIndex-3, 7+ind,ind);
                                sheet.setValue(rowIndex-2, 7+ind,ind);
                                sheet.setValue(rowIndex-1, 7+ind,ind);
                            })

                            if(k==jsonData.data[i].rowdatas.length-1){
                                leg=leg+jsonData.data[i].rowdatas.length + 4;
                            }
                    })
                }

                spreadResume();// 恢复绘制
            },error: function(error) {
                console.log(error);
            }
        })
    }
    // 获取Dialog元素
    var dialogMask = document.getElementById("dialog-mask");
    var dialogClose = document.getElementById("dialog-close");
    var dialogBtnCancel = document.getElementById("dialog-btn-cancel");
    var dialogBtnOk = document.getElementById("dialog-btn-ok");
    // 显示Dialog
    function showDialog() {
        dialogMask.style.display = "block";
    }
    // 隐藏Dialog
    function hideDialog() {
        dialogMask.style.display = "none";
    }
    // 关闭Dialog
    function closeDialog() {
        hideDialog();
    }
    // 绑定事件
    dialogClose.onclick = closeDialog;
    dialogBtnCancel.onclick = closeDialog;
    dialogBtnOk.onclick = closeDialog;
</script>
#end
