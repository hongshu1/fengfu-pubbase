#@adminDialogLayout()

#define css()
<link href="assets/plugins/Grape/16.0.2/css/gc.spread.sheets.16.0.2.css" rel="stylesheet">
<style>
    .spread-container {
        height:75.5vh;
    }

    .gc-statusbar {
        height: 25px;
        min-height: 25px;
        background: #217346;
        font-size: 0.6rem;
        color: aliceblue;
    }
    body,p {
        margin: 0px;
        padding: 0px;
        font-size: 12px;
        color: black;
    }
</style>
#end

#define main()
#set(pageId=RandomUtil.random(6))
<div>
    <!-- 创建表格目标DOM元素，id为ss的HTML -->
    <div id="ss" class="spread-container"></div>
    <div id="statusBar" class="gc-statusbar"></div>
</div>
#end
#define js()
<script type="text/javascript" src="assets/plugins/Grape/gc.spread.sheets.all.12.0.7.min.js"></script>
<script type="text/javascript">
    /**
     * @param Api 公共接口
     */
    var Api = '/';
    var spread = new GC.Spread.Sheets.Workbook(document.getElementById('ss'), {sheetCount: 1});
    //设置状态栏
    var statusBar = new GC.Spread.Sheets.StatusBar.StatusBar(document.getElementById('statusBar'));
    var sheet = spread.getSheet(0);//按照下标获取表单
    //设置全局内容水平垂直居中
    sheet.getRange(-1,-1,-1,-1).hAlign(GC.Spread.Sheets.HorizontalAlign.center).vAlign(GC.Spread.Sheets.VerticalAlign.center);
    //设置全局的字体样式
    sheet.getRange(-1, -1,-1,-1).font('宋体 bold 10px');
    //状态栏
    statusBar.bind(spread);
    spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
    var parmsDefault = {
        RowCount:200,           //一列多少单元格
        ColumnCount:500,         //一行多少单元格
        rowindex:0,				//x轴索引
        columnindex:0,			//y轴索引
        dayRow:10,              //day渲染起始下标
        weekRow:10,             //week渲染起始下标
        tableData:[],           //接收添加的数据
    };
    var parmsArr = [Object.assign({},parmsDefault)];
    //添加属性
    parmsArr[0]['spread'] = spread;
    parmsArr[0]['activeSheet'] = spread.getSheet(0);//获取指定的表单
    var parms = parmsArr[0];
    /*工作簿暂停活性*/
    function spreadSuspend() {
        spread.suspendPaint(); //渲染前失活(提升性能)
        spread.suspendCalcService(); //暂停计算服务
    }
    /*工作簿开启活性*/
    function spreadResume() {
        spread.resumeCalcService(); //开启计算服务
        spread.resumePaint(); //恢复绘制
    }
    //设置全局表单的背景颜色
    spread.options.grayAreaBackColor = '#fff';
    initData();
    initDate();
    loadInit();
    /**
     * 初始化产线数据
     * @param initData
     */
    function initData(){
        spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
        sheet.options.isProtected = true; // 开启工作表保护
        sheet.options.protectionOptions.allowEditObject = true; // 允许编辑对象
        sheet.options.protectionOptions.allowSelectLockedCells = true; // 允许选择锁定单元格
        sheet.options.protectionOptions.allowSelectUnlockedCells = true; // 允许选择非锁定单元格
        let url = `admin/modocbatch/getModocStaffEditorDatas?taskid=1668495051179982848`
        LayerMsgBox.loading("正在获取最新数据...",20000);
        $.ajax({
            url,
            type:'get',
            dataType:'json',
            success:function (respons){
                LayerMsgBox.closeLoading();
                const jsonData = respons;
                console.log(jsonData)
                spreadSuspend();//暂停绘制
                // let rowIndex = 4;
                // let colIndex=0;
                // let serialCol = 1;
                // let a1 = 4;
                // let A = 5;
                // let B = 6;
                // let Q = 4;
                // let W = 5;
                // let T = 7;
                // parms.activeSheet.setColumnWidth(1, 150);//设置指定单元格的width
                // parms.activeSheet.setColumnWidth(2, 100);//设置指定单元格的width
                // parms.activeSheet.setColumnWidth(3, 150);//设置指定单元格的width
                // parms.activeSheet.setColumnWidth(4, 150);//设置指定单元格的width
                // let leg=4;//接收上一次数组的长度
                // let jsonDataLength = 0;
                // for (let i = 0; i <jsonData.data.length-3; i++) {
                //     if(i==0){
                //         //序号
                //         sheet.setValue(rowIndex, colIndex,i+1);
                //         sheet.addSpan(rowIndex,colIndex,jsonData.data[i].rowdatas.length,1);
                //         //产线名称
                //         sheet.setValue(rowIndex, serialCol,jsonData.data[i].cworkname);
                //         parms.activeSheet.addSpan(rowIndex,serialCol,jsonData.data[i].rowdatas.length,1);
                //         //存货编码
                //         sheet.setValue(rowIndex, serialCol+1,jsonData.data[i].cinvcode);
                //         parms.activeSheet.addSpan(rowIndex,serialCol+1,jsonData.data[i].rowdatas.length,1);
                //         //客户部番
                //         sheet.setValue(rowIndex, serialCol+2,jsonData.data[i].cinvcode1);
                //         parms.activeSheet.addSpan(rowIndex,serialCol+2,jsonData.data[i].rowdatas.length,1);
                //         //部品名称
                //         sheet.setValue(rowIndex, serialCol+3,jsonData.data[i].cinvname1);
                //         parms.activeSheet.addSpan(rowIndex,serialCol+3,jsonData.data[i].rowdatas.length,1);
                //         rowIndex = rowIndex+jsonData.data[i].rowdatas.length;
                //     }else{
                //         //序号
                //         sheet.setValue(rowIndex, colIndex,i+1);
                //         sheet.addSpan(rowIndex,colIndex,jsonData.data[i].rowdatas.length,1);
                //         //产线名称
                //         sheet.setValue(rowIndex, serialCol,jsonData.data[i].cworkname);
                //         parms.activeSheet.addSpan(rowIndex,serialCol,jsonData.data[i].rowdatas.length,1);
                //         //存货编码
                //         sheet.setValue(rowIndex, serialCol+1,jsonData.data[i].cinvcode);
                //         parms.activeSheet.addSpan(rowIndex,serialCol+1,jsonData.data[i].rowdatas.length,1);
                //         //客户部番
                //         sheet.setValue(rowIndex, serialCol+2,jsonData.data[i].cinvcode1);
                //         parms.activeSheet.addSpan(rowIndex,serialCol+2,jsonData.data[i].rowdatas.length,1);
                //         //部品名称
                //         sheet.setValue(rowIndex, serialCol+3,jsonData.data[i].cinvname1);
                //         parms.activeSheet.addSpan(rowIndex,serialCol+3,jsonData.data[i].rowdatas.length,1);
                //         rowIndex = rowIndex+jsonData.data[i].rowdatas.length+4;
                //     }
                // }
                spreadResume();// 恢复绘制
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * 获取接口返回的日期数据
     * @param initDate
     * @param parms 自定义对象，用户接收数据
     * @param sheet 当前活动表单
     */
    function initDate() {
        let url = `admin/modocbatch/personEditHeaderDatas?taskid=1668495051179982848`
        $.ajax({
            url,
            type:'get',
            dataType:'json',
            success:function (respons){
                let tableHeadArray = respons.data.datas;
                spreadSuspend();//暂停绘制
                //渲染日期班次
                let dateCol = 7;
                let dateRow = 0;
                let colSpan = 5;
                spread.getActiveSheet().setRowVisible(1, false);//隐藏第2行
                for (let i = 0; i < tableHeadArray.length; i++) {
                    for (let j = 0; j < tableHeadArray[i].length; j++) {
                        colSpan=colSpan+tableHeadArray[i].length-1;
                        if(j<tableHeadArray[i].length-1){
                            //
                            sheet.setValue(dateRow, dateCol++,tableHeadArray[i].at(-1).yeartodate);
                            //
                            sheet.setValue(dateRow+2, dateCol-1,tableHeadArray[i][j].weeks);
                            //
                            sheet.setValue(dateRow+3, dateCol-1,tableHeadArray[i][j].cworkshiftcode);
                        }
                        parms.activeSheet.addSpan(0,colSpan,1,tableHeadArray[i].length-1);
                        parms.activeSheet.addSpan(2,colSpan,1,tableHeadArray[i].length-1);
                        sheet.setValue(dateRow+1, dateCol-1,tableHeadArray[i].at(-1).yeartodate);
                    }
                }
                spreadResume();// 恢复绘制
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * 初始化产线数据
     * @param loadInit
     */
    function loadInit(){
        //设置单元格内容的对齐方式
        var style = new GC.Spread.Sheets.Style();
        style.hAlign = GC.Spread.Sheets.HorizontalAlign.center;
        style.vAlign = GC.Spread.Sheets.VerticalAlign.center;
        spread.sheets.forEach(function(sheet) {
            sheet.setDefaultStyle(style, GC.Spread.Sheets.SheetArea.viewport);
        });
        //设置全局的列宽行高
        sheet.defaults.colWidth = 80;
        sheet.defaults.rowHeight = 30;
        spread.getSheet(0).setRowCount(parms.RowCount); //设置一列单元格的个数
        spread.getSheet(0).setColumnCount(parms.ColumnCount); //设置一行有多少个单元格
        //设置value值和该单元格的对齐方式
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex).text("序号");
        parms.activeSheet.setColumnWidth(parms.columnindex, 40);//设置指定单元格的width
        sheet.addSpan(0,0,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+1).text("产线名称");
        parms.activeSheet.setColumnWidth(parms.columnindex+1, 60);//设置指定单元格的width
        parms.activeSheet.addSpan(0,1,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+2).text("存货编码");
        parms.activeSheet.addSpan(0,2,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+3).text("客户部番");
        parms.activeSheet.addSpan(0,3,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+4).text("部品名称");
        parms.activeSheet.addSpan(0,4,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+4, 100);//设置指定单元格的width
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+5).text("设备名称");
        parms.activeSheet.addSpan(0,5,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+5, 140);//设置指定单元格的width
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+6).text("工序名称");
        parms.activeSheet.addSpan(0,6,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+6, 140);//设置指定单元格的width
    }
</script>
#end
