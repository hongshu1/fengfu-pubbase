#@jboltLayout()
#define main()
#define css()
<link href="assets/plugins/Grape/16.0.2/css/gc.spread.sheets.16.0.2.css" rel="stylesheet">
<link rel="stylesheet" href="assets/js/pagination/layui/layui.css">
<link rel="stylesheet" href="assets/icon/bootstrap-icons/font/bootstrap-icons.min.css">
<style>
    .spread-container {
        height:63vh;
    }

    .gc-statusbar {
        height: 25px;
        min-height: 25px;
        background: #217346;
        font-size: 0.6rem;
        color: aliceblue;
    }
    body,p,ul,li {
        list-style-type: none;
        margin: 0px;
        padding: 0px;
        font-size: 12px;
        color: black;
    }

    #box {
        height: 100vh;
        font-weight: bold;
    }

    /* 头部用户数据 */
    .nav_title {
        text-indent: 1rem;
        padding: 10px 0px;
        font-size: 0.9rem;
        color: #5C5C5C;
        border: 1px solid #CCCCCC;
    }

    .search {
        display: flex;
        /*flex-direction: row ;*/
        align-items: center; /* 垂直居中 */
        padding: 10px 0px;
    }


    .span {
        color: #333333;
    }

    .select:nth-child(1) {
        margin-left: 10px;
    }

    /* 搜索重置按钮样式 */
    .button {
        padding: 3px 10px;
        background-color: transparent;
        border: #797979 1px solid;
    }

    /* 表格工具 */
    .but_box {
        padding: 15px 0px;
        padding-left: 15px;
        border-bottom: none;
    }

    /* 表格按钮 */
    .but_box button {
        padding: 3px 10px;
        margin-right: 8px;
        border-radius: 5px;
    }
    /*  锁定弹出框样式  */
    #alert{
        border: 1px solid rgba(215, 215, 215, 1);
        background-color:#fff;
        width: 430px;
        height: 170px;
        z-index: 500;
        position: absolute;
        display: none;
        box-shadow: 5px -5px 5px rgba(0,0,0,0.5);
    }
    #alert .alert_title{
        font-size: 14px;
        border-bottom: 3px solid rgba(215, 215, 215, 1);
        padding-bottom: 30px;
        text-indent: 0.8rem
    }
    #alert .alert_title span{
        float: right;
    }
    #alert .alert_title #close{
        font-size: 18px;
        margin-right: 10px;
        cursor: pointer;
    }
    #alert .alert_but{
        width: 100%;
    }
    #alert .alert_but button{
        margin: 10px 15px;
        padding: 3px 13px;
        background-color: #fff;
        border: #797979 1px solid;
        margin-bottom: 0px;
        border-radius: 5px;
    }
    /*  预示保存弹出框样式  */
    #indicate_Mode{
        border: 1px solid rgba(215, 215, 215, 1);
        background-color:#fff;
        width: 430px;
        height: 200px;
        z-index: 1000;
        position: absolute;
        display: none;
        box-shadow: 5px -5px 5px rgba(0,0,0,0.5);
    }
    #indicate_Mode .indicate_title{
        display: flex;
        font-size: 14px;
        border-bottom: 3px solid rgba(215, 215, 215, 1);
        text-indent: 0.8rem;
        padding: 10px;
    }
    #indicate_Mode .indicate_title span:nth-child(1){
        flex: 1;
    }
    #indicate_Mode .indicate_title #close_indicate{
        font-size: 18px;
        margin-right: 10px;
        cursor: pointer;
    }
    #indicate_Mode .indicate_but{
        width: 100%;
    }
    #indicate_Mode .indicate_but button{
        margin: 10px 15px;
        padding: 3px 13px;
        background-color: #fff;
        border: #797979 1px solid;
        margin-bottom: 0px;
        float: right;
        border-radius: 5px;
    }

    /**/
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        background-color: #fff;
        border: 1px solid #ccc;
        color: #333;
        width: 120px;
        font-size: 13px;
        cursor: pointer;
        overflow: hidden;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1;
        display: none;
        min-width: 160px;
        padding: 8px 0;
        margin: 2px 0 0;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 6px 12px rgba(0,0,0,.175);
    }

    .dropdown-menu li{
        line-height: 25px;
        border-bottom: 1px solid #ccc;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        display: block;
        padding: 3px 20px;
        clear: both;
        font-weight: 400;
        color: #333;
        text-align: inherit;
        white-space: nowrap;
        background-color: transparent;
        border: 0;
    }

    .dropdown-item:hover {
        background-color: #f5f5f5;
    }

    /* 遮罩层样式 */
    .popup-layer{
        border: 1px solid rgba(215, 215, 215, 1);
        background-color:#fff;
        width: 560px;
        height: 400px;
        padding: 20px;
        z-index: 1000;
        position: absolute;
        overflow-y: scroll;
        display: none;
    }
    .popup-confirm{
        margin-bottom: 20px;
    }
    #popup_table{
        text-align: center;
        margin-bottom: 20px;
    }
    #popup_table tr{
        height: 40px;
    }
    /* 遮罩层样式 */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9;
        display: none;
    }

    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: none;
        max-width: 400px;
        width: 90%;
    }

    .popup p {
        margin-bottom: 10px;
        margin-top: 0px;
        display: flex;
        align-items: center;
        font-size: 16px;
    }

    .popup p span:nth-child(1) {
        flex: 1;
    }

    .popup p span:nth-child(2) {
        font-size: 20px;
        cursor: pointer;
    }

    input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        margin-bottom: 10px;
    }

    .buttons {
        float: right;
        width: 80px;
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
    }

    .buttons:hover {
        background-color: #0056b3;
    }
    .btn-success{
        background-color: #28a745;
        border-color: #28a745;
    }
    .btn{
        border: #28a745 1px solid;
    }
/*    */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        width: 300px;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
    }

    .btn-container {
        text-align: right;
        margin-top: 20px;
    }

    .btn-container button {
        margin-left: 10px;
    }
</style>
#end
#set(pageId=RandomUtil.random(6))
<div class="jbolt_page" data-key="#(pmkey??)">
    <nav>
        <p class="nav_title">物料需求计划计算</p>
    </nav>
    <!-- 头部标题结束 -->
    <!-- 搜索工具类开始 -->
    <div class="but_box">
            <span class="span">供应商名称:</span>
            <div class="dropdown">
                <button class="dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" name="supplier" style="height:2rem"></button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="supplier_id">
                </ul>
            </div>
            <span>存货编码:</span>
            <input style="width:150px;height:2rem;" id="cinvcode"/>
            <span>客户部番:</span>
            <input style="width:150px;height:2rem;" id="cinvcode1"/>
            <span>部品名称:</span>
            <input style="width:150px;height:2rem;" id="cinvname1"/>
        <div style="margin-left: 20px;display:inline-block;">
            <div class="row">
                <span style="margin-top: 5px">日期：</span>
                <div class="col" style="display:flex;">
                    <input type="date" id="search_start-times" name="search_start-times" style="height: 2rem">
                    <p style="width: 30px;text-align: center;line-height:2rem;">至</p>
                    <input type="date" id="search_end-time" name="search_end-time" style="height: 2rem">
                </div>
            </div>
        </div>
        <div style="margin-left: 20px;margin-right: 20px;display:inline-block;">
            <button class="button" onClick="search()" style="height:2rem;padding: 0px 20px;color: #fff;background-color: #28a745;border-color: #28a745;">
                <i class="bi bi-search"></i>
                搜索
            </button>
            <button class="button" onClick="reset()" style="height:2rem;padding: 0px 20px;color: #fff;background-color: #1989fa;border: 1px solid #1989fa;">
                <i class="bi bi-arrow-clockwise"></i>
                重置
            </button>
        </div>
    </div>

    <div class="jbolt_page_content">

        <div class="sample-container">
            <!-- 表格 -->
            <div id="table-tool">
                <!-- 表格工具开始 -->
                <div class="but_box">
                    <button id="content" onClick="openModal()" style="border: #797979 1px solid;background-color: transparent;padding: 5px 10px">
                        <i class="bi bi-arrow-repeat"></i>
                        计划生成
                    </button>
                    <button onClick="loadExcel()" style="border: #797979 1px solid;padding: 5px 10px;background-color: #ffc107;border-color: #ffc107;">
                        <i class="bi bi-box-arrow-up-right"></i>
                        数据导出
                    </button>
                    <button id="indicate_save" class="btn-success btn">
                        <i class="bi bi-check2-square"></i>
                        预示保存
                    </button>
                    <button class="" style="border: #797979 1px solid;background-color: transparent;padding: 5px 10px">到货计划保存</button>
                </div>
                <!-- 创建表格目标DOM元素，id为ss的HTML -->
                <div id="ss" class="spread-container"></div>
                <div id="statusBar" class="gc-statusbar"></div>
            </div>

        </div>
        <!--预示保存弹框-->
        <div id="indicate_Mode">
            <p class="indicate_title"><span id="indicate_title"></span><span id="close_indicate">X</span></p>
            <form>
                <div class="form-group row" style="margin-top: 20px">
                    <label class="col-sm-2 col-form-label">日期：</label>
                    <div class="col" style="display:flex;">
                        <input type="date" id="start-time" name="start-time">
                        <p style="width: 30px"></p>
                        <input type="date" id="end-time" name="end-time">
                    </div>
                </div>
                <div style="margin-top: 20px">
                    <div>
                        <label style="margin-left: 10px">选择供应商：</label>
                        <input name="Fruit1" id="all" class="chBox" type="checkbox" style="vertical-align:middle;" onClick="checkAll()"/><span>全选</span>
                    </div>
                    <div style="display: flex;">
                        <label style="margin-left:85px"></label>
                        <div class="dropdown">
                            <button class="dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" name="col"></button>
                            <ul class="dropdown-menu" id="project_id"></ul>
                        </div>
                    </div>
                </div>
            </form>
            <p class="indicate_but">
                <button id="close_indicate_but" class="bnt" style="padding: 7px 20px">取消</button>
                <button onClick="indicateSave()" class="bnt" style="color: #fff;background-color: #1989fa;border: 1px solid #1989fa;padding: 7px 20px">确定</button>
            </p>
        </div>
        <!--导出弹出框开始-->
        <div class="overlay" id="overlay"></div>
        <div class="popup" id="popup">
            <p style="padding: 10px;"><span>请输入导出表格名称</span><span onClick="hidePopup()" style="font-size: 1.6rem">x</span></p>
            <input type="text" placeholder="请输入名称" id="input">
            <button onclick="excelFileSave()" class="buttons" style="float: right;width: 60px;">确定</button>
        </div>
        <!--导出弹出框结束-->
    </div>
    <!--计划生成弹框-->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()" style="font-size: 2rem">&times</span>
            <div class="layui-form" style="margin: 16px;">
                <div class="select" style="margin-top: 15px;margin-left: 20px;margin-bottom: 15px;">
                    <label class="col-form-label" style="font-size: 0.9rem">截止日期：</label>
                    <input type="date" id="datetime-locals" value="" cname="datetime-locals" style="display: inline-block; width: 200px;height: 2.5rem">
                </div>
            </div>
            <div class="btn-container">
                <button class="buttons" onclick="closeModal()">关闭</button>
                <button class="buttons" onclick="confirmAction()">确定</button>
            </div>
        </div>
    </div>
</div>
#end

#define js()
    <script type="text/javascript" src="assets/plugins/Grape/gc.spread.sheets.all.12.0.7.min.js"></script>
    <script type="text/javascript" src="assets/plugins/Grape/gc.spread.excelio.12.0.7.min.js"></script>
    <script type="text/javascript" src="assets/plugins/Grape/FileSaver.min.js"></script>
    <script src="assets/js/pagination/layui/layui.js"></script>
<script type="text/javascript">
    /**
     * @param Api 公共接口
     */
    var Api = '/';
    //创建表单实列
    var spread = new GC.Spread.Sheets.Workbook(document.getElementById('ss'), {sheetCount: 1,calcOnDemand: true});
    spread.options.referenceStyle = GC.Spread.Sheets.ReferenceStyle.r1c1;
    //设置状态栏
    var statusBar = new GC.Spread.Sheets.StatusBar.StatusBar(document.getElementById('statusBar'));
    var sheet = spread.getSheet(0);//按照下标获取活动表单
    //设置全局内容水平垂直居中
    //设置全局的字体样式
    sheet.getRange(-1, -1,-1,-1).font('宋体 bold 10px');
    //状态栏
    statusBar.bind(spread);
    spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
    var excelIo = new GC.Spread.Excel.IO();

    var parmsDefault = {
        RowCount:200,           //一列多少单元格
        ColumnCount:500,         //一行多少单元格
        rowindex:0,				//x轴索引
        columnindex:0,			//y轴索引
        dayRow:10,              //day渲染起始下标
        weekRow:10,             //week渲染起始下标
        tableData:[],           //接收添加的数据
        planListRowIndex:4,     //计划排产列表起始行下标
        planListColIndex:7,     //计划排产列表起始列下标
        supplierData:[],        //所有供应商数据
        supplierValueArray:[],  //存储当前点击选中的供应商
        searchSupplier:"",      //存储需要搜索的供应商
        openBoxTime:'',         //打开锁定弹框的时间戳
    };

    var parmsArr = [Object.assign({},parmsDefault)];
    //添加属性
    parmsArr[0]['spread'] = spread;
    parmsArr[0]['activeSheet'] = spread.getSheet(0);//获取指定的表单
    var parms = parmsArr[0];
    loadInit();
    initDate();
    initData();

    //设置全局表单的背景颜色
    spread.options.grayAreaBackColor = '#fff';
    /**
     * 初始化表格数据
     * @param loadInit
     */
    function loadInit(){
        spreadSuspend();//暂停绘制
        //设置全局的列宽行高
        sheet.defaults.colWidth = 80;
        sheet.defaults.rowHeight = 25;
        spread.getSheet(0).setRowCount(parms.RowCount); //设置一列单元格的个数
        spread.getSheet(0).setColumnCount(parms.ColumnCount); //设置一行有多少个单元格

        //设置单元格内容的对齐方式
        var style = new GC.Spread.Sheets.Style();
        style.hAlign = GC.Spread.Sheets.HorizontalAlign.center;
        style.vAlign = GC.Spread.Sheets.VerticalAlign.center;
        spread.sheets.forEach(function(sheet) {
            sheet.setDefaultStyle(style, GC.Spread.Sheets.SheetArea.viewport);
        });

        var cellType = new GC.Spread.Sheets.CellTypes.CheckBox();//定义多选按钮
        //设置value值
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex).cellType(cellType);
        sheet.addSpan(0,0,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+1).text("序号");
        parms.activeSheet.addSpan(0,1,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+2).text("供应商名称");
        parms.activeSheet.addSpan(0,2,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+3).text("存货编码");
        parms.activeSheet.addSpan(0,3,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+4).text("客户部番");
        parms.activeSheet.addSpan(0,4,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+5).text("部品名称");
        parms.activeSheet.addSpan(0,5,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+6).text("包装数量");
        parms.activeSheet.addSpan(0,6,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+7).text("标准在库天数");
        parms.activeSheet.addSpan(0,7,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+8).text("项目");
        parms.activeSheet.addSpan(0,8,4,1);
        parms.activeSheet.setColumnWidth(parms.columnindex, 40);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+1, 60);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+2, 100);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+4, 150);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+6, 100);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+7, 120);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+8, 120);//设置指定单元格的width


        let searchStartTime = document.getElementById('search_start-times');
        // 获取当前日期
        var currentDate = new Date();
        // 设置日期为当前月的1号
        currentDate.setDate(1);
        // 获取1号的时间戳
        var timestamp = currentDate.getTime();
        // 转换为Date对象
        var date = new Date(timestamp);
        // 获取年、月、日
        var year = date.getFullYear();
        var month = date.getMonth() + 1; // 月份从0开始，需要加1
        var day = date.getDate();
        // 拼接成年月日格式
        var formattedDate = year + '-' + month.toString().padStart(2, '0') + '-' + day.toString().padStart(2, '0');
        searchStartTime.value = formattedDate;
        spreadResume();// 恢复绘制
    }
    /**
     * 获取接口返回的日期数据渲染
     * @param initDate
     */
    function initDate(searchData) {
        let url = searchData!=undefined?Api+`admin/schedudemandplan/getTableHead?startDate=${searchData.searchStartTime}&endDate=${searchData.searchEndTime}`
            :`admin/schedudemandplan/getTableHead?startDate=&endDate=`;
        //获取接口数据
        Ajax.get(url,(res)=>{
            spreadSuspend();//暂停绘制
            spread.getActiveSheet().setRowVisible(1, false);//隐藏第2行
            let date = 1;
            let dateCol = 10;
            let C = 10;
            let numberArray = [];
            for (let i = 1; i <= 31; i++) {
                numberArray.push(i)
            }
            //设置头部年月份
            for (let i = 0; i < res.data.month.length; i++) {
                let index = numberArray.findIndex(v=>v==res.data.month[i].colsum);
                if(index!=1){
                    date=numberArray[index];
                    for (let j = 0; j < numberArray[index]; j++) {
                        sheet.setValue(1,C++,res.data.month[i].colname);
                    }
                    if(i==0){
                        sheet.setValue(0, dateCol,res.data.month[i].colname);//插入数据
                        sheet.addSpan(0,dateCol,1,i+1*date);//跨行列
                        dateCol += date;
                    }else{
                        sheet.setValue(0, dateCol,res.data.month[i].colname);//插入数据
                        sheet.addSpan(0,dateCol,1,date);//跨行列
                        dateCol += date;
                    }
                }
            }
            for (let i = 0; i < res.data.day.length; i++) {
                sheet.setValue(2,parms.dayRow++,res.data.day[i]);
                sheet.setValue(3,parms.weekRow++,res.data.week[i]);
            }
            // var addCol = res.data.day.length*2,addRow = 41;
            // var row = parms.ColumnCount+addRow;
            // var col = parms.RowCount+addCol;
            // spread.getSheet(0).setRowCount(col); //设置一列单元格的个数
            // spread.getSheet(0).setColumnCount(row); //设置一行有多少个单元格
            // parms.RowCount=col;
            // parms.ColumnCount=row;
            //设置周六日背景色条件格式
            let style3Sat = new GC.Spread.Sheets.Style();
            style3Sat.foreColor = '#000';
            style3Sat.backColor = "#00FFFF";
            parms.activeSheet.conditionalFormats.addSpecificTextRule(GC.Spread.Sheets.ConditionalFormatting.TextComparisonOperators.contains,'Sat',style3Sat,[new GC.Spread.Sheets.Range(3, 10, 1, res.data.day.length)]);
            let style3Sun = new GC.Spread.Sheets.Style();
            style3Sun.foreColor = '#000';
            style3Sun.backColor = "#00FFFF";
            parms.activeSheet.conditionalFormats.addSpecificTextRule(GC.Spread.Sheets.ConditionalFormatting.TextComparisonOperators.contains,'Sun',style3Sun,[new GC.Spread.Sheets.Range(3, 10, 1, res.data.day.length)]);
            spreadResume();// 恢复绘制
        });
    }
    /**
     * 渲染表格数据
     * @param initData
     */
    function initData(searchData){
            let url = searchData!=undefined?Api+`admin/schedudemandplan/getDemandList?startdate=${searchData.searchStartTime}&enddate=${searchData.searchEndTime}&cvenname=${parms.searchSupplier}&cinvcode=${searchData.cinvcode}&cinvcode1=${searchData.cinvcode1}&cinvname1=${searchData.cinvname1}`
            :Api+`admin/schedudemandplan/getDemandList?startdate=&enddate=&cvenname=&cinvcode=&cinvcode1=&cinvname1=`
        spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
        //期初数量
        parms.activeSheet.getCell(3,9).text("期初数量");
        LayerMsgBox.loading("正在获取最新数据...",20000);
        $.ajax({
            url,
            type:'get',
            dataType:'json',
            success:function (respons){
                parms['scheduplanmonth'] = respons;
                console.log(parms['scheduplanmonth'])
                spreadSuspend();//暂停绘制
                if(respons.state=='ok'){
                    LayerMsgBox.closeLoading();
                    let rowIndex = 4;
                    let colIndex=0;
                    let serialCol = 1;
                    for (let i = 0; i <parms['scheduplanmonth'].data.length; i++) {
                        var cellType = new GC.Spread.Sheets.CellTypes.CheckBox();//定义多选按钮
                        parms.activeSheet.getCell(rowIndex, colIndex).cellType(cellType);
                        sheet.addSpan(rowIndex,colIndex,3,1);
                        //序号
                        sheet.setValue(rowIndex, serialCol,parms['scheduplanmonth'].data[i].seq);
                        parms.activeSheet.addSpan(rowIndex,serialCol,3,1);
                        //供应商名称
                        sheet.setValue(rowIndex, serialCol+1,parms['scheduplanmonth'].data[i].cVenName);
                        sheet.getCell(rowIndex, serialCol+1).wordWrap(true);
                        parms.activeSheet.addSpan(rowIndex,serialCol+1,3,1);
                        //存货编码
                        sheet.setValue(rowIndex, serialCol+2,parms['scheduplanmonth'].data[i].cInvCode);
                        sheet.getCell(rowIndex, serialCol+2).wordWrap(true);
                        parms.activeSheet.addSpan(rowIndex,serialCol+2,3,1);
                        //客户部番
                        sheet.setValue(rowIndex, serialCol+3,parms['scheduplanmonth'].data[i].cInvCode1);
                        parms.activeSheet.addSpan(rowIndex,serialCol+3,3,1);
                        sheet.getCell(rowIndex, serialCol+3).wordWrap(true);
                        parms.activeSheet.setColumnWidth(serialCol+3, 100);//设置指定单元格的width
                        //部品名称
                        sheet.setValue(rowIndex, serialCol+4,parms['scheduplanmonth'].data[i].cInvName1);
                        sheet.getCell(rowIndex, serialCol+4).wordWrap(true);
                        parms.activeSheet.addSpan(rowIndex,serialCol+4,3,1);
                        parms.activeSheet.setColumnWidth(serialCol+4, 180);//设置指定单元格的width
                        //包装数量
                        sheet.setValue(rowIndex, serialCol+5,parms['scheduplanmonth'].data[i].iPkgQty);
                        sheet.getCell(rowIndex, serialCol+5).wordWrap(true);
                        parms.activeSheet.addSpan(rowIndex,serialCol+5,3,1);
                        //标准在库天数
                        sheet.setValue(rowIndex, serialCol+6,parms['scheduplanmonth'].data[i].iInnerInStockDays);
                        parms.activeSheet.addSpan(rowIndex,serialCol+6,3,1);
                        parms.activeSheet.setColumnWidth(serialCol+6, 120);//设置指定单元格的width
                        rowIndex+=3;

                        parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex+1).text("实绩需求");
                        parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex+1).text("到货计划");
                        parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex+1).text("计划在库");
                        let shiyongRow = 4;//渲染起始行下标
                        let shiyongCol = 10;//渲染起始列下标
                        let B = 5;
                        let Z = 10;
                        let jihuaRow = 6;
                        let jihuaCol = 10;
                        for (var j = 0; j < parms['scheduplanmonth'].data[i].day.length; j++) {
                            if(i==0){
                                sheet.setValue(shiyongRow,shiyongCol+j,parseFloat(parms['scheduplanmonth'].data[i].day[j].xuqiu));
                                //控制小数位为1位
                                sheet.setFormatter(shiyongRow, shiyongCol+j,Number.isInteger(parseFloat(parms['scheduplanmonth'].data[i].day[j].xuqiu))?"0.00":"0.00");
                                sheet.setValue(shiyongRow+1,shiyongCol+j,parseFloat(parms['scheduplanmonth'].data[i].day[j].jihua));
                                sheet.setValue(shiyongRow+2,shiyongCol-1,parseFloat(parms['scheduplanmonth'].data[i].qiChuZaiKu));
                                sheet.setValue(shiyongRow+2,shiyongCol+j,parseFloat(parms['scheduplanmonth'].data[i].day[j].zaiku));
                                //
                                let col = 10;//公式嵌入起始列下标
                                let Num = sheet.getValue(6,9);//初次进入获取前一天的计划在库
                                let daoHuoShiJi = parms['scheduplanmonth'].data[i].day[j].shiji;//到货实绩
                                //前一天的到货差异
                                let daoHuoChaYi = parms['scheduplanmonth'].data[i].day[j].chayi==null||undefined?parms['scheduplanmonth'].data[i].qiChuChaYi:parms['scheduplanmonth'].data[i].day[j].chayi;
                                //嵌入计划在库公式
                                sheet.setFormula(jihuaRow,jihuaCol++,`=SUM(RC[-1]+${daoHuoShiJi}+${daoHuoChaYi})-R[-2]C`);
                                //嵌入到货计划公式
                                sheet.setFormula(B,Z++,`=IF(SUM(R[-1]C,R[-1]C[1],R[-1]C[2])-R[1]C[-1]>0,SUM(R[-1]C,R[-1]C[1],R[-1]C[2])-R[1]C[-1],0)`);
                            }else{
                                sheet.setValue(3*i+shiyongRow,shiyongCol+j,parseFloat(parms['scheduplanmonth'].data[i].day[j].xuqiu));
                                //控制小数位为1位
                                sheet.setFormatter(3*i+shiyongRow, shiyongCol+j,Number.isInteger(parseFloat(parms['scheduplanmonth'].data[i].day[j].xuqiu))?"0.00":"0.00");
                                sheet.setValue(3*i+shiyongRow+1,shiyongCol+j,parseFloat(parms['scheduplanmonth'].data[i].day[j].jihua));
                                sheet.setValue(3*i+shiyongRow+2,shiyongCol-1,parseFloat(parms['scheduplanmonth'].data[i].qiChuZaiKu));
                                sheet.setValue(3*i+shiyongRow+2,shiyongCol+j,parseFloat(parms['scheduplanmonth'].data[i].day[j].zaiku));
                                //
                                let Num = sheet.getValue(3*i+6,9);//获取前一天的计划在库
                                let daoHuoShiJi = parms['scheduplanmonth'].data[i].day[j].shiji;//到货实绩
                                //前一天的到货差异
                                let daoHuoChaYi = parms['scheduplanmonth'].data[i].day[j].chayi==null||undefined?parms['scheduplanmonth'].data[i].qiChuChaYi:parms['scheduplanmonth'].data[i].day[j].chayi
                                //嵌入计划在库公式
                                sheet.setFormula(3*i+jihuaRow,jihuaCol++,`=SUM(RC[-1]+${daoHuoShiJi}+${daoHuoChaYi})-R[-2]C`);
                                //嵌入到货计划公式
                                sheet.setFormula(3*i+B,Z++,`=IF(SUM(R[-1]C,R[-1]C[1],R[-1]C[2])-R[1]C[-1]>0,SUM(R[-1]C,R[-1]C[1],R[-1]C[2])-R[1]C[-1],0)`);
                            }
                        }
                    }
                }else{
                    LayerMsgBox.error(respons.msg,10000);
                }
                spreadResume();// 恢复绘制
            },error: function(error) {
                console.log(error);
            }
        })
        //避免重复请求数据
        if(parms.supplierData.length<=0){
            //渲染头部搜索区域供应商数据
            $.ajax({
                url:Api+"admin/schedudemandplan/getSupplierList",
                type:'get',
                dataType:'json',
                success:function (res){
                    parms.supplierData=res.data;
                    for (var i = 0; i < res.data.length; i++) {
                        var jsonObj = res.data[i];
                        $("#supplier_id").append(`
                    <li class="dropdown-item" id="li" onClick='supplierClick("${jsonObj.cvenname}")'
                     value='${jsonObj.cvenname}' style="display:flex;"><span style=flex:1;>
                     ${jsonObj.cvenname}
                     </span></li>`);
                    }
                },error: function(error) {
                    console.log(error,"预示保存弹出层");
                }
            })
        }
    }
    //获取表格中输入或修改的值
    sheet.bind(GC.Spread.Sheets.Events.ValueChanged, function (e, info) {
        let a = {
            text:info.newValue,
            row:info.row,
            col:info.col
        }
        //每次添加之后往数组内进行存储
        parms.tableData.push(a);
    });

    /*工作簿暂停活性*/
    function spreadSuspend() {
        spread.suspendPaint(); //渲染前失活(提升性能)
        spread.suspendCalcService(); //暂停计算服务
    }

    /*工作簿开启活性*/
    function spreadResume() {
        spread.resumeCalcService(); //开启计算服务
        spread.resumePaint(); //恢复绘制
    }

    /**
     * 表格数据导出
     * @param loadExcel 按钮节点
     */
    function loadExcel() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup").style.display = "block";
    };

    /**
     * 数据导出
     * @param excelFileSave
     */
    function excelFileSave() {
        var fileName = document.getElementById("input").value;//获取用户输入的表格导出名称
        if(fileName!=''){
            fileName += '.xlsx';
            var json = spread.toJSON();//转为json格式
            excelIo.save(json, function (blob) {
                saveAs(blob, fileName);//转成xlsx
            });
            hidePopup();
        }
    };
    /**
     * @param hidePopup 隐藏弹出层
     * @param overlay 遮罩层节点
     * @param hidePopuppopup 弹出层节点
     */
    function hidePopup() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("popup").style.display = "none";
    }

    /**
     * 搜索
     * @param search
     */
    var searchData={
        cworkname:'',
        cinvcode:'',
        cinvcode1:'',
        cinvname1:'',
        searchStartTime:'',
        searchEndTime:'',
    }
    function search(){
        const cinvcode = document.getElementById('cinvcode').value;
        const cinvcode1 = document.getElementById('cinvcode1').value;
        const cinvname1 = document.getElementById('cinvname1').value;
        const searchStartTime = document.getElementById('search_start-times').value;
        const searchEndTime = document.getElementById('search_end-time').value;
        searchData={
            cinvcode,
            cinvcode1,
            cinvname1,
            searchStartTime,
            searchEndTime
        }
        var json = sheet.toJSON();//储存表单数据
        sheet.fromJSON(json);//清空表单数据
        sheet.reset();//重置表单
        //从新赋值到原始渲染位置
        parms.planListRowIndex=4;
        parms.dayRow=10;
        parms.weekRow=10;
        initDate(searchData);
        loadInit();
        initData(searchData);
    }
    /**
     * 重置搜索内容事件
     * @param reset
     * */
    function reset(){
        document.getElementById('cinvcode').value='';
        document.getElementById('cinvcode1').value='';
        document.getElementById('cinvname1').value='';
        document.getElementById('search_start-times').value='';
        document.getElementById('search_end-time').value='';
    }
    /**
     * 打开计划生成弹出框事件
     * @param openModal
     */
    function openModal() {
        var modal = document.getElementById("modal");
        let url =Api+"admin/schedudemandplan/getSwitchDate";
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                console.log(res.data)
                const datetimeLocalInput = document.getElementById('datetime-locals');
                datetimeLocalInput.value = res.data;
            },error: function(error) {
                console.log(error);
            }
        })
        modal.style.display = "flex";
    }
    /**
     * 关闭计划生成弹出框事件
     * @param closeModal
     */
    function closeModal() {
        var modal = document.getElementById("modal");
        modal.style.display = "none";
    }
    /**
     * 计划生成弹出框确定按钮事件
     * @param confirmAction
     */
    function confirmAction() {
        const datetimeLocalInput = document.getElementById('datetime-locals');
        const myVal = datetimeLocalInput.value;
        console.log(myVal)
            let url =Api+"admin/schedudemandplan/apsScheduDemandPlan";
            LayerMsgBox.loading("正在获取最新数据...",20000);
            $.ajax({
                url,
                data:{
                    endDate:myVal
                },
                type:'post',
                dataType:'json',
                success:function (res){
                    if(res.data.msg=="操作成功"){
                        LayerMsgBox.closeLoading();
                        var json = sheet.toJSON();//储存表单数据
                        sheet.fromJSON(json);//清空表单数据
                        sheet.reset();//重置表单
                        //从新赋值到原始渲染位置
                        parms.planListRowIndex=4;
                        parms.dayRow=10;
                        parms.weekRow=10;
                        loadInit();
                        initDate();
                        initData();
                        closeModal();
                    }else{
                        LayerMsgBox.error("请选择截止日期",2000);
                    }
                },error: function(error) {
                    console.log(error);
                }
            })
    }

    var myIndicate = document.getElementById("indicate_Mode");
    var save = document.getElementById("indicate_save");
    var closeNdicate = document.getElementById("close_indicate");
    var closeIndicate = document.getElementById("close_indicate_but");
    var indicateTitle = document.getElementById("indicate_title");
    //预示保存弹出层
    save.onclick = function() {
        //防止出现多个弹框
        if(myAlert.style.display !== "block"){
            let startTime = document.getElementById('start-time').value;//获取开始时间
            let endTime = document.getElementById('end-time').value;//获取结束时间
            parms.supplierValueArray.length=0;
            document.getElementById('overlay').style.display = 'block';
            myIndicate.style.display = "block";
            myIndicate.style.position = "absolute";
            indicateTitle.innerText = '保存确认';
            myIndicate.style.borderRadius = '5px'
            myIndicate.style.top = "50%";
            myIndicate.style.left = "50%";
            myIndicate.style.marginTop = "-75px";
            myIndicate.style.marginLeft = "-150px";
            mybg = document.createElement("div");
            mybg.setAttribute("id", "mybg");
            mybg.style.background = "#000";
            mybg.style.width = "100%";
            mybg.style.height = "100%";
            mybg.style.position = "absolute";
            mybg.style.top = "0";
            mybg.style.left = "0";
            mybg.style.zIndex = "500";
            mybg.style.opacity = "0.3";
            document.body.appendChild(mybg);
            document.body.style.overflow = "hidden";

            for (var i = 0; i < parms.supplierData.length; i++) {
                var jsonObj = parms.supplierData[i];
                $("#project_id").append(`
                    <li class="dropdown-item"  onClick='supplierChange("${jsonObj.cvenname}","${jsonObj.iautoid}")'
                     value='${jsonObj.cvenname}' style="display:flex;"><span style=flex:1;>${jsonObj.cvenname}</span></li>`);
            }

        }
    }

    //
    /**
     * 预示保存确定按钮事件
     * @param indicateSave
     */
    function indicateSave(){
        let startTime = document.getElementById('start-time').value.substring(0,10);//获取开始时间
        let endTime = document.getElementById('end-time').value.substring(0,10);//获取结束时间
        if(startTime!=""&&endTime!=""){
            if(parms.supplierValueArray.length!=0){
                let url = Api+`admin/schedudemandplan/saveForetell?startdate=${startTime}&enddate=${endTime}&data=${JSON.stringify(parms.supplierValueArray)}`
                $.ajax({
                    url,
                    type: 'get',
                    dataType: 'json',
                    success: function(res){
                        console.log(res)
                        myIndicate.style.display = "none";
                        document.getElementById('overlay').style.display = 'none';
                        startTime="";
                        endTime="";
                        parms.supplierValueArray.length=0;
                    },error: function(error) {
                        console.log(error);
                    }
                })
            }
        }
    }
    //弹出层关闭事件
    closeNdicate.onclick = function(){
        myIndicate.style.display = "none";
        document.getElementById('overlay').style.display = 'none';
    }
    //取消按钮事件
    closeIndicate.onclick = function(){
        myIndicate.style.display = "none";
        document.getElementById('overlay').style.display = 'none';
    }

    /**
     * 获取当前点击的供应商
     * @param supplierClick
     * @param item 当前点击选中的供应商名称
     */
    function supplierClick(item) {
        let supplierValue = document.all['supplier'];
        supplierValue.innerText = item;
        parms.searchSupplier=item;
    }
    /**
     * 全选按钮事件
     * @param checkAll
     */
    function checkAll(){
        //获取id的dom元素
        let Id = document.getElementById('all');
        parms.supplierValueArray.length=0;
        if(Id.checked==true){
            for (let i = 0; i < parms.supplierData.length; i++) {
                parms.supplierValueArray.push(parms.supplierData[i].iautoid)
            }
            console.log(parms.supplierValueArray);
        }else{
            parms.supplierValueArray.length=0;
            console.log(parms.supplierValueArray);
        }
    }
    //
    /**
     * 存储用户点击选中的供应商
     * @param supplierChange
     * @param item 当前点击选中的供应商
     * @param id id
     */
    function supplierChange(item,id) {
        let supplierValue = document.all['col'];
        supplierValue.innerText = item;
        let index = parms.supplierValueArray.findIndex(v => v==id);
        if (index == -1) {
            parms.supplierValueArray.push(id);
        }
    }
</script>
#end
