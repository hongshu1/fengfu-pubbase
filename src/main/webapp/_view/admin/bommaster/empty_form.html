<form onsubmit="return false;" id="BomMaster_Form" action="#(action)" method="post">
    #if(bomMaster.iAutoId??)
    <input type="hidden" name="iAutoId" value="#(bomMaster.iAutoId??)" />
    #end
    <table class="jbolt_table thead_font_normal table-center" data-width="1200px" data-height="300px"
           data-jbolttable>
        <thead>
        <tr>
            <th data-width="200" data-column="iEquipmentModelName" class="is_required">机型</th>
            <th data-width="150" data-column="cDocName" class="is_required">文件名称</th>
            <th data-width="120" data-column="cDocCode" class="is_required">文件编码</th>
            <th data-width="100" data-column="cBomVersion" class="is_required">版本/版次</th>
            <th data-width="120" data-column="dEnableDate" class="is_required">启用日期</th>
            <th data-width="120" data-column="dDisableDate" class="is_required"> 停用日期</th>
        </thead>
        <tbody>
            <tr>
                <td>
                    <input hidden id="iEquipmentModelId" name="iEquipmentModelId" data-sync-attr="iautoid" value="">
                    <input type="text"
                           data-autocomplete
                           data-rule="required"
                           data-tips="请选择存货编码"
                           autocomplete="off"
                           class="form-control"
                           placeholder="请选择存货编码"
                           maxlength="40"
                           data-url="admin/bommaster/findEquipmentModelAll"
                           data-sync-ele="#iEquipmentModelId"
                           data-text-attr="cequipmentmodelname"
                           data-column-attr="cequipmentmodelname,cequipmentmodelcode"
                    />
                </td>
                <td>
                    <input type="text" autocomplete="off" data-rule="required" class="form-control"  placeholder="输入文件名称" name="cDocName" value="" />
                </td>
                <td>
                    <input type="text" autocomplete="off" data-rule="required" class="form-control"  placeholder="输入文件编码" name="cDocCode" value="" />
                </td>
                <td>
                    <input type="text" autocomplete="off"  class="form-control" data-rule="required"  placeholder="输入版本/版次" name="cBomVersion" value="" />
                </td>
                <td>
                    <input type="text" class="form-control" id="dEnableDate" data-rule="required"  data-date name="dEnableDate" value="#date(DateUtil.toDate(startDate??),'yyyy-MM-dd')">
                </td>
                <td>
                    <input type="text" class="form-control" id="dDisableDate" data-rule="required;>=#dEnableDate" data-done-handler="checkme" data-date name="dDisableDate" value="#date(DateUtil.toDate(endDate??),'yyyy-MM-dd')">
                </td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 50px;">
        <div style="float: left; width: 150px; margin-bottom: 20px">
            <img src="assets/img/defaultposter.jpg" data-target="parent" data-photobtn class="m-1" style="height: 100px" tooltip data-title="点击查看大图" />
        </div>
        <div style="float: left; margin-left: 5px">
            <table class="jbolt_table thead_font_normal table-center thead_font_normal" data-width="auto" height="100px" data-height="300px"
                   data-jbolttable>
                <thead>
                <tr>
                    <th  data-width="70" data-column="cNo1">NO</th>
                    <th  data-width="150" data-column="version" class="is_required">存货编码</th>
                    <th  data-width="120" data-column="publish_time">客户部番</th>
                    <th  data-width="100" data-column="create_time">重量（KG）</th>
                    <th  data-width="120" data-column="version">设变号</th>
                    <th  data-width="120" data-column="version">设变日期</th>
                    <th  data-width="70" data-column="cNo2">NO</th>
                    <th  data-width="120" data-column="create_time">UG部番</th>
                    <th  data-width="100" data-column="create_time">重量（KG）</th>
                    <th  data-width="120" data-column="version">设变号</th>
                    <th  data-width="120" data-column="version">设变日期</th>
                </thead>
                <tbody>
                <tr>
                    <td><input autocomplete="off" class="form-control" name="cNo1" value=""></td>
                    <td>
                        <input type="text" name="iInventoryId" hidden data-sync-attr="itemid" id="iBeforeInveId"  data-notnull="true" data-tips="请输入转换前存货ID"  data-with-clearbtn="true" autocomplete="off"  class="form-control" placeholder="请输入转换前存货ID" maxlength="40" />
                        <input type="text"
                               data-autocomplete
                               data-rule="required"
                               data-tips="请选择存货编码"
                               autocomplete="off"
                               class="form-control"
                               placeholder="请选择存货编码"
                               maxlength="40"
                               data-link-para-ele="#iEquipmentModelId"
                               data-url="admin/bommaster/inventoryAutocomplete"
                               data-sync-ele="#beforeInvCode,#Weight,#iBeforeInveId"
                               data-text-attr="cinvcode"
                               data-column-attr="cinvcode"
                        />
                    </td>
                    <td>
                        <input id="beforeInvCode" type="text"    data-notnull="true" data-sync-attr="cinvcode1"   data-with-clearbtn="true" autocomplete="off"  class="form-control" disabled/>
                    </td>
                    <td>
                        <input id="Weight" type="text"   value="" data-notnull="true" data-sync-attr="iweight"   data-with-clearbtn="true" autocomplete="off"  class="form-control" disabled/>
                    </td>
                    <td>
                        <input type="text" autocomplete="off"  class="form-control"  placeholder="输入设变号" name="cDcNo1" value="" />
                    </td>
                    <td>
                        <input type="text" class="form-control"  data-date name="dDcDate1" value="#date(DateUtil.toDate(startDate??),'yyyy-MM-dd')">
                    </td>
                    <td>
                    <input autocomplete="off" class="form-control" name="cNo1" value="">
                    </td>
                    <td>
                        <input  type="text"   value="" data-notnull="true" data-sync-attr="iweight"   data-with-clearbtn="true" autocomplete="off"  class="form-control" disabled/>
                    </td>
                    <td>
                        <input type="text"   value="" data-notnull="true" data-sync-attr="iweight"   data-with-clearbtn="true" autocomplete="off"  class="form-control" disabled/>
                    </td>
                    <td>
                        <input type="text" autocomplete="off"  class="form-control"  placeholder="输入设变号" name="dDcDate2" value="" />
                    </td>
                    <td>
                        <input type="text" class="form-control"  data-date name="startDate" value="#date(DateUtil.toDate(startDate??),'yyyy-MM-dd')">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="form-group row" style="clear: both;margin-top: 30px;">
        <label class="col-2 col-form-label" style="margin-left: -200px">客户名称：</label>
        <div class="col-2">
            <select class="form-control" data-url="admin/dictionary/options?key=ccurrency" name="iCustomerId" data-autoload
                    data-text="=请选择=" data-value-attr="sn" data-value="" data-select="#(vendor.cCurrency??)"></select>
        </div>
        <label class="col-2 col-form-label">备注共用件：</label>
        <div class="col-2">
            <input type="text" autocomplete="off" class="form-control" data-tips="备注共用件" maxlength="40" name="cCommonPartMemo" value="">
        </div>
    </div>


</form>
<script type="text/template" id="bomMaster_demotpl_#(pageId)">
    {@each datas as data,index}
    <tr data-id="${data.id}">
        <td></td>
        <td>
          <input autocomplete="off" class="form-control" data-maxsize="2" name="code1" value="">
        </td>
        <td>
            <input  autocomplete="off" class="form-control" data-maxsize="5" name="code2" value="">
        </td>
        <td>
            <input  autocomplete="off" class="form-control" name="code3" value="">
        </td>
        <td>
            <input  autocomplete="off" class="form-control" name="code4" value="">
        </td>
        <td>
            <input  autocomplete="off" class="form-control" name="code5" value="">
        </td>
        <td>
            <input  autocomplete="off" class="form-control" name="code6" value="">
        </td>
        <td>
            <input type="text" hidden data-sync-attr="itemid" id="iBeforeInventoryId${data.index}" data-tips="部品" data-notnull="true" data-with-clearbtn="true" autocomplete="off"  class="form-control" maxlength="40" name="invItemId" value=""/>
            <input type="text"
                   id="invItemId${data.index}"
                   data-rule="required"
                   data-autocomplete
                   data-notnull="true"
                   data-tips="请选择存货编码"
                   data-with-clearbtn="true"
                   autocomplete="off"
                   class="form-control"
                   placeholder="请选择存货编码"
                   maxlength="40"
                   data-url="admin/bommaster/inventoryAutocomplete"
                   data-sync-ele="#cInvCode${data.index},#iWeight${data.index},#iBeforeInventoryId${data.index},#cInvName${data.index},#cInvAddName${data.index},#cInvAddCode${data.index},#InvName${data.index}"
                   data-text-attr="cinvcode"
                   data-column-attr="cinvcode"
            />
            <div style="margin-top: 10px"></div>
            <input id="cInvName${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvname"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input id="cInvCode${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvcode1"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
            <div style="margin-top: 10px"></div>
            <input id="cInvAddName${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvname1"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input id="cInvAddCode${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvaddcode1"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
            <div style="margin-top: 10px"></div>
            <input id="InvName${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvname2"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>

        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true" maxlength="10" name="invQty" value="">
            <div style="margin-top: 10px"></div>
            <input id="iWeight${data.index}" type="text" data-notnull="true" data-sync-attr="iweight"  data-with-clearbtn="true" autocomplete="off"  class="form-control" name="weight" value="" readonly/>
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" disabled>
            <div style="margin-top: 10px"></div>
            <input type="text" autocomplete="off"  class="form-control" disabled>
        </td>
        <td>
            <input name="iRawType" type="text"   value="" data-notnull="true"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input type="text" hidden data-sync-attr="itemid" id="originalInvId${data.index}" data-tips="卷料" value="" data-notnull="true"  data-with-clearbtn="true" autocomplete="off"  class="form-control" maxlength="40" name="originalItemId"/>
            <input type="text" id="originalItemId${data.index}"
                   data-rule="required"
                   data-autocomplete
                   data-notnull="true"
                   data-tips="请选择存货编码"
                   data-with-clearbtn="true"
                   autocomplete="off"
                   class="form-control"
                   placeholder="请选择存货编码"
                   maxlength="40"
                   data-url="admin/bommaster/inventoryAutocomplete"
                   data-sync-ele="#originalInvId${data.index},#originalInvName${data.index},#originalInvStd${data.index}"
                   data-text-attr="cinvcode"
                   data-column-attr="cinvcode"
            />
            <div style="margin-top: 10px"></div>
            <input id="originalInvName${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvname"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input id="originalInvSup${data.index}" type="text"   value="" data-notnull="true"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
            <div style="margin-top: 10px"></div>
            <input id="originalInvStd${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvstd"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true" maxlength="10" name="originalQty" value="">
            <div style="margin-top: 10px"></div>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true" maxlength="10" name="originalWeight" value="">
        </td>
        <td>
            <input type="text" hidden data-sync-attr="itemid" id="slicingInvId${data.index}"  data-notnull="true"  data-with-clearbtn="true" autocomplete="off"  class="form-control"  maxlength="40" data-tips="分条料" name="slicingInvItemId" value=""/>
            <input type="text"
                   id="slicingItemId${data.index}"
                   data-autocomplete
                   data-notnull="true"
                   data-tips="请选择存货编码"
                   data-with-clearbtn="true"
                   autocomplete="off"
                   class="form-control"
                   placeholder="请选择存货编码"
                   maxlength="40"
                   data-url="admin/bommaster/inventoryAutocomplete"
                   data-sync-ele="#slicingInvId${data.index},#slicingInvName${data.index},#slicingInvStd${data.index}"
                   data-text-attr="cinvcode"
                   data-column-attr="cinvcode"
            />
            <div style="margin-top: 10px"></div>
            <input id="slicingInvName${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvname"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input id="slicingInvSup${data.index}" type="text"   value="" data-notnull="true"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
            <div style="margin-top: 10px"></div>

            <input id="slicingInvStd${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvstd"   data-with-clearbtn="true" autocomplete="off"  class="form-control" readonly/>
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true"  maxlength="10" name="slicingQty" value="">
            <div style="margin-top: 10px"></div>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true" maxlength="10" name="slicingWeight" value="">
        </td>
        <td>
            <input type="text" hidden data-sync-attr="itemid" id="blankingInvId${data.index}"  data-notnull="true" data-with-clearbtn="true" autocomplete="off"  class="form-control"  data-tips="片料" maxlength="40" name="blankingItemId"/>
            <input type="text"
                   id="blankingItemId${data.index}"
                   data-rule="required"
                   data-autocomplete
                   data-notnull="true"
                   data-tips="请选择存货编码"
                   data-with-clearbtn="true"
                   autocomplete="off"
                   class="form-control"
                   placeholder="请选择存货编码"
                   maxlength="40"
                   data-url="admin/bommaster/inventoryAutocomplete"
                   data-sync-ele="#blankingInvId${data.index},#blankingInvName${data.index},#blankingStd${data.index},#blankingInvName${data.index}"
                   data-text-attr="cinvcode"
                   data-column-attr="cinvcode"
            />
            <div style="margin-top: 10px"></div>
            <input id="blankingInvName${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvname"  autocomplete="off"  class="form-control" disabled/>
        </td>
        <td>
            <input id="blankingSup${data.index}" type="text"   value="" data-notnull="true"   data-with-clearbtn="true" autocomplete="off"  class="form-control" disabled/>
            <div style="margin-top: 10px"></div>
            <input id="blankingStd${data.index}" type="text"   value="" data-notnull="true" data-sync-attr="cinvstd"   data-with-clearbtn="true" autocomplete="off"  class="form-control" disabled/>
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true" name="blankingQty"  value="" maxlength="10"/>
            <div style="margin-top: 10px"></div>
            <input type="text" autocomplete="off"  class="form-control" data-rule="number"  data-notnull="true" name="blankingWeight" value="" maxlength="10"/>
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" name="iVendorId" value="">
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" name="isOutSourced" value="">
        </td>
        <td>
            <input type="text" autocomplete="off"  class="form-control" name="cMemo" value="">
        </td>
        <td>
            <a tabindex="-1"  href="javascript:void(0)" tooltip data-title="插入一行"  onclick="InsertEmptyRow(this)"><i class="fa fa-plus"></i></a>
            <a tabindex="-1" class="ml-1" href="javascript:void(0)" tooltip data-title="移除此行" onclick="jboltTableRemoveRow(this)" ><i class="fa fa-trash"></i></a>
            <a tooltip data-title="上移"  href="javascript:void(0)" onclick="jboltTableTrMoveUp(this)"   class="jbolt_table_btn"><i class="fa fa-arrow-up c-info"></i></a>
            <a tooltip data-title="下移"  href="javascript:void(0)" onclick="jboltTableTrMoveDown(this)"  class="jbolt_table_btn"><i class="fa fa-arrow-down c-info"></i></a>
        </td>
    </tr>
    {@/each}
</script>

<div class="jbolt_table_toolbar" id="bomMaster_toolbar_#(pageId)">
    <div class="btn-group btn-group-sm" role="group" aria-label="btn-group">
        <button onclick="testJboltTableInsertRow(this)" class="btn btn-primary btn-sm" ><i class="fa fa-plus"></i> 新增</button>
        <button onclick="jboltTableRemoveCheckedRow(this,true,false)" class="btn btn-danger btn-sm"><i class="fa fa-trash"></i> 删除</button>
        <button onclick="jboltTableRefresh(this,'刷新会丢失新添加未保存的数据，确认刷新吗？')" class="btn btn-success btn-sm"><i class="fa fa-refresh"></i> 刷新</button>
        <button onclick="jboltTableMaximize(this)" class="btn btn-info btn-sm"><i class="fa fa-window-maximize"></i> 最大化</button>
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="btn-group">
        <button onclick="insertPrependEmptyRow(this)" class="btn btn-primary btn-sm" ><i class="fa fa-arrow-up"></i> 首插空</button>
        <button onclick="insertEmptyRowBeforeChecked(this)" class="btn btn-primary btn-sm" ><i class="fa fa-arrow-left"></i> 前插空</button>
        <button onclick="insertEmptyRowAfterChecked(this)" class="btn btn-primary btn-sm" >后插空 <i class="fa fa-arrow-right"></i></button>
        <button onclick="insertAppendEmptyRow(this)" class="btn btn-primary btn-sm" >尾插空 <i class="fa fa-arrow-down"></i></button>
    </div>
</div>
<table class="jbolt_table jbolt_main_table table-center thead_font_normal"
       data-jbolttable
       data-width="auto"
       data-height="fill"
       data-column-resize="true"
       data-column-prepend="1:checkbox"
       data-toolbar="bomMaster_toolbar_#(pageId)"
       data-editable="true"
       data-tfoot-fixed="true"
       id="bomMaster_#(pageId)"
       data-rowtpl="bomMaster_demotpl_#(pageId)"
       data-editable-option="getEditableTableOptions_#(pageId)"
>
    <thead>
    <tr>
        <th rowspan="2" data-column="index">序号</th>
        <th  colspan="6" data-width="420">编号</th>
        <th  rowspan="1" data-width="150">存货编码</th>
        <th  rowspan="1" data-width="150">客户部番</th>
        <th  rowspan="1" data-width="150">UG部番</th>
        <th  rowspan="2" data-width="150">略图</th>
        <th  rowspan="1" data-width="120">QTY</th>
        <th  rowspan="1" data-width="150">材质</th>
        <th  rowspan="2" data-width="150">材料类别</th>
        <th  rowspan="1" data-width="150">原材料存货编码</th>
        <th  rowspan="1" data-width="150">原材料供应商</th>
        <th  rowspan="1" data-width="120">可制件数</th>
        <th  rowspan="1" data-width="150">分条存货编码</th>
        <th  rowspan="1" data-width="150">分条商</th>
        <th  rowspan="1" data-width="120">可制件数</th>
        <th  rowspan="1" data-width="150">落料存货编码</th>
        <th  rowspan="1" data-width="150">落料商</th>
        <th  rowspan="1" data-width="120">可制件数</th>
        <th  rowspan="2" data-width="150">部品加工商</th>
        <th  rowspan="2" data-width="120">是否外作</th>
        <th  rowspan="2" data-width="120">备注</th>
        <th  rowspan="2" data-width="150">操作</th>
    </tr>
    <tr>
        <th data-width="70" data-column="code1">1</th>
        <th data-width="80" data-column="code2">2</th>
        <th data-column="code3">3</th>
        <th data-column="code4">4</th>
        <th data-column="code5">5</th>
        <th data-column="code6">6</th>
        <th rowspan="1" data-width="150">存货名称</th>
        <th rowspan="1" data-width="150">部品名称</th>
        <th rowspan="1" data-width="150">UG部品名称</th>
        <th rowspan="1" data-width="120">重量</th>
        <th rowspan="1" data-width="120">厚度</th>
        <th rowspan="1" data-width="150">原材料存货名称</th>
        <th rowspan="1" data-width="150">原材料规格</th>
        <th rowspan="1" data-width="120">重量</th>
        <th rowspan="1" data-width="150">分条存货名称</th>
        <th rowspan="1" data-width="150">分条规格</th>
        <th rowspan="1" data-width="120">重量</th>
        <th rowspan="1" data-width="150">落料存货名称</th>
        <th rowspan="1" data-width="150">下料尺寸</th>
        <th rowspan="1" data-width="120">重量</th>
    </tr>

    </thead>
    <tbody>

    </tbody>
</table>
#define js()
<script>
    var index = 0;
    function getEditableTableOptions_#(pageId)(){
        var editableTableOptions={
            trigger:"click",
            //初始行数
            initRowCount:0,
            //限制最大数 默认30
            // submit:{
            //     withForm:["BomMaster_Form_#(pageId)"],
            //     type:"all",//cell|all
            //     //params:{"orderId":3},//携带其他额外参数
            //     //commonAttr:{"save":{"update_time":new Date().getTime(),"autoId":1}},//给save或者update的时候 表格每一行数据 都添加指定的属性一并提交
            //     url:"demo/demotable/submit",
            //     success:function(res){
            //         LayerMsgBox.success("提交成功",600,function(){
            //             refreshPjaxContainer();
            //         });
            //     }
            // },
            //插入数据时默认属性值
            //insertDefaultValues:{age:10,briefInfo:"xxxxx"},
            cols:{
                id:{
                    submitAttr:"id",
                },
                index:{
                    submitAttr: "index"
                }
            }
        };
        return editableTableOptions;
    }
    function testJboltTableInsertRow(ele,forceTrChange) {
        var table=getJBoltTable(ele);
        if(isOk(table)){
            index+=1;
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var action=getRealJqueryObject(ele),tr;
                if(isOk(action)){
                    var success = checkMasterTableId(action);
                    if(!success){
                        return false;
                    }
                    //如果是在表格里触发的
                    if(isOk(action.closest("table[data-jbolttable]"))){
                        tr = action.closest("tr");
                    }else if(isOk(action.closest(".jbolt_table_fixed"))){
                        var fixtr = action.closest("tr");
                        var fixTrIndex = fixtr.index();
                        tr=jboltTable.tbody.find("tr:nth-child("+(fixTrIndex+1)+")");
                    }
                }
                ;
                return insertRows(jboltTable,tr,{index: index},true,forceTrChange);
            }
        }
    }

    function insertPrependEmptyRow(ele,forceTrChange){
        var table=getJBoltTable(ele);
        if(isOk(table)){
            index+=1;
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var action=getRealJqueryObject(ele);
                if(isOk(action)){
                    var success = checkMasterTableId(action);
                    if(!success){
                        return false;
                    }
                }
                if(!jboltTable.isEmpty){
                    var tr=jboltTable.tbody.find("tr:first");
                    if(isOk(tr)){
                        return insertRows(jboltTable,tr,{index: index},true,forceTrChange);
                    }
                }
                return insertRows(jboltTable,null,null,false,forceTrChange);
            }
        }
        LayerMsgBox.alert("表格组件配置异常",2);
        return false;
    }

    function insertEmptyRowBeforeChecked(ele,forceTrChange){
        var table=getJBoltTable(ele);
        if(isOk(table)){
            index+=1;
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var tr=jboltTable.me.getCheckedTr(jboltTable);
                if(isOk(tr)){
                    var action=getRealJqueryObject(ele);
                    if(isOk(action)){
                        var success = checkMasterTableId(action);
                        if(!success){
                            return false;
                        }
                    }
                    return insertRows(jboltTable,tr,{index: index},true,forceTrChange);
                }
                return false;
            }
        }
        LayerMsgBox.alert("表格组件配置异常",2);
        return false;
    }

    function insertEmptyRowAfterChecked(ele,forceTrChange){
        var table=getJBoltTable(ele);
        if(isOk(table)){
            index+=1;
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var tr=jboltTable.me.getCheckedTr(jboltTable);
                if(isOk(tr)){
                    var action=getRealJqueryObject(ele);
                    if(isOk(action)){
                        var success = checkMasterTableId(action);
                        if(!success){
                            return false;
                        }
                    }
                    return insertRows(jboltTable,tr,{index: index},false,forceTrChange);
                }
                return false;
            }
        }
        LayerMsgBox.alert("表格组件配置异常",2);
        return false;
    }

    function insertAppendEmptyRow(ele,forceTrChange){
        var table=getJBoltTable(ele);
        if(isOk(table)){
            index+=1;
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var action=getRealJqueryObject(ele);
                if(isOk(action)){
                    var success = checkMasterTableId(action);
                    if(!success){
                        return false;
                    }
                }
                if(!jboltTable.isEmpty){
                    var tr=jboltTable.tbody.find("tr:last");
                    if(isOk(tr)){
                        return insertRows(jboltTable,tr,{index: index},false,forceTrChange);
                    }
                }
                return insertRows(jboltTable,null,{index: index},false,forceTrChange);
            }
        }
        LayerMsgBox.alert("表格组件配置异常",2);
        return false;
    }

    function InsertEmptyRow(ele,forceTrChange){
        var table=getJBoltTable(ele);
        if(isOk(table)){
            index+=1;
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var action=getRealJqueryObject(ele),tr;
                if(isOk(action)){
                    var success = checkMasterTableId(action);
                    if(!success){
                        return false;
                    }
                    //如果是在表格里触发的
                    if(isOk(action.closest("table[data-jbolttable]"))){
                        tr = action.closest("tr");
                    }else if(isOk(action.closest(".jbolt_table_fixed"))){
                        var fixtr = action.closest("tr");
                        var fixTrIndex = fixtr.index();
                        tr=jboltTable.tbody.find("tr:nth-child("+(fixTrIndex+1)+")");
                    }
                }
                return insertRows(jboltTable,tr,{index: index},false,forceTrChange);;
            }
        }
        LayerMsgBox.alert("表格组件配置异常",2);
        return false;
    }

    function insertRows(table,tr,insertEmptyData,insertToBefore,forceTrChange){
        var canInsertTr=table.me.checkCanInsertNewTr(table,1);
        if(canInsertTr){
            //处理thead里的checkbox uncheck
            table.me.processUnCheckTheadCheckbox(table);

            var insertDefaultValues=table.editableOptions.insertDefaultValues;
            if(insertDefaultValues){
                insertEmptyData=table.me.deepClone(insertDefaultValues);
            }
            var tempTr=table.me.insertRowData(table,tr,insertEmptyData,false,insertToBefore);
            if(isOk(tempTr)){
                table.me.processTableIndexColumn(table);
                table.me.processInsertRowTableListData(table,tempTr,insertEmptyData,insertToBefore);
                table.me.initEditableHSummarys(table,tempTr);
                table.me.processTfootSummarys(table);
                //处理change状态
                table.me.processNewInsertTrEditableTdsChanged(table,tempTr,insertEmptyData,forceTrChange);
                //处理新插入的行重新设置宽度
                table.me.resizeTrByOldWidth(table,tempTr);
                //处理动态插入数据后的handler
                table.me.processEditableTableAfterInsertRowHandler(table,tempTr);
            }
            return tempTr;
        }
        return false;
    }

    // 隐藏第一个按钮
    hideParentLayerDialogBtn(0);
    addParentLayerDialogBtn("保存","lay_success",function(){
        if (!FormChecker.check("#BomMaster_Form")){
            return;
        }
        var jboltTableAllDatas = getJboltTableAllDatas("#bomMaster_#(pageId)");
        if (!jboltTableAllDatas || jboltTableAllDatas.length ==0){
            LayerMsgBox.alert("表格数据不能为空",2);
            return;
        }
        var flag;
        var tableData = getTableData();
        var formData = formToJson('#BomMaster_Form');
        tableData.forEach(function (item, index,value) {
            // 报错返回false
            flag = verification(item, formData);
            if (!flag){
               throw new Error("跳出循环");
            }
        })

        if (flag){
            console.log('formData:' + formData)
            console.log('tableData:'+ tableData)
            Ajax.post('/admin/bommaster/submitForm', {
                formJsonData: JSON.stringify(formData),
                tableJsonData: JSON.stringify(tableData)
            }, function (ret) {
                LayerMsgBox.close(index);

                if (ret.state === 'ok') {
                    LayerMsgBox.success(ret.msg, 1000, function () {
                    });
                } else {
                    LayerMsgBox.alert(ret.msg, 2);
                }
            });
        }
    });
    function verification(item, formData) {
        // 部品
        var invItemId = item.invItemId;
        // 卷料
        var originalItemId = item.originalItemId;
        // 分条料
        var slicingInvItemId = item.slicingInvItemId;
        // 片料
        var blankingItemId = item.blankingItemId;

        var inventoryId = formData.iInventoryId;

        // 获取编码栏是否为空
        var flag = (!item.code1 && !item.code2 && !item.code3 && !item.code4 && !item.code5 && !item.code6);
        // 判断存货编码栏不为空时，编码栏也不能为空
        if (flag && (invItemId || originalItemId || slicingInvItemId || blankingItemId)){
            LayerMsgBox.alert("已选择存货编码，编号不能为空",2);
            return false;
        }

        var count = 0;
        if (item.code1){
            count+=1
        }
        if (item.code2){
            count+=1
        }
        if (item.code3){
            count+=1
        }
        if (item.code4){
            count+=1
        }
        if (item.code5){
            count+=1
        }
        if (item.code6){
            count+=1
        }
        if (count > 1){
            LayerMsgBox.alert("编号栏只能填写一列",2);
            return false;
        }

        // 校验成品存货不能跟部品，卷料，分条料，落料一致
        if (invItemId == inventoryId){
            LayerMsgBox.alert("部品存货不能跟成品存货选择一致",2);
            return false;
        }

        if (originalItemId == inventoryId){
            LayerMsgBox.alert("卷料（原材料）存货不能跟成品存货选择一致",2);
            return false;
        }

        if (slicingInvItemId == inventoryId){
            LayerMsgBox.alert("分条料存货不能跟成品存货选择一致",2);
            return false;
        }

        if (blankingItemId == inventoryId){
            LayerMsgBox.alert("片料（落料）存货不能跟成品存货选择一致",2);
            return false;
        }


        // 校验部品存货是否存在一致
        if (invItemId && invItemId == originalItemId){
            LayerMsgBox.alert("部品存货不能跟卷料（原材料）存货选择一致",2);
            return false;
        }
        if (invItemId && invItemId == slicingInvItemId){
            LayerMsgBox.alert("部品存货不能跟分条料存货选择一致",2);
            return false;
        }
        if (invItemId && invItemId == blankingItemId){
            LayerMsgBox.alert("部品存货不能跟片料（落料）存货选择一致",2);
            return false;
        }

        // 校验（原材料）存货是否存在一致
        if (originalItemId && originalItemId == slicingInvItemId){
            LayerMsgBox.alert("卷料（原材料）存货不能跟分条料存货选择一致",2);
            return false;
        }

        if (originalItemId && originalItemId == blankingItemId){
            LayerMsgBox.alert("卷料（原材料）存货不能跟片料（落料）存货选择一致",2);
            return false;
        }

        // 分条料 校验
        if (slicingInvItemId && slicingInvItemId == blankingItemId){
            LayerMsgBox.alert("分条料存货不能跟片料（落料）存货选择一致",2);
            return false;
        }

        // 校验数量跟重量
        if (invItemId){
            if (!item.invQty){
                LayerMsgBox.alert("部品QTY不能为空",2);
                return false;
            }
        }
        if (blankingItemId){
           if (!item.blankingQty){
               LayerMsgBox.alert("片料可制件数不能为空",2);
               return false;
           }
            if (!item.blankingWeight){
                LayerMsgBox.alert("片料重量不能为空",2);
                return false;
            }
        }
        if (originalItemId){
            if (!item.originalQty){
                LayerMsgBox.alert("原材料可制件数不能为空",2);
                return false;
            }
            if (!item.originalWeight){
                LayerMsgBox.alert("原材料重量不能为空",2);
                return false;
            }
        }
        if (slicingInvItemId){
            if (!item.slicingQty){
                LayerMsgBox.alert("分条料可制件数不能为空",2);
                return false;
            }
            if (!item.slicingWeight){
                LayerMsgBox.alert("分条料重量不能为空",2);
                return false;
            }
        }
        return true;
    }

    function getTableData() {
        var bomMaster_complete = $("#bomMaster_#(pageId)");
        var rows = [];
        bomMaster_complete.children("tbody").children("tr").each(function () {
            var row = {};
            // 获取input标签 class属性还有form-control
            $(this).find('td').each(function () {
                var inputs = $(this).find("input[class*='form-control']");
                getField(row, inputs);
                var selects = $(this).find("select[class='form-control']");
                getField(row, selects);

            })
            rows.push(row);
        })
        return rows;
    };

    function getField(row, labels) {
        if (labels && labels.length > 0) {
            $.each(labels, function (idx, v) {
                if (v.name && v.name !== '' && v.value) {
                    row[v.name] = row[v.name] ? (row[v.name] + ',' + v.value) : v.value;
                }
            });
        }
    }



</script>
#include("/_view/_admin/common/_formjs.html",formId="BomMaster_Form")
#end
