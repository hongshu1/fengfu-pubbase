<form onsubmit="return false;" id="moDocForm_#(pageId)" action="#(action)" method="post">

<!--    <input type="hidden" name="moDoc.iautoid" value="#(moDoc.iautoid??)"/>-->

    <button type="submit"  onclick="submitThisForm()" class="btn btn-primary btn-sm"><i class="fa fa-save"></i>保存</button>

    <div class="form-group row">
        <label class="col-sm-2 col-form-label">工单号</label>
        <div class="col-3">
            <input type="text" data-with-clearbtn="true" autocomplete="off" class="form-control"
                   data-rule="required" placeholder="请输入生产工单号" maxlength="50" name="moDoc.cmodocno"
                   value="#(moDoc.cmodocno??)"/>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-sm-2 col-form-label">生产部门</label>
        <div class="col-3">
            <select class="form-control" name="moDoc.iDepartmentId"
                    data-autoload
                    data-with-clearbtn="true"
                    data-select-type="select2"
                    data-tips="请选择"
                    data-url="admin/dept/enableOptions"
                    data-text="=请选择="
                    data-text-attr="name"
                    data-value-attr="id"
                    data-select="#(moDoc.idepartmentid??)">
            </select>
        </div>

        <label class="col-sm-2 col-form-label">产线名称</label>
        <div class="col-3">
            <select class="form-control"
                    data-autoload
                    data-url="admin/equipment/selectLine"
                    data-select-type="select"
                    name="moDoc.iworkregionmid"
                    data-refresh="true"
                    data-rule="select"
                    data-notnull="true"
                    data-tips="请选择产线ID"
                    data-text="=请选择="
                    data-value=""
                    data-value-attr="iautoid"
                    data-text-attr="cworkname"
                    data-select="#(moDoc.iworkregionMid??)"
            ></select>
        </div>
    </div>

    <div class="form-group row">
        <label class="col-sm-2 col-form-label">班次名称</label>
        <div class="col-3">
            <select class="form-control"
                    data-autoload
                    data-url="admin/workshiftm/getSelect"
                    data-select-type="select"
                    name="moDoc.iworkshiftmid"
                    data-refresh="true"
                    data-rule="select"
                    data-notnull="true"
                    data-tips="请选择班次"
                    data-text="=请选择="
                    data-value=""
                    data-value-attr="iautoid"
                    data-text-attr="cworkshiftname"
                    data-select="#(moDoc.iworkshiftmid??)"
            ></select>
<!--            <input type="text" data-with-clearbtn="true" autocomplete="off" class="form-control"-->
<!--                   data-rule="required"-->
<!--                   placeholder="请输入班次ID" maxlength="19" name="moDoc.iworkshiftmid"-->
<!--                   value="#(moDoc.iworkshiftmid??)"/>-->
        </div>

        <label class="col-sm-2 col-form-label">计划日期</label>
        <div class="col-3">
            <input type="text" data-date data-type="date" data-fmt="yyyy-MM-dd" readonly="readonly"
                   autocomplete="off"
                   class="form-control" data-rule="required" placeholder="请设置计划日期" data-tips="请设置计划日期"
                   maxlength="10"
                   name="moDoc.dplandate" value="#(moDoc.dplandate??)"/>
        </div>
    </div>

    <div class="form-group row">
        <label class="col-sm-2 col-form-label">存货编码</label>
        <div class="col-3">
            <input type="text"
                   data-autocomplete
                   data-rule="required"
                   data-tips="请选择存货编码"
                   autocomplete="off"
                   class="form-control"
                   placeholder="请选择存货编码"
                   value="#(moDoc.cinvcode??)"
                   id="cinvcode"
                   data-text-attr="cinvcode"
                   data-hidden-input="cinvcode1,cinvname1,itemid,routid"
                   data-column-attr="cinvname,cinvname1,itemid"
                   maxlength="40"
                   data-url="admin/bommaster/inventoryAutocompleteNew"
            />
        </div>

        <input  type="hidden" placeholder="存货id" id="itemid" data-value-attr="itemid" name="moDoc.iinventoryid"/>
        <input  type="hidden" placeholder="工艺id" id="routid" data-value-attr="routid" name="moDoc.iinventoryrouting"/>
        <input type="hidden" disabled id="iinventoryroutingid_#(pageId)" autocomplete="off" class="form-control col-sm-4"
               placeholder="料品工艺档案Id" name="iinventoryroutingid" value="#(iinventoryroutingid)" />

        <label class="col-sm-2 col-form-label">客户部番</label>
        <div class="col-3">
            <input id="cinvcode1" type="text" data-with-clearbtn="true" autocomplete="off" class="form-control"
                   placeholder="" maxlength="18" data-value-attr="cinvcode1"
                   readonly="readonly"
            />
        </div>
    </div>

    <div class="form-group row">
        <label class="col-sm-2 col-form-label">部品名称</label>
        <div class="col-3">
            <input id="cinvname1" type="text" data-with-clearbtn="true" autocomplete="off" class="form-control"
                   placeholder="" maxlength="18" data-value-attr="cinvname1"
                   readonly="readonly"/>
        </div>
        <label class="col-sm-2 col-form-label">计划数量</label>
        <div class="col-3">
            <input type="text" data-with-clearbtn="true" autocomplete="off" class="form-control" data-rule="pnumber;fix<=2;" placeholder="请输入计划数量" maxlength="18" name="moDoc.iqty" value="#(moDoc.iqty??)"/>
        </div>
    </div>

</form>

<!-- JBoltTable的数据模板定义-->
<textarea class="jb_tpl_box" id="itemroutingconfigRowtpl_#(pageId)">
{@each datas as data,index}
<tr data-id="${data.iautoid}" >
    <td hidden>${data.iinventoryid}</td>
    <td>${data.iseq}</td>
    <td data-value="${data.coperationname}">${data.coperationname}</td>

    <td>
        {@if data.invcs == undefined}
           <span></span>
       {@else}
           <span><i class="fa fa-cog"></i>已选${data.invcs}个</span>
        {@/if}
    </td>

    <td>
        {@if data.equipments}
            <span><i class="fa fa-cog"></i>已选${data.equipments}个</span>
        {@else}
            <span></span>
        {@/if}
    </td>

    {@if data.drawings}
        <td><span><i class="fa fa-cog"></i>已选${data.drawings}个</span></td>
    {@else}
        <td><span></span></td>
    {@/if}

    {@if data.imergednum > 0}
        <td><span><i class="fa fa-cog"></i>请选${data.iMergedNum}个人</span></td>
    {@else}
        <td data-editable= flase>不可选</td>
    {@/if}

    <td></td>

</tr>
{@/each}
</textarea>

<h5>工艺路线信息</h5>

<table class="jbolt_table jbolt_main_table table-center"
       id="itemroutingconfigid_#(pageId)"
       data-jbolttable
       data-height="62%"
       data-autoload="false"
       data-url="admin/inventoryroutingconfig/list"
       data-column-resize="true"
       data-ajax="true"
       data-column-prepend="1:checkbox:true"
       data-rowtpl="itemroutingconfigRowtpl_#(pageId)"
       data-editable="true"
       data-editable-option="getEditableTableOptionsModocFirst"
>
    <thead>
    <tr>
        <th data-width="120" data-column="iinventoryid" hidden>工艺档案id</th>
        <th data-width="80" data-column="iseq">工序号</th>
        <th data-width="160" data-column="coperationname">工序名称</th>
        <th data-width="120" data-column="invcs">所需物料集</th>
        <th data-width="120" data-column="equipments">所需设备集</th>
        <th data-width="120" data-column="drawings">作业指导书</th>
        <th data-width="120" data-column="configperson">生产人员</th>
        <th data-width="120" data-column="configpersonids">生产人员ID</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>

#define js()
<script>

    function getItemValue() {
        let  itemidValue = $('#itemid').val();
        console.log("得到存货id"+itemidValue)
        return itemidValue;
    }

    function getEditableTableOptionsModocFirst(){
        var editableTableOptions1={
            trigger:"click",
            initRowCount:0,
            maxRowCount:30,
            keepCellStyleCols:[1,2,3,"total","enable"],//不可填 但是也不需要设置不可填样式的列
            submit:{
                withForm: ["moDocForm_#(pageId)"],
                name: 'docForm',
                type:"all",//cell|all
                //params:{"orderId":3},//携带其他额外参数
                //commonAttr:{"save":{"update_time":new Date().getTime(),"autoId":1}},//给save或者update的时候 表格每一行数据 都添加指定的属性一并提交
                url:"/admin/modoc/save",
                success:function(res){
                    LayerMsgBox.success("提交成功",600,function(){
                        parent.refreshPjaxContainer();
                        parent.layer.closeAll();
                    });
                }
            },
            //插入数据时默认属性值
            //insertDefaultValues:{age:10,briefInfo:"xxxxx"},
            cols:{
                autoid: {
                    submitAttr: "iautoid"
                },
                invcs: {  //所需物料集
                    type: "dialogbtn",
                    placeholder: "设置物料集",
                    linkColumn: 'iautoid',
                    dialog: {
                        url: "admin/inventoryroutingconfig/invc_dialog_index?iinventoryid=" + getItemValue(),
                        area: "80%,80%",
                        title: "工序物料集",
                        btn: "确定,关闭"
                    }
                },
                equipments: {  //所需设备集
                    type: "dialogbtn",
                    placeholder: "工序设备集",
                    linkColumn: 'iautoid',
                    dialog: {
                        url: "admin/inventoryroutingconfig/equipment_dialog_index",
                        area: "80%,80%",
                        title: "选择设备",
                        btn: "确定,关闭"
                    }
                },
                drawings: {  //工艺文件
                    type: "dialogbtn",
                    placeholder: "工艺文件",
                    linkColumn: 'iautoid',
                    dialog: {
                        url: "admin/inventoryroutingconfig/drawing_dialog_index",
                        area: "80%,80%",
                        title: "工艺文件",
                        btn: "确定,关闭"
                    }
                },
                configperson: {
                    type: "input",
                    placeholder: "人员维护",
                    linkColumn: 'configpersonids',
                    readOnly: true,
                    dialog: {
                        url: "admin/modoc/persondialog",
                        area: "95%,95%",
                        title: "选择人员",
                        btn: "确定,关闭"
                    }
                },
                configpersonids: {
                    type: "dialogbtn",
                    placeholder: "人员维护",
                    linkColumn: 'configperson'
                }
            }
        };
        return editableTableOptions1;
    }

    hideParentLayerDialogBtn(0);
    hideParentLayerDialogBtn(1);

    $(document).ready(function () {
        $('#routid').on('change', function () {
            var input = $(this);
            var inputValue = input.val();

            var $iinventoryroutingid = $('#iinventoryroutingid_#(pageId)');
            $iinventoryroutingid.val(inputValue);

            let iinventoryroutingidValue = $iinventoryroutingid.val();

            $.ajax({
                url: 'admin/inventoryroutingconfig/list?iinventoryroutingid=' + inputValue,
                type: 'GET',
                success: function (ret) {
                    if (ret.state === 'ok') {
                        var data = ret.data;

                        jboltTableClear('#itemroutingconfigid_#(pageId)');

                        jboltTableInsertRow('#itemroutingconfigid_#(pageId)', data, false, false, true);
                        // console.log(jboltTableGetSubmitData('#itemroutingconfigid_#(pageId)'));
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
            // refreshJBoltTable('#itemroutingconfigid_#(pageId)');
        });
    });

    function submitThisForm() {
        console.log("提交表单")
        jboltTableSubmit("#itemroutingconfigid_#(pageId)");
    }
</script>
#end


