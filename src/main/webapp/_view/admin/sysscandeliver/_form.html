#set(pageId=RandomUtil.random(6))
<div class="jbolt_page_title">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="col">
                        <button onclick="submitThisForm_#(pageId)()" class="btn btn-outline-secondary"><i
                                class="fa fa-refresh"></i> 提交</button>
                        <!--<button onclick="closeHandler()" class="btn btn-info btn-sm"><i
                                class="fa fa-window-maximize"></i> 关闭
                        </button>-->
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form onsubmit="return false;" id="sysscandeliver_#(pageId)" action="#(action)" method="post">
                        #if(sysscandeliver.autoid??)
                        <input type="hidden" name="sysscandeliver.autoid" value="#(sysscandeliver.autoid??)" />
                        #end
                        <input type="hidden" id="detailHidden_#(pageId)" name="detailHidden" value="#(detailHidden??)"/>
                        <div class="row">

                            <!--<div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">车次号</label>
                                    <div class="col-9">
                                        <div class="input-group-append">
                                            <input type="hidden" id="SourceBillType_#(pageId)" class="form-control"
                                                   name="sysscandeliver.sourcebilltype" placeholder="来源类型"
                                                   value="#(sysscandeliver.sourcebilltype??)" />
                                            <input type="hidden" id="SourceBillID_#(pageId)" class="form-control"
                                                   name="sysscandeliver.sourcebillid" placeholder="来源ID"
                                                   value="#(sysscandeliver.sourcebillid??)" />
                                            <input type="hidden" id="BillType_#(pageId)" class="form-control"
                                                   name="sysscandeliver.billtype" placeholder="业务类型"
                                                   value="#(sysscandeliver.billtype??)" />
                                            <input type="hidden" id="sourceBillNo_#(pageId)" readonly="readonly"
                                                   class="form-control" data-rule="required"
                                                   placeholder="订单号"
                                                   name="sysscandeliver.sourcebillno"
                                                   value="#(sysscandeliver.sourcebillno??)" />
                                            <input type="text" readonly="readonly" id="carNo"
                                                   class="form-control" data-rule="required"
                                                   placeholder="请选择车次号"/>
                                            <button class="btn btn-outline-secondary" data-dialogbtn
                                                    data-area="80%,80%" data-title="选择数据（单选）" id="billButton_#(pageId)"
                                                    data-url="/admin/doubleCodeScanningShipment/orderData"><i
                                                    class="fa fa-search mr-1"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>-->

                            <div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">车次号</label>
                                    <div class="col-9">
                                        <input type="text"
                                               data-sync-ele="#cusCode,#cusName,#cusId"
                                               data-text-attr="ccarno"
                                               name="carNo"
                                               data-rule="required"
                                               data-handler="getItemData"
                                               data-column-attr="ccarno,ccuscode,ccusname"
                                               placeholder="请选择"
                                               data-tips="请选择"
                                               data-header="车次号,客户编码,客户名称"
                                               class="form-control" data-autocomplete
                                               data-url="/admin/doubleCodeScanningShipment/getCarData"
                                               value="#(sysscandeliver.ccarno??)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">客户名称</label>
                                    <div class="col-9">
                                        <input type="text"
                                               readonly="readonly"
                                               class="form-control" id="cusName"
                                               data-value-attr="ccusname"
                                               value="#(sysscandeliver.cusname??)"
                                               placeholder="客户名称" >
                                        <input type="hidden" class="form-control" id="cusId"
                                               name="cusid"
                                               placeholder="客户ID"
                                               data-value-attr="cusid"
                                               value="#(sysscandeliver.cusid??)"/>
                                        <input type="hidden" class="form-control" id="cusCode"
                                               name="sysscandeliver.cuscode"
                                               placeholder="客户编码"
                                               data-value-attr="ccuscode"
                                               value="#(sysscandeliver.cuscode??)"/>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">客户位置</label>
                                    <div class="col-9">
                                        <input type="text"
                                               data-rule="required"
                                               data-link-para-ele="#cusId"
                                               data-sync-ele="#versionWhCode_#(pageId),#versionWhName_#(pageId)"
                                               data-text-attr="addrname"
                                               data-column-attr="addrname,whcode,whname"
                                               placeholder="请选择"
                                               data-tips="请选择"
                                               data-header="客户地址,仓库编码,仓库名称"
                                               class="form-control" data-autocomplete data-url="/admin/doubleCodeScanningShipment/getCustAddr"
                                               maxlength="40" name="sysscandeliver.cusposition"
                                               value="#(sysscandeliver.cusposition??)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">仓库名称</label>
                                    <div class="col-9">
                                        <input type="hidden" name="sysscandeliver.whcode" id="versionWhCode_#(pageId)"
                                               data-value-attr="whcode"
                                               value="#(sysscandeliver.whcode??)"/>
                                        <input type="text" data-notnull="true" data-tips="仓库名称"
                                               readonly="readonly" class="form-control" id="versionWhName_#(pageId)"
                                               placeholder="仓库名称" data-value-attr="whname" name="sysscandeliver.whname"
                                               value="#(sysscandeliver.whname??)" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">日期</label>
                                    <div class="col-9">
                                        <input type="text" data-date data-type="date"
                                               data-fmt="yyyy-MM-dd"
                                               class="form-control" placeholder="请设置日期"
                                               maxlength="10" name="sysscandeliver.billdate"
                                               value="#date(DateUtil.toDate(sysscandeliver.billdate??DateUtil.getNow()),'yyyy-MM-dd')">
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">备注</label>
                                    <div class="col-9">
                                        <input type="text"
                                               class="form-control"
                                               placeholder="请输备注" maxlength="40" name="sysscandeliver.memo"
                                               value="#(sysscandeliver.memo??)" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

#include("/_view/admin/sysscandeliverdetail/_form.html")

<div class="jbolt_page_content">
    <script type="text/template" id="sysscandeliver_tpl_#(pageId)">
        {@each datas as data,index}
        <tr data-id="${data.autoid}">
            <td>${pageNumber,pageSize,index | rownum}</td>
            <td>${data.cusbarcode}</td>
            <td>${data.barcode}</td>
            <td>${data.packbarcode}</td>
            <td>${data.cinvcode}</td>
            <td>${data.cinvcode1}</td>
            <td>${data.cinvname1}</td>
            <td>${data.cinvstd}</td>
            <td>${data.cuomname}</td>
            <td>${data.qty}</td>
            <td>${data.corderno}</td>
            <td>${data.cwhname}</td>
            <td>${data.posname}</td>

        </tr>
        {@/each}
    </script>
    <div class="jbolt_table_toolbar" id="sysscandeliver_toolbar_#(pageId)" style="display: flex">

        <div class="clearfix">
            <form class="form-inline" id="sysscandeliver_detail_#(pageId)" onsubmit="return false;">
                #if(sysscandeliver.autoid??)
                <input type="hidden" name="sysscandeliver.autoid" value="#(sysscandeliver.autoid??)" />
                #end
                <input type="text" autocomplete="off" class="form-control"  placeholder="客户传票号扫码"
                       id="cusBarcode_#(pageId)"
                       name="cusBarcode"
                       value="" />
                <input type="text" autocomplete="off" class="form-control"  placeholder="现品票扫码" id="barcode_#(pageId)"
                       name="barcode"
                       value="" />
                <input type="text" autocomplete="off"  class="form-control"  placeholder="容器扫码" style="display: none"
                       name="storeNum"
                       id="storeNum_#(pageId)"
                       value="" />
                <span style="padding: 0 12px 0 12px">
                开启容器扫码:
                <img data-switchbtn data-value="false" id="switchBtn_#(pageId)" data-handler="switchFun_#(pageId)"/>
                    </span>
                <button type="button" onclick="searchBarcode_#(pageId)()" class="btn btn-outline-secondary"><i class="fa fa-search"></i> 搜索</button>
            </form>
        </div>
        <div style="padding-left: 50%;display: none">
            <button onclick="jboltTableRemoveCheckedRow(this, true, false)" class="btn btn-outline-secondary"><i class="fa fa-trash"></i> 删除</button>
        </div>
    </div>
</div>
<table  class="jbolt_table thead_font_normal table-bordered table-center"
        ### 可排序列 定义 多个用逗号隔开
        ### 启用动态调整列宽
        data-column-resize="true"
        ### 设置为异步加载数据
        data-ajax="true"
        data-ajax-success-handler="tableDataSuccess_#(pageId)"
        ### 数据接口地址
        data-url="admin/scanCodeShipmentdetail/getLine"
        data-conditions-form="sysscandeliver_detail_#(pageId)"
        ### 禁止回车键新增行
        data-auto-create-empty-tr="false"
        ### 加一列checkbox
        data-column-prepend="1:checkbox"
        data-tfoot-fixed="true"
        data-jbolttable
        id="jbolt_Table_#(pageId)"
        data-rowtpl="sysscandeliver_tpl_#(pageId)"
        data-toolbar="sysscandeliver_toolbar_#(pageId)"
        data-editable="true"
        data-editable-option="getJBoltTableEditableColsOpton_#(pageId)">
    <thead class="fw_normal">
    <tr>
        <th data-width="60">序号</th>
        <th data-width="100" data-column="cusbarcode">客户传票号</th>
        <th data-min-width="120" data-column="barcode">现品票</th>
        <th data-width="100" data-column="packbarcode">容器编码</th>
        <th data-min-width="120" data-column="cinvcode">存货编码</th>
        <th data-width="100" data-column="cinvcode1">客户部番</th>
        <th data-width="100" data-column="cinvname1">部品名称</th>
        <th data-width="100" data-column="cinvstd">规格型号</th>
        <th data-width="100" data-column="cuomname">主计量单位</th>
        <th data-width="100" data-column="qty">数量</th>
        <th data-width="100" data-column="billno">订单号</th>
        <th data-width="100" data-column="cwhname">出货仓库</th>
        <th data-width="100" data-column="posname">出货库区</th>
    </tr>
    </thead>
</table>

#define js()
<script>
    function getItemData() {
        jboltTableRefresh("jbolt_Table_item_#(pageId)");
    }
</script>
<script>
    /**
     * 搜索现品票
     * */
    function searchBarcode_#(pageId)() {
        var barcode = $("#barcode_#(pageId)").val();
        var cusBarcode = $("#cusBarcode_#(pageId)").val();
        var storeNum = $("#storeNum_#(pageId)").val();

        if (isEmpty(barcode) || isEmpty(cusBarcode)){
            LayerMsgBox.error("请同时扫传票号与现品票",2000);
            return;
        }

        if (barcode != null && barcode !== ''){
            var index = LayerMsgBox.loading("执行中......",2000);
            var data = getJboltTableAllDatas("jbolt_Table_#(pageId)",["barcode"]);
            if (data != null){
                for (let i = 0; i < data.length; i++) {
                    if(data[i].barcode === barcode){
                        LayerMsgBox.error("现品票已重复");
                        return;
                    }
                }
            }
            var detailHidden = $("#detailHidden_#(pageId)").val();
            Ajax.post("admin/doubleCodeScanningShipment/getResource",
                {"barcode": barcode,"detailHidden":detailHidden,"cusBarcode":cusBarcode},
                function (res) {
                    if (res.state==='ok'){
                        var trJsonData = res.data;
                        let one = '';
                        console.log('res.data===>',res.data)
                        if (trJsonData != null && trJsonData.length > 0){
                            one = trJsonData[0];
                            let itemCode = one.cinvcode;
                            if(isNotEmpty(storeNum)){
                                //    判断是否社内
                                one.packbarcode = storeNum;
                            }
                            let quantity = one.qty;
                            let order = getJboltTableAllDatas("jbolt_Table_item_#(pageId)");
                            if (order != null && order.length > 0){
                                for (var i = 0; i < order.length; i++) {
                                    let o = order[i];
                                    let invCode = o.invcode;
                                    console.log('invCode',invCode)
                                    if (itemCode===invCode){
                                        let qty = o.qty;
                                        let planqty = o.planqty;
                                        let barcode = o.barcode;
                                        let cusBarcode = o.cusbarcode;
                                        let packBarcode = o.packbarcode;

                                        console.log('qty',qty)
                                        console.log('quantity',quantity)

                                        var add = Number(qty)+Number(quantity);
                                        console.log('add',add)
                                        if (add > planqty){
                                            LayerMsgBox.confirm("是否拆分条码？",function (res) {

                                                /*var ele = $("#switchBtn_#(pageId)").data('url',
                                                    '/admin/doubleCodeScanningShipment/kaibarcode?barcode=' + barcode +"&quantity=" +quantity)
                                                    .data('area', '600,500')
                                                    .data('title', '拆分条码')
                                                    .data('btn', '保存,取消');
                                                DialogUtil.openBy(ele)*/
                                            },function (err) {

                                            })
                                        }

                                        o.qty = add;
                                        o.barcode = isNotEmpty(barcode)?barcode+","+ one.barcode:one.barcode;
                                        o.cusbarcode =
                                            isNotEmpty(cusBarcode)?cusBarcode+","+ one.cusbarcode:one.cusbarcode;
                                        o.packbarcode = isNotEmpty(storeNum) && isNotEmpty(packBarcode)?packBarcode+","+
                                            one.packbarcode:one.packbarcode;
                                        //更新order
                                        clearJboltTable("jbolt_Table_item_#(pageId)");
                                        jboltTableInsertRow("jbolt_Table_item_#(pageId)",order);
                                        break;
                                    } else {
                                        LayerMsgBox.error('没有匹配到存货编码');
                                        return;
                                    }
                                }
                            } else {
                                LayerMsgBox.error("请先选择订单")
                                return;
                            }
                        } else {
                            LayerMsgBox.error("找不到现品票");
                            return;
                        }
                        jboltTableInsertRow("jbolt_Table_#(pageId)", one, false, false, false);
                        $("#barcode_#(pageId)").val('');
                        $("#cusBarcode_#(pageId)").val('');
                    }
                }, function (err) {
                })
        } else {

        }

    }
</script>
<script>
    /**
     * 开启容器扫码
     * @param ele
     */
    function switchFun_#(pageId)(ele) {
        console.log('ele',ele.data("value"));
        let isOpen = ele.data("value");
        if (isOpen){
            $("#storeNum_#(pageId)").show();
        } else {
            $("#storeNum_#(pageId)").hide();
        }
    }

    /**
     * 获取表格数据
     * */
    function tableDataSuccess_#(pageId)() {
        let result = jboltTableGetAllDatas("jbolt_Table_#(pageId)", ["barcode"]);
        console.log('result===>',result)
        let array = [];
        if (result != null) {
            var length = result.length;
            let len = 0;
            for (let i = 0; i < length; i++) {
                if (result[i].barcode != undefined){
                    array.push("'" + result[i].barcode + "'");
                }
            }
            let codes = array.length > 0 ?array.join(','):'';
            $("#detailHidden_#(pageId)").val(codes);
        }
        console.log('detailHidden===',$("#detailHidden_#(pageId)").val());
        return true;
    }
</script>
<script>
    hideParentLayerDialogBtn(0);
    hideParentLayerDialogBtn(1);
    function submitThisForm_#(pageId)() {
        jboltTableSubmit("#jbolt_Table_item_#(pageId)");
    }

    function getJBoltTableEditableColsOpton_#(pageId)() {
        var editableTableOptions = {
            submit: {
            },
            cols: {
                barcode: { //条码
                    submitAttr:"Barcode"
                },
                qty: {
                    submitAttr:"Qty"
                },
                packbarcode :{
                    submitAttr:"PackBarcode"
                }
            }
        };
        return editableTableOptions;
    }
    function closeHandler() {
        parent.layer.close(parent.layer.getFrameIndex(window.name));
        window.parent.refreshJBoltTable();
    }

    /**
     * 获得选中的订单数据
     * @param data
     */
    function setChooseDialogSelectResultFromCarNo(data) {
        console.log(data)
        console.log(data.ccarno)
        console.log(data.cbarcode)
        $("#carNo").val(data.ccarno);
        $("#cusCode").attr("value",data.ccuscode);
        $("#cusName").val(data.ccusname);
        $("#cusid").attr("value",data.icustomerid);
        // jboltTableRefresh("jbolt_Table_item_#(pageId)");
    }

</script>
#end
