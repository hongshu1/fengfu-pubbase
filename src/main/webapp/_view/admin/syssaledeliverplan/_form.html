#set(pageId=RandomUtil.random(6))
#set(iYear=DateUtil.getYear())
#set(precisionConfig1=JBoltGlobalConfigCache.getConfigValue("precision_config1"))

### 默认为非只读,查看页有readonly=readonly标识
### 【readonly为false】, 或 【审核中或已通过】，设置只读
#if(readonly != 'readonly' && (monthorderm.iauditstatus??0 == 1 || monthorderm.iauditstatus??0 == 2))
#set(readonly = 'readonly')
#end

<div class="jbolt_page_title">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="col">
            #if(readonly != 'readonly')
            <button onclick="submitThisForm_#(pageId)(false)" class="btn btn-outline-secondary btn-sx">
              保存
            </button>
            #end

            #if(syssaledeliverplan.autoid??)
            #include("/_view/_common/_approval_btns.html", formSn="T_Sys_SaleDeliverPlan", o=syssaledeliverplan,
            primaryKeyName="AutoID",
            className="cn.rjtech.admin.syssaledeliverplan.SysSaledeliverplanService",permissionKeyPrefix="syssaledeliverplan")
            #end

            <button onclick="closeHandler()" class="btn btn-outline-secondary btn-sx">
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <form onsubmit="return false;" id="syssaledeliverplan_#(pageId)" action="#(action)" method="post">
            #if(syssaledeliverplan.AutoID??)
            <input type="hidden" name="syssaledeliverplan.AutoID" value="#(syssaledeliverplan.AutoID??)"/>
            #end

            <div class="row">
              <div class="col">
                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">发货单号</label>
                  <div class="col-9">
                    <input type="text" data-notnull="true" data-tips="请输入发货单号" disabled
                           data-with-clearbtn="true" autocomplete="off" class="form-control"
                           placeholder="请输入发货单号" maxlength="40" value="#(syssaledeliverplan.billno??)"/>
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">销售类型</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete
                           data-url="admin/salesShipmentList/saletype" data-rule="required"
                           data-hidden-input="cstcode" data-text-attr="cstname"
                           data-column-attr="cstcode,cstname" placeholder="请选择业务类型" data-tips="请选择业务类型"
                           data-header="业务类型编码,业务类型" maxlength="40" value="#(cstname??)">
                  </div>
                </div>

                <div class="form-group row">
                  <input type="hidden" name="cunameiautoid" value="#(cunameiautoid??)" id="cunameiautoid" data-value-attr="cunameiautoid"/>
                  <label class="col-sm-3 col-form-label">客户简称</label>
                  <div class="col-9">
                    <input type="text" data-notnull="true" id="cuname" disabled data-with-clearbtn="true" autocomplete="off" class="form-control"
                           maxlength="40" name="cuname" value="#(cuname??)"/>
                  </div>
                </div>

                <div class="form-group row">
                  <input type="hidden" name="syssaledeliverplan.ShipAddress" value="#(syssaledeliverplan.ShipAddress??)" id="cdistrictcode"
                         data-value-attr="cdistrictcode"/>
                  <label class="col-sm-3 col-form-label">发货地址</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete
                           data-url="admin/salesShipmentList/customeraddr" data-rule="required"
                           data-hidden-input="cdistrictcode" data-text-attr="cdistrictname"
                           data-column-attr="cdistrictcode,cdistrictname" placeholder="请选择发货地址"
                           data-tips="请选择发货地址" data-header="发货地址编码,发货地址名称" maxlength="40"
                           value="#(cdistrictname??)">
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">税率</label>
                  <div class="col-9">
                    <input type="text" data-notnull="true" data-tips="请输税率"
                           data-with-clearbtn="true" autocomplete="off" class="form-control"
                           placeholder="请输税率" maxlength="40" name="syssaledeliverplan.taxrate"
                           value="#(syssaledeliverplan.taxrate??)"/>
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">备注</label>
                  <div class="col-9">
                    <textarea id="memo" name="memo" class="form-control" placeholder="=请输入备注="
                              type="text" maxlength="300" value="#(syssaledeliverplan.memo??)">#(syssaledeliverplan.memo??)</textarea>
                  </div>
                </div>

              </div>

              <div class="col">
                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">发货日期</label>
                  <div class="col-9">
                    <input type="text" class="form-control" name="syssaledeliverplan.predeliverdate"
                           placeholder="发货日期" data-tips="发货日期" maxlength="40" value="#(syssaledeliverplan.predeliverdate??)">
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">订单号</label>
                  <div class="col-9">
                    <div class="input-group-append">
                      <input type="hidden" id="billno2" class="form-control border-none" readonly="readonly" name="syssaledeliverplan.billno" placeholder=""
                             value="#(syssaledeliverplan.billno??)"/>
                      <input type="text" data-notnull="true" data-tips="请输入订单号" id="billno" data-with-clearbtn="true"
                             autocomplete="off" class="form-control  border-none" disabled placeholder="请输入订单号"
                             maxlength="40" name="billno" value="#(syssaledeliverplan.billno??)"/>
                      <button class="btn btn-primary" data-dialogbtn data-link-para-ele="" data-area="80%,80%" data-title="选择数据（单选）" id="supplierButton"
                              data-url="/admin/salesShipmentList/orderData"><i class="fa fa-search mr-1"></i></button>
                    </div>
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">销售部门</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete data-url="admin/salesShipmentList/department" data-rule="required"
                           data-hidden-input="cdepcode" data-text-attr="cdepname" data-column-attr="cdepcode,cdepname" placeholder="请选销售部门" data-tips="请选销售部门"
                           data-header="销售部门编码,销售部门名称" maxlength="40" value="#(cdepname??)">
                  </div>
                </div>

                <div class="form-group row">
                  <input type="hidden" name="syssaledeliverplan.Issue"
                         value="#(syssaledeliverplan.Issue??)" id="crdcode" data-value-attr="crdcode"/>
                  <label class="col-sm-3 col-form-label">发运方式</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete
                           data-url="admin/salesShipmentList/rdstyle" data-rule="required"
                           data-hidden-input="crdcode" data-text-attr="crdname"
                           data-column-attr="crdcode,crdname" placeholder="请选择发运方式" data-tips="请选择发运方式"
                           data-header="发运方式编码,发运方式名称" maxlength="40" value="#(crdname??)">
                  </div>
                </div>

                <div  class="form-group row">
                  <input type="hidden" name="syssaledeliverplan.ExchName"
                         value="#(syssaledeliverplan.ExchName??)" id="cexchname"
                         data-value-attr="cexchname"/>
                  <label class="col-sm-3 col-form-label">币种</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete
                           data-url="admin/salesShipmentList/foreigncurrency" data-rule="required"
                           data-hidden-input="cexchname" data-text-attr="cexchname"
                           data-column-attr="cexchcode,cexchname" placeholder="请选择币种" data-tips="请选择币种"
                           data-header="币种编码,币种名称" maxlength="40"
                           value="#(syssaledeliverplan.exchname??)">
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">业务类型</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete
                           data-url="admin/productInList/getWarehouse" data-rule="required"
                           data-hidden-input="cwhcode" data-text-attr="cwhname"
                           data-column-attr="cwhcode,cwhname" placeholder="请选择业务类型" data-tips="请选择业务类型"
                           data-header="业务类型编码,业务类型" maxlength="40" value="#(cwhname??)">
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">发票号</label>
                  <div class="col-9">
                    <input type="text" data-notnull="true" data-tips="请输入发票号" data-with-clearbtn="true" autocomplete="off" class="form-control"
                           placeholder="请输入发票号" maxlength="40" name="syssaledeliverplan.invoice" value="#(syssaledeliverplan.invoice??)"/>
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">业务员</label>
                  <div class="col-9">
                    <input type="text" data-notnull="true" data-tips="请输业务员" disabled data-with-clearbtn="true" autocomplete="off" class="form-control"
                           placeholder="请输业务员" maxlength="40" name="syssaledeliverplan.ccreatename" value="#(syssaledeliverplan.ccreatename??)"/>
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">付款条件</label>
                  <div class="col-9">
                    <input type="text" class="form-control" data-autocomplete
                           data-url="admin/salesShipmentList/settlestyle" data-rule="required"
                           data-hidden-input="csscode" data-text-attr="cssname"
                           data-column-attr="csscode,cssname" placeholder="请选择付款方式" data-tips="请选择付款方式"
                           data-header="付款编码,付款名称" maxlength="40" value="#(cssname??)">
                  </div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">汇率</label>
                  <div class="col-9">
                    <input type="text" data-notnull="true" data-tips="请输汇率"
                           data-with-clearbtn="true" autocomplete="off" class="form-control"
                           placeholder="请输汇率" maxlength="40" name="syssaledeliverplan.ExchRate"
                           value="#(syssaledeliverplan.exchrate??)"/>
                  </div>
                </div>
              </div>
            </div>
            <input id="operationType" type="hidden" name="operationType" value="#(operationType??)">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="jbolt_page_content">
  <script type="text/template" id="syssaledeliverplan_tpl_#(pageId)">
    {@each datas as data,index}
    <tr data-id="${data.autoid}">
      <td>${pageNumber,pageSize,index | rownum}</td>
      <td>
        #if(readonly != 'readonly')
        <a onclick="jboltTableRemoveRow(this)" tooltip data-title="移除行" data-handler="removeTr" data-confirm="确定删除此数据？"
           class="btn btn-danger bat-sm">移除行</a>
        #end
      </td>
      <td title="${data.whcode}">${data.whcode}</td>
      <td title="${data.whname}">${data.whname}</td>
      <td title="${data.careacode}">${data.careacode}</td>
      <td title="${data.careaname}">${data.careaname}</td>
      <td title="${data.barcode}">${data.barcode}</td>
      <td title="${data.invcode}">${data.invcode}</td>
      <td title="${data.cinvcode1}">${data.cinvcode1}</td>
      <td title="${data.cinvname1}">${data.cinvname1}</td>
      <td title="${data.qty}">${data.qty}</td>
      <td title="${data.cinvstd}">${data.cinvstd}</td>
      <td title="${data.inventorycuomname}">${data.inventorycuomname}</td>
      <td title="${data.whcode}">${data.whcode}</td>
    </tr>
    {@/each}
  </script>
  <div class="jbolt_table_toolbar" id="syssaledeliverplan_toolbar_#(pageId)">
    <div class="col-md-3">
      <div class="form-group row">
        <div class="col-9">
          <input type="text" id="barcode" name="barcode" data-notnull="true" data-tips="请输入现品票扫码" data-with-clearbtn="true"
                 autocomplete="off" class="form-control" placeholder="请输入现品票扫码" maxlength="40"
                 value="#(barcode??)"/>
        </div>
        <div class="btn-group btn-group-sm" role="group" aria-label="btn-group">
          <button onclick="checkBarcode()" class="btn btn-primary btn-sm">搜索</button>
        </div>
      </div>
    </div>

    <div class="btn-group btn-group-sm" role="group" aria-label="btn-group">
      <button onclick="jboltTableAppendEmptyRow(this)" class="btn btn-primary btn-sm">添加行</button>
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="btn-group">
      <button onclick="jboltTableRemoveCheckedRow(this, true, false)" data-confirm="确定批量删除选中数据？"
              class="btn btn-danger btn-sm">
        批量删除
      </button>
    </div>
    </div>

  </div>

  <table id="jbolt_Table_#(pageId)"
         class="jbolt_table thead_font_normal table-bordered table-center"
         data-jbolttable
         #if(syssaledeliverplan.AutoID??)
         data-ajax="true"
         data-url="admin/sysSaledeliverplandetail/findEditTableDatas?masid=#(syssaledeliverplan.AutoID??)"
         #end
         data-column-resize="true"
         data-tfoot-fixed="true"
         data-height="600"
         data-column-prepend="1:checkbox"
         data-rowtpl="syssaledeliverplan_tpl_#(pageId)"
         data-toolbar="syssaledeliverplan_toolbar_#(pageId)"
         data-editable="true" data-page="syssaledeliverplan_tpl_#(pageId)"
         data-editable-option="getJBoltTableEditableColsOpton">
    <thead class="fw_normal">
    <tr>
      <th data-width="60">序号</th>
      <th data-width="150">操作</th>
      <th data-width="100" data-column="whcode">仓库编码</th>
      <th data-width="150" data-column="whname">仓库名称</th>
      <th data-width="150" data-column="cAreaCode">库区编码</th>
      <th data-width="150" data-column="cAreaName">库区名称</th>
      <th data-width="180" data-column="barcode">现品票</th>
      <th data-width="180" data-column="invcode">存货编码</th>
      <th data-width="180" data-column="cinvcode1">客户部番</th>
      <th data-width="180" data-column="cinvname1">部品名称</th>
      <th data-width="100" data-column="qty">数量</th>
      <th data-width="180" data-column="cinvstd">规格型号</th>
      <th data-width="100" data-column="inventorycuomname">主计量单位</th>
      <th data-width="100" data-column="whcoWQde">预计发货日期</th>
    </tr>
    </thead>
  </table>

</div>
#define js()
<script>
  hideParentLayerDialogBtn(0);
  hideParentLayerDialogBtn(1);

  var submit = false;

  function submitThisForm_#(pageId)(ele){
    // 保存并提交
    submit = ele;
    $("#operationType").val("submit");
    jboltTableSubmit("#jbolt_Table_#(pageId)");
    $("#operationType").val();
  }

  /**
   * 新增/修改/提审
   */
  function successHandler(msg, autoid) {
    LayerMsgBox.success(msg, 600, function () {
      // 新增/修改，均跳转到详情页
      location.href = '/admin/pickupPlanManage/edit?autoid=' + autoid + '&_jb_rqtype_=dialog';
      parent.refreshPjaxContainer();
    });
  }

  function getJBoltTableEditableColsOpton() {
    var editableTableOptions = {

      submit: {
        withForm: ["syssaledeliverplan_#(pageId)"],
        name: 'syssaledeliverplan',
        type: "all",
        url: "/admin/salesShipmentList/submitAll", success: function (res) {
          var state = res.state;
          if (state === 'ok') {
            if (submit) {
              let data = res.data;
              submit_
              #(pageId)(data.autoid, function () {
                successHandler('提交审核成功', data.autoid);
              });
            } else {
              successHandler(ret.msg, autoid);
            }
          } else {
            LayerMsgBox.error(res.msg);
          }
        }
      },
      cols: {
        AutoID: {
          submitAttr: "AutoID",
        },
        sourcebillno: {
          type: "input",//类型
          placeholder: "订单编号", //输入提示，里面
          tooltip: "订单编号",//输入提示，上方
        },
        barcode: {
          type: "input",//类型
          placeholder: "现品票", //输入提示，里面
          tooltip: "现品票",//输入提示，上方
        },
        whcode: {
          placeholder: "仓库", //输入提示，里面
          tooltip: "仓库",//输入提示，上方
          type: "autocomplete",
          //目前供应商都是空的无法过滤

          url: "admin/SysEnumeration/wareHouse",
          maxLength: 100,
          required: true,
          placeholder: "请选择仓库编码",
          textAttr: "whcode",
          width: 500,
          valueAttr: "whcode",//选择赋值的字段
          columnAttr: "whcode,whname",//下来看的时候显示哪些字段
          header: '仓库编码,仓库名称',
          changeColumns: [{column: "whcode", use: "whcode"}, {column: "whname", use: "whname"}]
        },
        barcode: { //条码
          maxLength: 100,
          required: true,
          placeholder: "=请选择=",
          type: "autocomplete",
          url: "admin/otherout/barcodeDatas",
          textAttr: "barcode",
          width: 800,
          sync: "",
          // linkPara:"#cunameiautoid",
          // linkPara:"input[name='cunameiautoid']",
          valueAttr: "barcode",
          columnAttr: "barcode,cinvcode,cinvdddcode,cinvname,cinvstd,inventorycuomname,qty,cequipmentmodelname",
          header: '现品票,存货编码,存货代码,存货名称,规格型号,主计量单位,数量,所属机型',
          changeColumns: [{column: "barcode", use: "barcode"}, {column: "cinvcode", use: "cinvcode"},
            {column: "cinvcode1", use: "cinvcode1"},
            {column: "cinvname1", use: "cinvname1"}, {column: "cinvstd", use: "cinvstd"},
            {column: "cinvccode", use: "cinvccode"}, {column: "cinvcname", use: "cinvcname"},
            {column: "cuomclassname", use: "cuomclassname"}, {column: "iinventoryid", use: "iautoid"},
            {column: "sourcebilltype", use: "sourcebilltype"},
            {column: "sourcebillno", use: "sourcebillno"}, {column: "sourcebilldid", use: "sourcebilldid"},
            {column: "sourcebillnorow", use: "sourcebillnorow"}, {column: "sourcebillid", use: "sourcebillid"},
            {column: "cinvdddcode", use: "cinvdddcode"},
            {column: "cinvname", use: "cinvname"}, {column: "inventorycuomname", use: "inventorycuomname"},
            {column: "sourcebillid", use: "sourcebillid"}, {column: "qty", use: "qty"}]

        },
      }
    };
    return editableTableOptions;
  }

  /**
   * 获得选中的供应商数据
   * @param data
   */
  function setChooseDialogSelectResultFromSupplier(data) {
    console.log(data)
    $("#billno").val(data.corderno);
    $("#billno2").val(data.corderno);
    $("#cuname").val(data.cuname);
    $("#cunameiautoid").val(data.iautoid);
  }

</script>
#end