#@jboltLayout()
#define main()
#set(pageId=RandomUtil.random(6))
<div class="jbolt_page">
    <div class="jbolt_page_content">
        <form onsubmit="return false;" id="SubcontractOrderMForm" action="#(action)" method="post">
            #if(subcontractOrderM.iAutoId??)
            <input type="hidden" name="iAutoId" value="#(subcontractOrderM.iautoid??)"/>
            #end
            <input type="hidden" name="dBeginDate" value="#(subcontractOrderM.dbegindate??)"/>
            <input type="hidden" name="dEndDate" value="#(subcontractOrderM.denddate??)"/>
            <div class="row">

                <div class="col">
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">业务类型</label>
                        <div class="col-6">
                            <select class="form-control" name="iBusType" disabled
                                    data-autoload
                                    data-rule="required"
                                    data-url="admin/dictionary/options?key=purchase_business_type"
                                    data-select-type="select"
                                    data-select="#(subcontractOrderM.ibustype??)"
                                    data-text="==请选择=="
                                    data-text-attr="iautoid"
                                    data-value-attr="sn">
                            </select>
                        </div>

                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">采购类型</label>
                        <div class="col-6">
                            <select class="form-control" name="iPurchaseTypeId" disabled
                                    data-autoload
                                    data-rule="required"
                                    data-url="admin/subcontractOrderM/findPurchaseType"
                                    data-select-type="select"
                                    data-select="#(subcontractOrderM.ipurchasetypeid??)"
                                    data-text="==请选择=="
                                    data-value-attr="iautoid"
                                    data-text-attr="cptname">
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">业务员</label>
                        <div class="col-6">
                            <input type="hidden" id="ipersonid_#(pageId)" name="iDutyUserId" value="#(subcontractOrderM.idutyuserid??)" />
                            <input type="text" autocomplete="off" value="#(personname??)" class="form-control" disabled
                                   placeholder="==请选择人员=="
                                   data-rule="required"
                                   data-jboltinput
                                   data-width="600"
                                   data-height="450"
                                   data-refresh="true"
                                   data-hidden-input="ipersonid_#(pageId)"
                                   data-load-type="ajaxportal"
                                   data-url="admin/workregionm/personTable"
                            />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">币种</label>
                        <div class="col-6">
                            <select class="form-control" name="cCurrency" disabled
                                    data-autoload
                                    data-rule="required"
                                    data-url="admin/subcontractOrderM/findForeignCurrencyAll"
                                    data-select-type="select"
                                    data-select="#(subcontractOrderM.ccurrency??)"
                                    data-text="==请选择=="
                                    data-value=""
                                    data-value-attr="cexch_name"
                                    data-text-attr="cexch_name">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">订单日期</label>
                        <div class="col-6">
                            <input type="text" readonly data-notnull="true" autocomplete="off" class="form-control" maxlength="20" name="dOrderDate" disabled
                                   value="#datetime(subcontractOrderM.dorderdate??,'yyyy-MM-dd')"/>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">供应商名称</label>
                        <div class="col-6">
                            <input hidden type="text"  name="iVendorId" value="#(subcontractOrderM.ivendorid??)">
                            <input readonly type="text" autocomplete="off" class="form-control" value="#(cVenName??)">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">税率</label>
                        <div class="col-6">
                            <input type="text" autocomplete="off" class="form-control"
                                   placeholder="请输入税率" maxlength="40" name="iTaxRate" data-rule="pnumber" data-notnull="false" disabled
                                   value="#(subcontractOrderM.itaxrate??)"/>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">汇率</label>
                        <div class="col-6">
                            <input type="text" autocomplete="off" class="form-control" data-rule="pnumber" disabled
                                   placeholder="请输入汇率" maxlength="40" name="iExchangeRate"
                                   value="#(subcontractOrderM.iexchangerate??)"/>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">订单编号</label>
                        <div class="col-6">
                            <input type="text" data-notnull="true" data-tips="请输入订单编号" autocomplete="off" class="form-control" disabled
                                   placeholder="请输入订单编号" maxlength="40" name="cOrderNo"  readonly="readonly" value="#(subcontractOrderM.corderno??)"/>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">部门</label>
                        <div class="col-6">
                            <select class="form-control" disabled
                                    data-autoload
                                    name="iDepartmentId"
                                    data-tips="请选择部门"
                                    data-rule="required"
                                    data-url="admin/department/getTreeTableDatas"
                                    data-text="=请选择部门="
                                    data-value=""
                                    data-value-attr="iautoid"
                                    data-text-attr="cdepname"
                                    data-select="#(subcontractOrderM.idepartmentid??)">
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">应付类型</label>
                        <div class="col-6">
                            <select class="form-control" name="iPayableType" disabled
                                    data-autoload
                                    data-rule="required"
                                    data-url="admin/dictionary/options?key=purchase_coping_type"
                                    data-select-type="select"
                                    data-select="#(subcontractOrderM.ipayabletype??)"
                                    data-text="==请选择=="
                                    data-text-attr="name"
                                    data-value-attr="sn">
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">备注</label>
                        <div class="col-6">
                            <textarea disabled class="form-control" style="height:80px"  placeholder="请输入备注" data-tips="请输入备注"  maxlength="200" name="cMemo">#(subcontractOrderM.cmemo??)</textarea>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </form>


    #setLocal(jboltTabId=(goods.id?? RandomUtil.random(6)))
    <nav>
        <div class="nav nav-tabs" id="nav-tab_#(jboltTabId)" role="tablist">
            <a class="nav-item nav-link active" id="nav-base-tab_one" data-toggle="tab" href="#tab-one" role="tab" aria-controls="tab-one" aria-selected="true">订货清单</a>
            <a class="nav-item nav-link" id="nav-base-tab_two" data-toggle="tab" href="#tab-two" role="tab" aria-controls="tab-two" aria-selected="false">传票更改清单</a>
        </div>
    </nav>
    <div class="tab-content" style="padding: 0px 1rem">
        <!--1 订货清单 -->
        <div class="tab-pane fade show active" id="tab-one" role="tabpanel" aria-labelledby="nav-base-tab_one">
            #render("cash_table.html")
        </div>
        <!--2 传票更改清单 -->
        <div class="tab-pane fade" id="tab-two" role="tabpanel" aria-labelledby="nav-base-tab_two">
            #render("cash_version_table.html")
        </div>
    </div>


    </div>
</div>
#end

#define js()
<script>
    // 标记是否能修改  1不能进行任何操作
    var index = 0;
    // 隐藏第一个按钮
    hideParentLayerDialogBtn(0);

    function removeRow(ele) {
        var flag = jboltTableRemoveRow(ele);
        if (flag){
            index = 0;
        }
    }

    function saveRow(subcontractOrderMId, id, version) {
        var qty = $("#"+id).val();
        if (qty<=0){
            LayerMsgBox.alert("包装数量不能小于0",2);
            return ;
        }
        Ajax.post('/admin/subcontractorderm/updateOrderBatch', {
            subcontractOrderMId: subcontractOrderMId,
            id: id,
            cVersion: version,
            qty: qty
        },  function(ret) {
                if (ret.state == 'ok'){
                    index = 0;
                    refreshPjaxContainer();
                }
        });
    }

    function InsertEmptyRow(csourceld, version, qty, iseffective,ele,forceTrChange){
        console.log("id---" +csourceld);
        if (index == 1){
            LayerMsgBox.alert("请操作完后，再进行下一步操作",2);
            return ;
        }
        if (iseffective == 0){
            LayerMsgBox.alert("已失效的现品票，不能再进行下一步操作",2);
            return ;
        }
        var newVersion = Number(version)+1;
        if (newVersion<10){
            newVersion = '0' + newVersion;
        }
        var table=getJBoltTable(ele);
        if(isOk(table)){
            var jboltTable=table.jboltTable("inst");
            if(jboltTable){
                var action=getRealJqueryObject(ele),tr;
                if(isOk(action)){
                    var success = checkMasterTableId(action);
                    if(!success){
                        return false;
                    }
                    //如果是在表格里触发的
                    if(isOk(action.closest("table[data-jbolttable]"))){
                        tr = action.closest("tr");
                    }else if(isOk(action.closest(".jbolt_table_fixed"))){
                        var fixtr = action.closest("tr");
                        var fixTrIndex = fixtr.index();
                        tr=jboltTable.tbody.find("tr:nth-child("+(fixTrIndex+1)+")");
                    }
                }
                index = 1;
                return insertRows(jboltTable,tr,{
                    cversion: newVersion,
                    iqty: qty,
                    csourceld: csourceld
                },false,forceTrChange);;
            }
        }
        LayerMsgBox.alert("表格组件配置异常",2);
        return false;
    }

    function insertRows(table,tr,insertEmptyData,insertToBefore,forceTrChange){
        var canInsertTr=table.me.checkCanInsertNewTr(table,1);
        if(canInsertTr){
            //处理thead里的checkbox uncheck
            table.me.processUnCheckTheadCheckbox(table);
            var insertDefaultValues=table.editableOptions.insertDefaultValues;
            if(insertDefaultValues){
                insertEmptyData=table.me.deepClone(insertDefaultValues);
            }
            var tempTr=table.me.insertRowData(table,tr,insertEmptyData,false,insertToBefore);
            if(isOk(tempTr)){
                table.me.processTableIndexColumn(table);
                table.me.processInsertRowTableListData(table,tempTr,insertEmptyData,insertToBefore);
                table.me.initEditableHSummarys(table,tempTr);
                table.me.processTfootSummarys(table);
                //处理change状态
                table.me.processNewInsertTrEditableTdsChanged(table,tempTr,insertEmptyData,forceTrChange);
                //处理新插入的行重新设置宽度
                table.me.resizeTrByOldWidth(table,tempTr);
                //处理动态插入数据后的handler
                table.me.processEditableTableAfterInsertRowHandler(table,tempTr);
            }
            return tempTr;
        }
        return false;
    }

    function getEditableTableOptions2_#(pageId)(){
        var editableTableOptions={
            trigger:"click",
            //初始行数
            //插入数据时默认属性值
            //insertDefaultValues:{age:10,briefInfo:"xxxxx"},
            cols:{
                id:{
                    submitAttr:"id",
                },
                index:{
                    submitAttr: "index"
                }
            }
        };
        return editableTableOptions;
    }
    function updateIsEnabled(ele) {
        $("#isEnabled_#(pageId)").val(ele.data("value"));
        Ajax.post('/admin/subcontractorderm/updateHideInvalid', {
            hideInvalid: ele.data("value"),
            id: '#(subcontractOrderM.iautoid??)'
        },  function(ret) {
            jboltTableRefresh();
        });
    }
</script>
#end

