<script>

    function getEditableTableOptions_workposition(){
        var editableTableOptions={
            trigger:"click",
            initRowCount:0,
            maxRowCount:9999,
            //keepCellStyleCols:[1,2,3,"total","enable"],//不可填 但是也不需要设置不可填样式的列
            submit:{
                withForm:["ManualOrderM_Form_#(pageId)"],
                name:"manualorderd",
                type:"all",//cell|all
                //params:{"masterautoid":'#(masterautoid)'},//携带其他额外参数
                //commonAttr:{"save":{"update_time":new Date().getTime(),"autoId":1}},//给save或者update的时候 表格每一行数据 都添加指定的属性一并提交
                url:"admin/manualorderm/save",
                success:function(res){
                    // 表格保存之后，判断是否需要提审处理
                    if (res.state === 'ok') {
                        // 提交审核（审批）调用
                        if (submit) {
                            // 提审
                            submit_#(pageId)(res.data.iautoid, function (data) {
                                successHandler('提审成功', res.data.iautoid);
                            });
                        } else {
                            successHandler(res.msg, res.data.iautoid);
                        }
                    } else {
                        LayerMsgBox.alert(res.msg, 2);
                    }
                }
            },
            //插入数据时默认属性值
            //insertDefaultValues:{age:10},
            cols:{
                iautoid:{
                    submitAttr:"iautoid",
                },
                cinvcode:{
                    required:true,
                    type:"dialogbtn",
                    placeholder:"选择存货",
                    maxLength:100,
                    dialog:{
                        url:"admin/manualorderm/inventory_dialog_index",
                        area:"80%,80%",
                        title:"选择存货",
                        btn:"选择,关闭"
                    },
                    columnAttr:"iinventoryid,cinvcode1,cinvname1,cinvstd,cuomname",
                    changeColumns: [
                        {column:"cuomname",use:"cuomname"},
                        {column:"cinvstd",use:"cinvstd"},
                        {column:"cinvname1",use:"cinvname1"},
                        {column:"cinvcode1",use:"cinvcode1"},
                        {column:"iinventoryid",use:"iautoid"},
                    ]
                },
                iqty1: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty2: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty3: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty4: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty5: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty6: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty7: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty8: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty9: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty10: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty11: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty12: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty13: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty14: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty15: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty16: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty17: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty18: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty19: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty20: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty21: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty22: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty23: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty24: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty25: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty26: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty27: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty28: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty29: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty30: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                iqty31: {
                    type: "input_number",
                    rule: "fix<= #(precisionConfig1)",
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }],
                },
                isum: {
                    summary: [{
                        dir: "v",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "sum"
                    }, {
                        dir: "h",
                        tofixed: #(precisionConfig1),
                        roundtag: "round",
                        removezero: true,
                        formula: "iqty1+iqty2+iqty3+iqty4+iqty5+iqty6+iqty7+iqty8+iqty9+iqty10+iqty11+iqty12+iqty13+iqty14+iqty15+iqty16+iqty17+iqty18+iqty19+iqty20+iqty21+iqty22+iqty23+iqty24+iqty25+iqty26+iqty27+iqty28+iqty29+iqty30+iqty31"
                    }],
                },
            }
        };
        return editableTableOptions;
    }

    /**
     * 新增/修改/提审
     */
    function successHandler(msg, iautoid) {
        LayerMsgBox.success(msg, 600, function () {
            // 新增/修改，均跳转到详情页
            location.href = '/admin/manualorderm/edit?iautoid=' + iautoid + '&_jb_rqtype_=dialog';
            parent.refreshPjaxContainer();
        });
    }

    function uploadHandler(uploader, type, fileInput, res) {
        jboltTableClear("#manualorderd_#(pageId)");

        var data = res.data;
        if (!data || data.length === 0) {
            LayerMsgBox.alert('导入数据不能为空', 2);
            return;
        }

        var arr = [];

        $.each(data, function (idx, row) {
            if (row.cinvcode1) {
                arr.push(row.cinvcode1);
            }
        });

        var para = {
            cinvcode1: arr.join(',')
        };

        var index = LayerMsgBox.loading('正在匹配存货信息...', 10000);

        Ajax.post('admin/inventory/fetchByCinvcode1s', para, function (ret) {

            LayerMsgBox.close(index);

            if (ret.state === 'ok') {

                // 导入行数据
                $.each(data, function (idx, r) {

                    // 存货数据
                    $.each(ret.data, function (idx, row) {

                        if (r.cinvcode1 === row.cinvcode1) {
                            if (row.cnt === 0) {
                                r.error = '部品番号不存在！';
                            } else if (row.cnt === 1) {
                                r.iinventoryid = row.iautoid;
                                r.cinvcode = row.cinvcode;
                                r.cinvcode1 = row.cinvaddcode;
                                r.cinvname1 = row.cinvname1;
                                r.cinvstd = row.cinvstd;
                            } else {
                                r.error = '存在' + row.cnt + '条匹配的存货记录，请手工选择存货！';
                            }
                        }

                    });

                    if (!r.error) {
                        if (r.cinvcode1 && !r.iinventoryid) {
                            r.error = '部品番号缺少对应存货！';
                        }
                    }

                    // 数量精度处理
                    $.each(r, function (key, val) {
                        if (key.startsWith('iqty')) {
                            var iqty = parseFloat(val);
                            iqty = parseFloat(iqty);
                            r[key] = iqty.toFixed(0);
                        }
                    });

                });
                console.log(data)

                jboltTableInsertRow('#manualorderd_#(pageId)', data);
            } else {
                LayerMsgBox.alert(ret.msg, 2);
            }
        }, function () {
            LayerMsgBox.close(index);
        });
    }

    /**
     * 检查明细
     */
    function checkDetails(ele) {
        var rowDatas = jboltTableGetAllDatas(ele);

        if (rowDatas && rowDatas.length > 0) {
            $.each(rowDatas, function (idx, row) {

                if (row.iinventoryid) {
                    removeClass(idx);
                }
            });
        } else {
            LayerMsgBox.alert('请维护导入数据!', 2);
        }
    }

    function removeClass(idx) {
        console.log(idx);
        var $tr = $('tr[data-index="' + idx + '"]');
        $tr.removeAttr('tooltip');
        $tr.removeAttr('title');
        $tr.removeClass('table-danger');
    }

    /**
     * 保存清空错误数据
     * @param ele
     */
    function saveData(ele) {
        var rowDatas = jboltTableGetAllDatas(ele);
        removeEmptyRow(ele, rowDatas);
        jboltTableSubmit(ele);
    }

    function removeEmptyRow(ele, datas) {
        var count = 0;
        $.each(datas, function (idx, row) {
            if (!row.iiventoryid) {
                count++;
            }
        });

        for (var i = 0; i < count; i++) {
            delRow(ele);
        }
    }

    function delRow(ele) {
        var datas = jboltTableGetAllDatas(ele);
        if (datas && datas.length > 0) {
            var jboltTable = getJBoltTable(ele)
            var table = getJBoltTableInst(jboltTable);

            for (var i = 0; i < datas.length; i++) {
                var data = datas[i];
                if (!data.iinventoryid) {
                    table.me.removeRow(table, i);
                    break;
                }
            }
            return true;
        }
        return false;
    }

    /**
     * 根据币种设置汇率
     */
    function setExchangeRate() {
        var cexchname = $('select[name="manualOrderM.cCurrency"]').find("option:selected").text();
        if (cexchname && cexchname != null) {
            Ajax.get("/admin/exch/getNflatByExchName?cexchname=" + cexchname, function (ret) {
                if (ret.state === 'ok') {
                    $('input[name="manualOrderM.iExchangeRate"]').val(ret.data.nflat);
                } else {
                    $('input[name="manualOrderM.iExchangeRate"]').val(0);
                }
            });
        } else {
            $('input[name="manualOrderM.iExchangeRate"]').val(0);
        }
    }
</script>