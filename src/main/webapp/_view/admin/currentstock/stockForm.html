#set(pageId=RandomUtil.random(6))

<div class="jbolt_page_content">
    
    <div class="row">
        <div class="col-10 text-left">

                #if(readonly != 'readonly')
                <button onclick="submitThisForm_#(pageId)(false)" class="btn btn-outline-secondary btn-xs">保存</button>
                #end
                <button onclick="closeHandler()" class="btn btn-outline-secondary btn-xs">关闭</button>

                #if(stockchekvouch.autoid??)
                ### 参数列表
                ### uri:                    接口URI
                ### formSn:                 表单名
                ### o:                      当前表单对象名
                ### primaryKeyName:         主键名
                ### permissionKeyPrefix:    权限key
                ### redonly:                查看页定义为readonly=readonly, 新增/编辑页 可不传
                ### className:              实现审批业务的类名
                #include("/_view/_common/_approval_btns.html", uri="/admin/stockcheckvouch", formSn="T_Sys_StockCheckVouch", o=stockchekvouch, primaryKeyName="AutoID", className="cn.rjtech.admin.currentstock.CurrentStockService",permissionKeyPrefix="current_stock")
                #end

        </div>
    </div>

    <div class="row">
        <form class="form-inline text-left" onsubmit="return false;" id="StockCheckVouchForm_#(pageId)" action="#(action)" method="post">

            #if(stockchekvouch.autoid??)
            <input type="hidden" id="stockchekvouchAutoid" name="stockchekvouch.autoid" value="#(stockchekvouch.autoid??)"/>

            #end
            <input type="hidden" id="autoid" name="autoid" value="#(stockchekvouch.autoid??)"/>
            <input type="hidden" id="whcode" name="whcode" value="#(stockchekvouch.whcode??)"/>
            <input type="hidden" id="poscodes" name="poscodes" value="#(stockchekvouch.poscodes??)"/>
            <input type="hidden" id="checktype" name="checktype" value="#(stockchekvouch.checktype??)"/>

            <input type="text" autocomplete="off" class="form-control" placeholder="=库位名称=" name="posname" value=""/>
            <input type="text" autocomplete="off" class="form-control" placeholder="=盘点状态=" name="status" value=""/>
            <input type="text" autocomplete="off" class="form-control" placeholder="=料品分类=" name="addinvclass" value=""/>
            <input type="text" autocomplete="off" class="form-control" placeholder="=存货编码=" name="invcode" value=""/>
            <input type="text" autocomplete="off" class="form-control" placeholder="=存货名称=" name="invname" value=""/>

            <button id="query" type="submit" class="btn btn-light"><i class="fa fa-search"></i> 查询</button>
        </form>
    </div>
</div>

<div class="jbolt_page_content">

    <textarea class="jb_tpl_box" id="StockCheckVouchDetail_tpl_#(pageId)">
    {@each datas as data,index}
    <tr data-id="${data.autoid}" {@if data.masid == null} data-changed="true" data-needsave="true" {@/if}>
        <td>${pageNumber,pageSize,index | rownum}</td>
        <td>${data.posname}</td>
        <td>${data.cinvccode}</td>
        <td>${data.cinvcname}</td>
        <td>${data.invcode}</td>
        <td>${data.cinvcode1}</td>
        <td>${data.cinvname1}</td>
        <td>${data.cinvstd}</td>
        <td>${data.cuomname}</td>
        <td>${data.qty}</td>
        {@if data.checktype == 1}
        <td></td>
        <td></td>
        {@else}
        <td>${data.checktype=='1'?'':data.stockqty}</td>
        <td>${data.checktype=='1'?'':data.plqtyqty}</td>
        {@/if}
        {@if data.stockstatus == null}
        <td>${data.stockstatus?data.stockstatus:'未盘点'}</td>
        {@else}
        <td>${data.stockstatus=='已盘点'?'已盘点':'未盘点'}</td>
        {@/if}
        <td hidden>${data.poscode}</td>
    </tr>
    {@/each}
	</textarea>

    <!-- 工具条 toolbar -->
    <div class="jbolt_table_toolbar" id="fh_toolbar_#(pageId)">
        <div class="clearfix"></div>
    </div>

    <table class="jbolt_table jbolt_main_table table-center"
           id="jbolt_table_#(pageId)"
           data-jbolttable
           data-height="250"
           data-ajax="true"
           data-width="auto"
           data-url="admin/currentstock/StockCheckVouchDetailDatas?mid=#(bill.autoid)"
           data-column-resize="true"
           data-column-prepend="1:checkbox:true"
           data-conditions-form="StockCheckVouchForm_#(pageId)"
           data-rowtpl="StockCheckVouchDetail_tpl_#(pageId)"
           data-toolbar="fh_toolbar_#(pageId)"
           data-editable-option="getEditableTableOptions_#(pageId)"
           data-editable="true"
    >
        <thead class="thead-blue">
        <tr>
            <th data-width="60" data-column="index">序号</th>
            <th data-width="150" data-column="posname">库位名称</th>
            <th data-width="150" data-column="invclasscode">存货分类编码</th>
            <th data-width="150" data-column="addinvclass">存货分类名称</th>
            <th data-width="150" data-column="invcode">存货编码</th>

            <th data-width="150" data-column="cinvcode1">客户部番</th>
            <th data-width="150" data-column="invname1">部品名称</th>
            <th data-width="150" data-column="invstd">规格</th>
            <th data-width="110" data-column="unitname">主计量单位</th>

            <th data-column="qty">库存数量</th>
            <th data-column="stockqty">盘点数量</th>
            <th data-column="plqtyqty">盈亏数量</th>
            <th data-column="stockstatus">盘点状态</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    </div>
#include("tockchekvouchForm.html")


#define js()
<script>

    // 保存是否提审处理，默认为false, 在点击提审时，修改此变量值
    var submit = false;
    function submitThisForm_#(pageId)(ele) {
        submit = ele;
        submitAllTables_#(pageId)();
    }

    function submitAllTables_#(pageId)(){
        var index = LayerMsgBox.loading('执行中...');

        var tables = [
            "jbolt_table_#(pageId)",
            "jbolt_table_StockCheckVouchBarcode_split_#(pageId)"
        ];

        // var table1SubmitData = jboltTableGetSubmitData('#jbolt_table_#(pageId)');
        // console.log(JSON.stringify(table1SubmitData));
        //
        // table1SubmitData.save = jboltTableGetAllDatas('#jbolt_table_#(pageId)');
        //
        // var table2SubmitData = jboltTableGetSubmitData('#jbolt_table_StockCheckVouchBarcode_split_#(pageId)');
        // console.log(JSON.stringify(table2SubmitData));
        //
        // var para = {
        //     table1: table1SubmitData,
        //     table2: table2SubmitData
        // };
        //
        // var arg = {
        //     jboltTables: JSON.stringify(para),
        // }
        jboltTableSubmitMulti(tables, "admin/currentstock/saveTableSubmit", function (res) {
            if (res.state == "ok") {
                LayerMsgBox.success(res.msg, 2000, function () {
                    let autoid = res.AutoID;
                    if (submit){
                        submit_#(pageId)(autoid,function () {
                            LayerMsgBox.success("提交成功", 600, function () {
                                parent.refreshPjaxContainer();
                                self.location.href = '/admin/currentstock/stockEdit/' + res.AutoID + '-_jb_rqtype_dialog';
                            });
                        });
                    } else {
                        parent.refreshPjaxContainer();
                        self.location.href = '/admin/currentstock/stockEdit/' + res.AutoID + '-_jb_rqtype_dialog';                    // parent.layer.close(parent.layer.getFrameIndex(window.name)); //关闭弹窗
                    }
                })
            } else {
                LayerMsgBox.error(res.msg);
            }
        });
    }

    // 子表查询表单
    var stockcheckvouchdid = $('#stockcheckvouchdid');
    // 避免触发重复点击行事件的处理
    var clicked = false;

    $(function(){
        var status='#(bill.status)';

        if(status==0){
            addParentLayerDialogBtn("完成盘点","lay_success",function(){
                var mid='#(bill.autoid)';

                Ajax.post('admin/currentstock/okCheck', {"mid":mid}, function (ret) {
                    parent.refreshPjaxContainer();
                    parent.layer.closeAll();
                });
            });

            addParentLayerDialogBtn("保存记录","lay_success",function(){
                var sourceid=$("#stockcheckvouchdid").val();

                //获取选中表格数据
                var para = jboltTableGetCheckedDatas('#stock__table_#(pageId)');
                if(para){
                    Ajax.post('admin/stockcheckdetail/adjust',{"datas":JSON.stringify(para),"sourceid":sourceid} , function (ret) {
                        refreshPjaxContainer();
                    });
                }
            });

        }else if(status==1){
            addParentLayerDialogBtn("驳回","lay_success",function(){
                var mid='#(bill.autoid)';

                Ajax.post('admin/currentstock/regret', {"mid":mid}, function (ret) {
                    parent.refreshPjaxContainer();
                    parent.layer.closeAll();
                });
            });

            addParentLayerDialogBtn("审核通过","lay_success",function(){
                var mid='#(bill.autoid)';

                Ajax.post('admin/currentstock/agree', {"mid":mid}, function (ret) {
                    parent.refreshPjaxContainer();
                    parent.layer.closeAll();
                });
            });

        }
    });

    function checkRow(ele) {
        console.log('ch')
        var checkCol = $(ele).find("td>.jbolt_table_radio>input[type='radio']").first();

        if (checkCol.prop('checked')) {
            checkCol.prop('checked', '');
            checkCol.parent().removeClass('checked');
        } else {
            checkCol.prop('checked', 'checked');
            checkCol.parent().addClass('checked');
        }
    }

    //条码明细
    function getEditableTableOptions_#(pageId)(){
        var editableTableOptions = {
            trigger: "click",
            //初始行数
            initRowCount: 0,
            submit:{
                withForm: ["StockCheckVouchForm_#(pageId)"],
                type:"multi",//cell|all|multi
                name:"table1"
            },
            //插入数据时默认属性值
            cols: {
                qty: {
                    textAttr: "qty"
                },
                stockqty: {
                    textAttr: "stockqty"
                },
                plqtyqty:{
                    submitAttr:"plqtyqty",
                    summary:[
                        {
                            dir:"h",//纵向统计  v or h
                            tofixed:6,//保留两位
                            roundtag:"round",//四舍五入
                            removezero:true,//去0
                            formula:"qty-stockqty",//计算表单式 sum or avg
                        }
                    ],
                },



            }
        };
        return editableTableOptions;
    }

    function masterTableTrTriggerShowSlaveExt(ele, autoid) {
        if (!clicked) {
            clicked = true;

            stockcheckvouchdid.val(autoid);
            // 清空表格数据（再加载）
            jboltTableClear('#stock__table_#(pageId)');

            checkRow(ele);

            $("#dTable").click();
            clicked = false;
        }
    }
</script>
#end

