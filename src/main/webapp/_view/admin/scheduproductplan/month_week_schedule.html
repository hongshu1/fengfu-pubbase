#@jboltLayout()
#define css()
<link href="assets/plugins/Grape/16.0.2/css/gc.spread.sheets.16.0.2.css" rel="stylesheet">
<link rel="stylesheet" href="assets/js/pagination/layui/layui.css">
<link rel="stylesheet" href="assets/icon/bootstrap-icons/font/bootstrap-icons.min.css">
<style>
    .spread-container {
        height:69vh;
    }

    .gc-statusbar {
        height: 25px;
        min-height: 25px;
        background: #217346;
        font-size: 0.6rem;
        color: aliceblue;
    }
    body,p {
        margin: 0px;
        padding: 0px;
        font-size: 12px;
        color: black;
    }

    #box {
        height: 100vh;
        font-weight: bold;
    }

    .span {
        color: #333333;
    }

    .select:nth-child(1) {
        margin-left: 10px;
    }

    /* 搜索重置按钮样式 */
    .button {
        padding: 3px 10px;
        background-color: #fff;
        border: #797979 1px solid;
    }

    /* 表格工具 */
    .but_box {
        padding: 15px 0px;
        padding-left: 15px;
        border-bottom: none;
    }

    /* 表格按钮 */
    .but_box button {
        padding: 3px 10px;
        margin-right: 8px;
        border-radius: 5px;
    }
    /*  锁定弹出框样式  */
    #alert{
        border: 1px solid rgba(215, 215, 215, 1);
        border-radius:5px;
        box-shadow:0 0 10px rgba(0, 0, 0, 0.5);
        background-color:#fff;
        width: 430px;
        height: 190px;
        z-index: 1000;
        position: absolute;
        display: none;
    }
    #alert .alert_title{
        display: flex;
        font-size: 14px;
        border-bottom: 3px solid rgba(215, 215, 215, 1);
        padding: 7px 0px;
        text-indent: 0.8rem
    }
    #alert .alert_title span:nth-child(1){
        flex: 1;
    }
    #alert .alert_title #close{
        font-size: 18px;
        margin-right: 10px;
        cursor: pointer;
    }
    #alert .alert_but{
        width: 100%;
    }
    #alert .alert_but button{
        margin: 10px 10px;
        padding: 3px 13px;
        background-color: #fff;
        border: #797979 1px solid;
        border-radius: 5px;
        float: right;
    }
    /*    */
    .popup-layer{
        border: 1px solid rgba(215, 215, 215, 1);
        background-color:#fff;
        border-radius: 10px;
        width: 560px;
        height: 400px;
        padding: 20px;
        z-index: 1000;
        position: absolute;
        overflow-y: scroll;
        display: none;
    }
    .popup-confirm{
        margin-bottom: 20px;
    }
    #popup_table{
        text-align: center;
        margin-bottom: 20px;
    }
    #popup_table tr{
        height: 40px;
    }
    /* 遮罩层样式 */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9;
        display: none;
    }

    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: none;
        max-width: 400px;
        width: 90%;
    }

    .popup p {
        margin-bottom: 10px;
        margin-top: 0px;
        display: flex;
        align-items: center;
        font-size: 16px;
    }

    .popup p span:nth-child(1) {
        flex: 1;
    }

    .popup p span:nth-child(2) {
        font-size: 20px;
        cursor: pointer;
    }

    input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        margin-bottom: 10px;
    }

    .buttons {
        float: right;
        width: 80px;
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
    }

    .buttons:hover {
        background-color: #0056b3;
    }
    .btn-success{
        background-color: #28a745;
        border-color: #28a745;
    }
</style>
#end

#define main()
#set(pageId=RandomUtil.random(6))
<div class="jbolt_page" data-key="#(pmkey)" >
    <div class="jbolt_page_title">
        <!-- 搜索工具类开始 -->
        <div class="but_box">
            <span>产线名称:</span>
            <input style="width:150px;height:2rem;" id="cworkname"/>
            <span>存货编码:</span>
            <input style="width:150px;height:2rem;" id="cinvcode"/>
            <span>客户部番:</span>
            <input style="width:150px;height:2rem;" id="cinvcode1"/>
            <span>部品名称:</span>
            <input style="width:150px;height:2rem;" id="cinvname1"/>
            <span>排产层级:</span>
            <select id="search_level" style="width: 150px;height: 2rem">
                <option value="1">全部</option>
                <option value="1">层级1</option>
                <option value="2">层级2</option>
                <option value="3">层级3</option>
                <option value="4">层级4</option>
                <option value="5">层级5</option>
            </select>
            <span>日期：</span>
            <div style="margin-right: 20px;display:inline-block;">
                <div style="display:flex;">
                    <input type="date" id="search_start-time" name="search_start-time" style="height:2rem;">
                    <p style="width: 30px;text-align: center;margin-top: 5px">至</p>
                    <input type="date" id="search_end-time" name="search_end-time" style="height:2rem;">
                </div>
            </div>
            <button class="button" onClick="search()" style="padding: 5px 20px;color: #fff;background-color: #28a745;border-color: #28a745;">
                <i class="bi bi-search"></i>
                搜索
            </button>
            <button class="button" onClick="reset()" style="padding: 5px 20px;color: #fff;background-color: #1989fa;border: 1px solid #1989fa;">
                <i class="bi bi-snow3"></i>
                重置
            </button>
        </div>
    <div class="jbolt_page_content">
        <div class="sample-container">
            <!-- 表格 -->
            <div id="table-tool">
                <!-- 表格工具开始 -->
                <div class="but_box">
                    <button onClick="openPopup()" style="border: #797979 1px solid;padding: 6px 19px;background-color: transparent;">
                        <i class="bi bi-arrow-repeat"></i>
                        排产
                    </button>
                    <button onClick="excelFileSave()" style="border: #797979 1px solid;padding: 6px 10px;background-color: #ffc107;border-color: #ffc107;">
                        <i class="bi bi-box-arrow-up-right"></i>
                        数据导出
                    </button>
                    <button id="loadExcel" style="border: #797979 1px solid;padding: 6px 10px;background-color: #ffc107;border-color: #ffc107;">
                        <i class="bi bi-box-arrow-in-left"></i>
                        数据导入
                    </button>
                    <button onClick="saveLevel()" class="btn-success btn" style="padding: 4px 15px">
                        <i class="bi bi-check2-square"></i>
                        保存层级
                    </button>
                    <button style="padding:6px 20px;background-color: transparent;border:#797979 1px solid">
                        <i class="bi bi-arrow-repeat"></i>
                        计划使用刷新
                    </button>
                    <button id="content" onClick="lock()" style="padding:6px 20px;background-color: transparent;border:#797979 1px solid">
                        <i class="bi bi-bag-x"></i>
                        锁定
                    </button>
                    <button onClick="unLock()" onClick="lock()" style="padding:6px 20px;background-color: transparent;border:#797979 1px solid">
                        <i class="bi bi-bag-check"></i>
                        </svg>
                        解锁
                    </button>
                    <button onClick="freezingCol()" onClick="lock()" style="padding:6px 20px;background-color: transparent;border:#797979 1px solid">
                        <i class="bi bi-snow3"></i>
                        冻结列
                    </button>
                    <button onClick="removeFreezingCol()" onClick="lock()" style="padding:6px 20px;background-color: transparent;border:#797979 1px solid">取消冻结列</button>
                </div>
                <!-- 创建表格目标DOM元素，id为ss的HTML -->
                <div id="ss" class="spread-container"></div>
                <div id="statusBar" class="gc-statusbar"></div>
            </div>
        <!--锁定弹框-->
        <div id="alert">
            <p class="alert_title"><span id="title"></span><span id="close">X</span></p>
            <div class="select" style="margin-top: 15px;margin-left: 20px;margin-bottom: 15px;">
                <form>
                    <div class="form-group row" style="margin-top: 20px;display: flex;margin-bottom: 0px">
                        <span style="display:block;line-height: 25px;margin-left: 15px">截止日期：</span>
                        <select id="mySelect" style="width:180px">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </form>
            </div>
            <div style="text-indent: 1.5rem">
                <span>周次：</span>
                <span id="weekNum">第二周</span>
            </div>
            <p class="alert_but">
                <button id="close_but" style="padding: 7px 20px">取消</button>
                <button onClick="save()" style="color: #fff;background-color: #1989fa;border: 1px solid #1989fa;padding: 7px 20px">确定</button>
            </p>
        </div>
        <!-- 排产弹出层 -->
        <div class="popup-layer" id="popup-layer">
            <!-- 确定按钮 -->
            <div style="width: 100%;margin-bottom: 20px;">
                <button class="button" onclick="savePopup()">确定</button>
                <button class="button" onclick="closePopup()">取消</button>
            </div>
            <!-- 表格 -->
            <div style="display: flex">
                <p style="float: left;width: 70px">已排层级：</p>
                <table id="popup_table" class="layui-table">
                    <thead>
                    <tr>
                        <th>排产层级</th>
                        <th>排产截止时间</th>
                        <th>锁定截止时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="layer_tr"></tbody>
                </table>
            </div>
            <!-- 下拉框 -->
            <div class="popup-select">
                <div>
                    <label for="deadline">截止日期：</label>
                    <input type="date" id="datetime-local" name="datetime-local" style="display: inline-block; width: 200px">
                </div>
                <div>
                    <label for="level">排产层级：</label>
                    <select id="level">
                        <option value="1">层级1</option>
                        <option value="2">层级2</option>
                        <option value="3">层级3</option>
                        <option value="4">层级4</option>
                        <option value="5">层级5</option>
                    </select>
                </div>
            </div>
        </div>
        <!--排产弹出框结束-->
        <!--导出弹出框开始-->
        <div class="overlay" id="overlay"></div>
        <div class="popup" id="popup">
            <p><span>请输入导出表格名称</span><span onClick="hidePopup()">x</span></p>
            <input type="text" placeholder="请输入名称" id="input">
            <p style="margin: 0px;padding: 0px;"><input type="checkbox" id="checkboxId" checked><span style="font-size: 13px !important;">导出是否开启表单保护</span></p>
            <button onclick="submit()" class="buttons" style="float: right;width: 60px">确定</button>
        </div>
        <!--导出弹出框结束-->
        <!--导入弹出框开始-->
        <div class="overlay" id="overlay"></div>
        <div class="popup" id="popup1">
            <p><span>请上传要导入的文件</span><span onClick="hidePopup()">x</span></p>
            <input type="file" id="fileDemo" class="input">
            <button onclick="importSubmit()" class="buttons" style="float: right;width: 60px">确定</button>
        </div>
        <!--导入弹出框结束-->
        <!--锁定列开始-->
        <div class="overlay" id="overlay"></div>
        <div class="popup" id="popup2">
            <p><span id="colTitle">请选择要锁定的列</span><span onClick="hidePopup()">x</span></p>
            <input type="text" id="lockCol">
            <button onclick="lockColSubmit()" class="buttons" style="float: right;width: 60px">确定</button>
        </div>
        <!--锁定列结束-->
    </div>
</div>
#end

#define js()
<script type="text/javascript" src="assets/plugins/Grape/gc.spread.sheets.all.12.0.7.min.js"></script>
<script type="text/javascript" src="assets/plugins/Grape/gc.spread.excelio.12.0.7.min.js"></script>
<script type="text/javascript" src="assets/plugins/Grape/FileSaver.min.js"></script>
<script type="text/javascript">
    /**
     * @param Api 公共接口
     */
    const Api = '/';
    /**
     * @param urlParams 获取跳转携带的参数
     * @param id 跳转携带的id
     */
    window.onload=function () {
        const urlParams = new URLSearchParams(window.location.search);
        const ilevel = urlParams.get('level');
        if(ilevel!=null){
            parms.level=ilevel;
            initData(ilevel);
            initDate();
            loadInit();
        }
        let searchStartTime = document.getElementById('search_start-time');
        // 获取当前日期
        var currentDate = new Date();
        // 设置日期为当前月的1号
        currentDate.setDate(1);
        // 获取1号的时间戳（单位：毫秒）
        var timestamp = currentDate.getTime();
        // 转换为Date对象
        var date = new Date(timestamp);
        // 获取年、月、日
        var year = date.getFullYear();
        var month = date.getMonth() + 1; // 月份从0开始，需要加1
        var day = date.getDate();
        // 拼接成年月日格式
        var formattedDate = year + '-' + month.toString().padStart(2, '0') + '-' + day.toString().padStart(2, '0');
        searchStartTime.value = formattedDate;
    }
    var spread = new GC.Spread.Sheets.Workbook(document.getElementById('ss'), {sheetCount: 1,calcOnDemand: true});
    var excelIo = new GC.Spread.Excel.IO();//开启导入导出api
    spread.options.referenceStyle = GC.Spread.Sheets.ReferenceStyle.r1c1;
    //设置状态栏
    var statusBar = new GC.Spread.Sheets.StatusBar.StatusBar(document.getElementById('statusBar'));
    var sheet = spread.getSheet(0);//按照下标获取表单
    statusBar.bind(spread);//状态栏
    spread.getSheet(0).setRowCount(50); //设置一列单元格的个数
    spread.getSheet(0).setColumnCount(100); //设置一行有多少个单元格
    spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
    // sheet.options.isProtected = true; // 开启工作表保护
    // sheet.options.protectionOptions.allowEditObject = true; // 允许编辑对象
    // sheet.options.protectionOptions.allowSelectLockedCells = true; // 允许选择锁定单元格
    // sheet.options.protectionOptions.allowSelectUnlockedCells = true; // 允许选择非锁定单元格
    var parmsDefault = {
        id:null,                //全局公共id
        level:'',               //排场层级
        RowCount:24,            //一列多少单元格
        ColumnCount:10,         //一行多少单元格
        rowindex:0,				//x轴索引
        columnindex:0,			//y轴索引
        data: [],				//当月时间数据
        dayRow:10,              //day渲染起始下标
        weekRow:10,             //week渲染起始下标
        tableData:[],           //接收添加的数据
        planListRowIndex:4,     //计划排产列表起始行下标
        planListColIndex:7,     //计划排产列表起始列下标
        getLockDate:[],         //存储锁定计划的全部截止日期
        dschedulebeginData:[],  //已排层级展示数据
        cinvCode:[],            //存储所有存货编码
        dayNumArray:[],         //所有num数组
        planmonthCol:0,         //休息日所在索引
        colArr:[],              //需要拼接的col
    };
    var parmsArr = [Object.assign({},parmsDefault)];
    //添加属性
    parmsArr[0]['spread'] = spread;
    parmsArr[0]['activeSheet'] = spread.getSheet(0);//获取指定的表单
    var parms = parmsArr[0];
    //设置全局表单的背景颜色
    spread.options.grayAreaBackColor = '#fff';
    // let searchStartTime = document.getElementById('search_start-time').value;
    // console.log()
    /*工作簿暂停活性*/
    function spreadSuspend() {
        spread.suspendPaint(); //渲染前失活(提升性能)
        spread.suspendCalcService(false); //暂停计算服务
    }
    /*工作簿开启活性*/
    function spreadResume() {
        spread.resumeCalcService(true); //开启计算服务
        spread.resumePaint(); //恢复绘制
    }
    /**
     * @param freezingCol 打开锁定了弹出层
     */
    function freezingCol(){
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup2").style.display = "block";
    }
    /**
     * @param removeFreezingCol 关闭锁定列弹出层
     */
    function removeFreezingCol(){
        sheet.frozenColumnCount(0);
    }
    /**
     * @param lockColSubmit 提交需锁定的列
     */
    function lockColSubmit(){
        var lockCol = document.getElementById("lockCol").value;
        if(lockCol!=""){
            sheet.frozenColumnCount(lockCol);
            parms.activeSheet.setColumnWidth(5, 210);//设置指定单元格的width
            hidePopup();
        }
    }
    /**
     * @param checkbox 导出表单保护按钮节点
     */
    var checkbox = document.getElementById("checkboxId");
    checkbox.addEventListener("click", function() {
        sheetName = sheet.ITa.name;
        sheet.options.protectionOptions.allowEditObject = true; // 允许编辑对象
        sheet.options.protectionOptions.allowSelectLockedCells = true; // 允许选择锁定单元格
        sheet.options.protectionOptions.allowSelectUnlockedCells = true; // 允许选择非锁定单元格
        if (this.checked) {
            parms["checkbox"] = true;
        } else {
            parms["checkbox"] = false;
        }
    });
    //监听双击单元格
    sheet.bind(GC.Spread.Sheets.Events.CellDoubleClick, function (e, info) {
        let {row,col} = info;
        var cell = sheet.getCell(row,col);
        if(sheet.options.isProtected == true && cell.locked() == true) {
            LayerMsgBox.error("禁止修改",1000);
        }
    });
    /**
     * 数据导入
     * @param loadExcel 按钮节点
     */
    document.getElementById('loadExcel').onclick = function () {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup1").style.display = "block";
    };
    /**
     * 表格数据导出
     * @param excelFileSave
     */
    function excelFileSave() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup").style.display = "block";
        sheet.options.protectionOptions.allowEditObject = true; // 允许编辑对象
        sheet.options.protectionOptions.allowSelectLockedCells = true; // 允许选择锁定单元格
        sheet.options.protectionOptions.allowSelectUnlockedCells = true; // 允许选择非锁定单元格
    };

    /**
     * 提交输入框内容
     * @param submit
     */
    function submit() {
        var fileName = document.getElementById("input").value;//获取用户输入的表格导出名称
        if(fileName!=''){
            if(!parms["checkbox"]){
                //关闭表单保护
                sheet.options.isProtected = false; // 开启工作表保护
                sheet.options.protectionOptions.allowEditObject = false; // 允许编辑对象
                sheet.options.protectionOptions.allowSelectLockedCells = false; // 允许选择锁定单元格
                sheet.options.protectionOptions.allowSelectUnlockedCells = false; // 允许选择非锁定单元格
                fileName += '.xlsx';
                var json = spread.toJSON();//转为json格式
                excelIo.save(json, function (blob) {
                    saveAs(blob, fileName);//转成xlsx
                });
                //重新开启表单保护
                sheet.options.isProtected = true;
                sheet.options.protectionOptions.allowEditObject = true;
                sheet.options.protectionOptions.allowSelectLockedCells = true;
                sheet.options.protectionOptions.allowSelectUnlockedCells = true;
            }else{
                //重新开启表单保护
                sheet.options.isProtected = true;
                sheet.options.protectionOptions.allowEditObject = true;
                sheet.options.protectionOptions.allowSelectLockedCells = true;
                sheet.options.protectionOptions.allowSelectUnlockedCells = true;
                fileName += '.xlsx';
                var json = spread.toJSON();//转为json格式
                excelIo.save(json, function (blob) {
                    saveAs(blob, fileName);//转成xlsx
                });
            }
            hidePopup();
        }
    }
    /**
     * 确定导入文件
     * @param importSubmit
     */
    function importSubmit() {
        var excelFile = document.getElementById("fileDemo").files[0];//获取用户上传文件
        excelIo.open(excelFile, function (json) {
            var workbookObj = json;
            spread.fromJSON(workbookObj);
        }, function (e) {
            alert(e.errorMessage);
        });
        hidePopup();
    }
    /**
     * 隐藏数据导出弹出框
     * @param hidePopup
     */
    function hidePopup() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("popup").style.display = "none";
        document.getElementById("popup1").style.display = "none";
        document.getElementById("popup2").style.display = "none";
        sheet.options.protectionOptions.allowEditObject = true; // 允许编辑对象
        sheet.options.protectionOptions.allowSelectLockedCells = true; // 允许选择锁定单元格
        sheet.options.protectionOptions.allowSelectUnlockedCells = true; // 允许选择非锁定单元格
    }
    /**
     * 初始化产线数据
     * @param loadInit
     */
    function loadInit(){
        //设置全局的列宽行高
        sheet.defaults.colWidth = 80;
        sheet.defaults.rowHeight = 25;
        sheet.frozenRowCount(4); // 将第一行冻结
        //设置单元格内容的对齐方式
        var style = new GC.Spread.Sheets.Style();
        style.hAlign = GC.Spread.Sheets.HorizontalAlign.center;
        style.vAlign = GC.Spread.Sheets.VerticalAlign.center;
        spread.sheets.forEach(function(sheet) {
            sheet.setDefaultStyle(style, GC.Spread.Sheets.SheetArea.viewport);
        });
        //设置value值和该单元格的对齐方式
        var cellType = new GC.Spread.Sheets.CellTypes.CheckBox();//定义多选按钮
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex).cellType(cellType);
        parms.activeSheet.setColumnWidth(parms.columnindex, 40);//设置指定单元格的width
        sheet.addSpan(0,0,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+1).text("序号");
        parms.activeSheet.setColumnWidth(parms.columnindex+1, 60);//设置指定单元格的width
        parms.activeSheet.addSpan(0,1,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+2).text("排产层级");
        parms.activeSheet.addSpan(0,2,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+3).text("产线名称");
        parms.activeSheet.setColumnWidth(parms.columnindex+3, 100);//设置指定单元格的width
        parms.activeSheet.addSpan(0,3,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+4).text("存货编码");
        parms.activeSheet.setColumnWidth(parms.columnindex+4, 100);//设置指定单元格的width
        parms.activeSheet.addSpan(0,4,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+5).text("客户部番");
        parms.activeSheet.setColumnWidth(parms.columnindex+5, 100);//设置指定单元格的width
        parms.activeSheet.addSpan(0,5,4,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+6).text("部品名称");
        parms.activeSheet.setColumnWidth(parms.columnindex+6, 100);//设置指定单元格的width
        parms.activeSheet.addSpan(0,6,4,1);
    }
    /**
     * 初始化产线数据
     * @param initDate
     */
    function initDate(searchData) {
        let url = searchData!=undefined?Api+`admin/scheduproductplanmonth/getTableHead?level=${parms.level}&startDate=${searchData.searchStartTime}&endDate=${searchData.searchEndTime}`
            :`admin/scheduproductplanmonth/getTableHead?level=${parms.level}&startDate=&endDate=`;
        sheet.setValue(3, 9, '项目');
        //获取接口数据
        Ajax.get(url,(res)=>{
            spreadSuspend();//暂停绘制
            let addCol = res.data.day.length+20;
            let addRow = 30;
            parms.RowCount = parms.RowCount+addRow;
            parms.ColumnCount = parms.ColumnCount+addCol;
            spread.getSheet(0).setRowCount(parms.RowCount); //设置一列单元格的个数
            spread.getSheet(0).setColumnCount(parms.ColumnCount); //设置一行有多少个单元格
            spread.getActiveSheet().setRowVisible(1, false);//隐藏第2行
            let date = 1;
            let dateCol = 10;
            let numberArray = [];
            for (let i = 1; i <= 31; i++) {
                numberArray.push(i)
            }
            //设置头部年月份
            for (let i = 0; i < res.data.month.length; i++) {
                let index = numberArray.findIndex(v=>v==res.data.month[i].colsum);
                if(index!=1){
                    date=numberArray[index];
                    for (let j = 0; j < numberArray[index]; j++) {
                        sheet.setValue(1,10+j,res.data.month[i].colname);
                    }
                    if(i==0){
                        sheet.setValue(0, dateCol,res.data.month[i].colname);//插入数据
                        sheet.addSpan(0,dateCol,1,i+1*date);//跨行列
                        dateCol += date;
                    }else{
                        sheet.setValue(0, dateCol,res.data.month[i].colname);//插入数据
                        sheet.addSpan(0,dateCol,1,date);//跨行列
                        dateCol += date;
                    }
                }
            }
            //设置day，week
            for (let i = 0; i < res.data.day.length; i++) {
                sheet.setValue(2,parms.dayRow++,res.data.day[i]);
                sheet.setValue(3,parms.weekRow++,res.data.week[i]);
            }
            //设置周六日背景色条件格式
            let style3Sat = new GC.Spread.Sheets.Style();
            style3Sat.foreColor = '#000';
            style3Sat.backColor = "#00FFFF";
            parms.activeSheet.conditionalFormats.addSpecificTextRule(GC.Spread.Sheets.ConditionalFormatting.TextComparisonOperators.contains,'Sat',style3Sat,[new GC.Spread.Sheets.Range(3, 10, 1, res.data.day.length)]);
            let style3Sun = new GC.Spread.Sheets.Style();
            style3Sun.foreColor = '#000';
            style3Sun.backColor = "#00FFFF";
            parms.activeSheet.conditionalFormats.addSpecificTextRule(GC.Spread.Sheets.ConditionalFormatting.TextComparisonOperators.contains,'Sun',style3Sun,[new GC.Spread.Sheets.Range(3, 10, 1, res.data.day.length)]);
            spreadResume();// 恢复绘制
        });
    }

    /**
     * 初始化产线数据
     * @param initData
     */
    async function initData(ilevel){
        spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
        // sheet.options.isProtected = true; // 开启工作表保护
        // sheet.options.protectionOptions.allowEditObject = true; // 允许编辑对象
        // sheet.options.protectionOptions.allowSelectLockedCells = true; // 允许选择锁定单元格
        // sheet.options.protectionOptions.allowSelectUnlockedCells = true; // 允许选择非锁定单元格
        //定义接口参数
        let url = Api + `admin/scheduproductplanmonth/getScheduPlanMonthList?level=${ilevel==null||undefined?'1':ilevel}&startdate=${searchData.searchStartTime}&enddate=${searchData.searchEndTime}&cworkname=${searchData.cworkname}&cinvcode=${searchData.cinvcode}&cinvcode1=${searchData.cinvcode1}&cinvname1=${searchData.cinvname1}`
        LayerMsgBox.loading("正在获取最新数据...",20000);
        $.ajax({
            url,
            type: 'get',
            dataType: 'json',
            success:function (respons){
                console.log(respons)
                LayerMsgBox.closeLoading();
                parms['scheduplanmonth'] = respons;
                if(parms['scheduplanmonth']?.length>0){
                    spreadSuspend();//暂停绘制
                    let rowIndex = 4;
                    let cWorkName = 4;
                    let colIndexs = 0;//左视图产品数据渲染起始列
                    let code = 4;//隐藏编码起始行
                    //日计划排版
                    let shiyongRow = 4;//计划使用行下标
                    let shiyongCol = 10;//计划使用列下标
                    let isWorkArray = [];
                    //项目
                    for (let i = 0; i < parms['scheduplanmonth'].length; i++) {
                        //产线名称的跨行
                        sheet.setValue(cWorkName, 3 + colIndexs, parms['scheduplanmonth'][i].cWorkName);
                        sheet.getCell(cWorkName, 3 + colIndexs).wordWrap(true);
                        parms.activeSheet.addSpan(cWorkName, 3 + colIndexs, parms['scheduplanmonth'][i].childList.length*6, 1);
                        cWorkName=cWorkName+parms['scheduplanmonth'][i].childList.length*6;

                        //
                        for (let j = 0; j < parms['scheduplanmonth'][i].childList.length; j++) {
                            //接收所有的code编码
                            parms.cinvCode.push(parms['scheduplanmonth'][i].childList[j].cInvCode);
                            //
                            parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划使用");
                            parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划/1S");
                            parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划/2S");
                            parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划/3S");
                            parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划在库");
                            parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("在库天数");


                            //定义多选按钮
                            var cellType = new GC.Spread.Sheets.CellTypes.CheckBox();
                            parms.activeSheet.getCell(rowIndex, colIndexs).cellType(cellType);
                            sheet.addSpan(rowIndex, colIndexs, 6, 1);
                            //序号
                            sheet.setValue(rowIndex, 1 + colIndexs, parms['scheduplanmonth'][i].childList[j].seq);
                            parms.activeSheet.addSpan(rowIndex, 1 + colIndexs, 6, 1);
                            //排产层级
                            sheet.setValue(rowIndex, 2 + colIndexs, parms['scheduplanmonth'][i].childList[j].iPsLevel);
                            parms.activeSheet.addSpan(rowIndex, 2 + colIndexs, 6, 1);
                            //存货编码
                            sheet.setValue(rowIndex, 4 + colIndexs, parms['scheduplanmonth'][i].childList[j].cInvCode);
                            parms.activeSheet.addSpan(rowIndex, 4 + colIndexs, 6, 1);
                            //客户部番
                            sheet.setValue(rowIndex, 5 + colIndexs, parms['scheduplanmonth'][i].childList[j].cInvCode1);
                            sheet.getCell(rowIndex, 5 + colIndexs).wordWrap(true);
                            parms.activeSheet.addSpan(rowIndex, 5 + colIndexs, 6, 1);
                            //部品名称
                            sheet.setValue(rowIndex, 6 + colIndexs, parms['scheduplanmonth'][i].childList[j].cInvName1);
                            sheet.getCell(rowIndex, 6 + colIndexs).wordWrap(true);
                            parms.activeSheet.addSpan(rowIndex, 6 + colIndexs, 6, 1);
                            rowIndex=rowIndex+6;

                            //
                            sheet.setColumnVisible(8, false);//隐藏第9列
                            //设置第9列数据
                            for (let s = 0; s < 6; s++) {
                                if(i==0){
                                    sheet.setValue(code++, 8, parms['scheduplanmonth'][i].childList[j].cInvCode);
                                }else{
                                    sheet.setValue(6 * j + code++, 8, parms['scheduplanmonth'][i].childList[j].cInvCode);
                                }
                            }

                            //
                            let Z = 10;//在库天数公式嵌入起始列
                            let jihuaCol = 10;//计划在库公式嵌入起始列
                            for (let k = 0; k < parms['scheduplanmonth'][i].childList[j].day.length; k++) {
                                sheet.setValue(shiyongRow, shiyongCol+k, parms['scheduplanmonth'][i].childList[j].day[k].shiyong);
                                sheet.setValue(1 + shiyongRow, shiyongCol + k, parseFloat(parms['scheduplanmonth'][i].childList[j].day[k].one));
                                sheet.setValue(2 + shiyongRow, shiyongCol + k, parseFloat(parms['scheduplanmonth'][i].childList[j].day[k].two));
                                sheet.setValue(3 + shiyongRow, shiyongCol + k, parseFloat(parms['scheduplanmonth'][i].childList[j].day[k].three));
                                sheet.setValue(4 + shiyongRow, shiyongCol + k, parseFloat(parms['scheduplanmonth'][i].childList[j].day[k].zaiku));
                                const style_1S = new GC.Spread.Sheets.Style();
                                style_1S.backColor = "#CCFFFF";
                                parms.activeSheet.setStyle(4 + shiyongRow, shiyongCol + k,style_1S);
                                //
                                sheet.setValue(5 + shiyongRow, shiyongCol + k, parseFloat(parms['scheduplanmonth'][i].childList[j].day[k].tianshu));
                                const style_2S = new GC.Spread.Sheets.Style();
                                style_2S.backColor = "#FFE1CC";
                                parms.activeSheet.setStyle(5 + shiyongRow, shiyongCol + k,style_2S);

                                //
                                sheet.setValue(1 + shiyongRow, 9, parms['scheduplanmonth'][i].childList[j].qiChuOneS);
                                sheet.setValue(2 + shiyongRow, 9, parms['scheduplanmonth'][i].childList[j].qiChuTwoS);
                                sheet.setValue(3 + shiyongRow, 9, parms['scheduplanmonth'][i].childList[j].qiChuThreeS);
                                sheet.setValue(4 + shiyongRow, 9, parms['scheduplanmonth'][i].childList[j].qiChuZaiKu);
                                sheet.setValue(5 + shiyongRow, 9, parms['scheduplanmonth'][i].childList[j].dayNum);
                                //
                                let AS= shiyongRow+5;
                                let Num = sheet.getValue(AS,9);
                                let useArray = [];
                                for (let f = 0; f < Num; f++) {
                                    useArray.push(`R[-5]C[${f+1}]`);
                                }
                                //嵌入计划在库公式
                                sheet.setFormula(shiyongRow+5-1,jihuaCol++,`=SUM(RC[-1],R[-3]C,R[-2]C,R[-1]C)-R[-4]C`);
                                    let row = AS-5; // 初始行值
                                    let planmonthCol = k+Z;
                                    var isWork = parms['scheduplanmonth'][i].childList[j].day;
                                    var col=11;
                                    var array=[];
                                    // console.log(sheet.getValue(row,20))
                                    // console.log(planmonthCol-10,'-----------')//max:29
                                    // if(planmonthCol-10<=parms['scheduplanmonth'][i].childList[j].day.length-Num-1){
                                    //     // debugger
                                    //     for(var f=col;;f++){
                                    //         // console.log(f,isWork[f-10-1],'f')
                                    //         if(isWork[f-10].iswork==false||sheet.getValue(row,f)==0) continue;
                                    //         if(array.length!=Num){
                                    //             array.push(f);
                                    //         }else{
                                    //             break;
                                    //         }
                                    //     }
                                    // }
                                // console.log(Z+k)
                                // sheet.setFormula(AS,Z+k,`=SUM(R${AS-4}C${array[0]+1}:R${AS-4}C${array[1]+1})/R${AS+1}C10`);
                                // if(parms['scheduplanmonth'][i].childList[j].day.at(-1)||parms['scheduplanmonth'][i].childList[j].day.at(-2)){
                                // console.log('at')
                                // }
                                // }
                                //控制小数位为1位
                                sheet.setFormatter(AS, shiyongCol+k,Number.isInteger(parseFloat(parms['scheduplanmonth'][i].childList[j].day[k].tianshu))?"0.00":"0.00");
                                //
                                if(!parms['scheduplanmonth'][i].childList[j].day[k].lock){
                                    // 设置单元格是否可编辑
                                    sheet.getCell(shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    sheet.getCell(1+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    sheet.getCell(2+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    sheet.getCell(3+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    sheet.getCell(4+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    sheet.getCell(5+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                }else{
                                    // 设定锁定样式
                                    const style_1S = new GC.Spread.Sheets.Style();
                                    style_1S.backColor = "#F0F0F0";
                                    sheet.getCell(1+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    parms.activeSheet.setStyle(1+shiyongRow, shiyongCol+k,style_1S);

                                    const style_2S = new GC.Spread.Sheets.Style();
                                    sheet.getCell(2+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    style_2S.backColor = "#F0F0F0";
                                    parms.activeSheet.setStyle(2+shiyongRow, shiyongCol+k,style_2S);

                                    const style_3S = new GC.Spread.Sheets.Style();
                                    sheet.getCell(3+shiyongRow, shiyongCol+k).locked(parms['scheduplanmonth'][i].childList[j].day[k].lock);
                                    style_3S.backColor = "#F0F0F0";
                                    parms.activeSheet.setStyle(3+shiyongRow, shiyongCol+k,style_3S);
                                }
                            }
                            shiyongRow=shiyongRow+6;
                        }
                    }
                }else{
                    LayerMsgBox.error('暂无数据',10000);
                }
                spreadResume();// 恢复绘制
            }, error: function () {
                console.log('error')
            }
        })
    }
    // 订阅 valueChanged 事件
    sheet.bind(GC.Spread.Sheets.Events.ValueChanged, function (e, info) {
        let {row,col} = info;
        var colData = sheet.getArray(0, col, sheet.getRowCount(), 1);//获取列数据
        let arr = [];
        setTimeout(() => {
            //获取公式计算之后的最新数据
            arr = sheet.getDirtyCells(-1,-1,-1,-1);
            let newValues = arr.map((item) =>{
                //过滤没发生改变的数据
                if(item.newValue!=item.oldValue){
                    return {
                        ...item
                    }
                }
            });
            newValues.map(item=>{
                    if(item!=undefined){
                        var rowData = sheet.getArray(item.row,0, 1, sheet.getColumnCount());//获取行数据
                        var colData = sheet.getArray(0, col, sheet.getRowCount(), 1);//获取列数据
                        var colDatas = sheet.getArray(0, item.col, sheet.getRowCount(), 1);//获取列数据
                        let obj = {
                            plan:rowData[0][7],//计划
                            cInvCode:rowData[0][8],//存户编码
                            newValue:item.newValue,//修改后的值
                            date:colData[1][0],//获取当前年月
                            day:colDatas[2][0],//日
                        }
                        parms.tableData.push(obj);
                    }
                })
                sheet.clearPendingChanges({clearType: 1, row: -1, rowCount: -1, col: -1, colCount: -1});
            }, 0);
    });
    /**
     * 打开弹出层
     * @param openPopup
     */
    function openPopup() {
        var popup = document.querySelector('.popup-layer');
        popup.style.display = 'block';
        popup.style.position = "absolute";
        popup.style.border = '1px solid #ccc';
        popup.style.top = "35%";
        popup.style.left = "40%";
        popup.style.marginTop = "-75px";
        popup.style.marginLeft = "-150px";
        mybgs = document.createElement("div");
        mybgs.setAttribute("id", "mybgs");
        mybgs.style.background = "#000";
        mybgs.style.width = "100%";
        mybgs.style.height = "100%";
        mybgs.style.position = "absolute";
        mybgs.style.top = "0";
        mybgs.style.left = "0";
        mybgs.style.zIndex = "500";
        mybgs.style.opacity = "0.3";
        document.body.appendChild(mybgs);
        document.body.style.overflow = "hidden";
        let url = Api+"admin/scheduproductplanmonth/getApsWeekscheduleList";
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                parms.dschedulebeginData = res.data;
                var str = "";
                for (var i = 0; i < res.data.length; i++) {
                    str += `<tr>
                                <td>${res.data[i].ilevel}</td>
                                <td>${res.data[i].dscheduleendtime}</td>
                                <td>${res.data[i].dlockendtime==undefined?'':res.data[i].dlockendtime}</td>
                                <td width='130px'>
                                  <span onClick='levelDelete(${i})'style="cursor: pointer;color: #0000FF;">删除</span>
                                 </td>
                               </tr>`;
                }
                $("#layer_tr").html(str);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    //删除表格数据
    function levelDelete(index){
        let id = parms.dschedulebeginData[index].iautoid;
        let url = Api+`admin/scheduproductplanmonth/deleteApsWeekschedule?iWeekScheduleId=${id}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                if(res.msg=="操作成功"){
                    LayerMsgBox.success(res.msg,500);
                    closePopup();//隐藏弹出层
                    var json = sheet.toJSON();//储存表单数据
                    sheet.fromJSON(json);//清空表单数据
                    sheet.reset();//重置表单
                }
            },error: function(error) {
                console.log(error);
            }
        })
    }
    //接收搜索参数
    let searchData={
        cworkname:'',
        cinvcode:'',
        cinvcode1:'',
        cinvname1:'',
        searchStartTime:'',
        searchEndTime:'',
        searchLevel:''
    }
    /**
     * 搜索事件
     * @param search
     * @param searchData 搜索需携带参数
     */
    function search(){
        const cworkname = document.getElementById('cworkname').value;
        const cinvcode = document.getElementById('cinvcode').value;
        const cinvcode1 = document.getElementById('cinvcode1').value;
        const cinvname1 = document.getElementById('cinvname1').value;
        const searchStartTime = document.getElementById('search_start-time').value;
        const searchEndTime = document.getElementById('search_end-time').value;
        const searchLevel = document.getElementById('search_level').value;
        parms.level = searchLevel;
        searchData={
            cworkname,
            cinvcode,
            cinvcode1,
            cinvname1,
            searchStartTime,
            searchEndTime,
            searchLevel
        }
        // var json = sheet.toJSON();//储存表单数据
        // sheet.fromJSON(json);//清空表单数据
        sheet.reset();//重置表单
        //从新赋值到原始渲染位置
        parms.planListRowIndex=4;
        parms.dayRow=10;
        parms.weekRow=10;
        loadInit();
        initDate(searchData);
        initData(searchLevel);
    }
    function reset() {
        document.getElementById('cworkname').value = '';
        document.getElementById('cinvcode').value = '';
        document.getElementById('cinvcode1').value = '';
        document.getElementById('cinvname1').value = '';
        document.getElementById('search_start-time').value = '';
        document.getElementById('search_end-time').value = '';
        document.getElementById('search_level').value = '1';
    }
    //排产确定事件
    function savePopup(){
        //获取用户选择的时间
        const datetimeLocalInput = document.getElementById('datetime-local');
        const myVal = datetimeLocalInput.value.substring(0,10);
        const level = document.getElementById('level').value;
        let url = Api+`admin/scheduproductplanmonth/scheduPlanMonth?level=${level}&endDate=${myVal}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                let {msg,state} = res.data;
                state=='ok'?LayerMsgBox.success(msg):LayerMsgBox.error(msg)
                closePopup();//隐藏弹出层
                // var json = sheet.toJSON();//储存表单数据
                // sheet.fromJSON(json);//清空表单数据
                sheet.reset();//重置表单
                //从新赋值到原始渲染位置
                parms.planListRowIndex=4;
                parms.dayRow=10;
                parms.weekRow=10;
                parms.level=level;
                loadInit();
                initDate();
                initData(level);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * 关闭弹出层
     * @param closePopup
     */
    function closePopup() {
        var popup = document.querySelector('.popup-layer');
        popup.style.display = 'none';
        mybgs.style.display = "none";
    }
    //锁定弹出框
    var myAlert = document.getElementById("alert");
    var reg = document.getElementById("content");
    var mClose = document.getElementById("close");
    var mClose_But = document.getElementById("close_but");
    var alertTitle = document.getElementById("title");

    //锁定打开弹出层
    reg.onclick = function(){
        if(myAlert.style.display !== "block"){
            myAlert.style.display = "block";
            alertTitle.innerText = "锁定计划";
            myAlert.style.position = "absolute";
            myAlert.style.top = "50%";
            myAlert.style.left = "50%";
            myAlert.style.marginTop = "-75px";
            myAlert.style.marginLeft = "-150px";
            mybg = document.createElement("div");
            mybg.setAttribute("id", "mybg");
            mybg.style.background = "#000";
            mybg.style.width = "100%";
            mybg.style.height = "100%";
            mybg.style.position = "absolute";
            mybg.style.top = "0";
            mybg.style.left = "0";
            mybg.style.zIndex = "500";
            mybg.style.opacity = "0.3";
            document.body.appendChild(mybg);
            document.body.style.overflow = "hidden";
            //锁定截止日期
            let url = Api+`admin/scheduproductplanmonth/getLockDate?level=${parms.level}`;
            $.ajax({
                url,
                type:'post',
                dataType:'json',
                success:function (res){
                    parms.getLockDate = res.data;
                    const weekNum = document.getElementById('weekNum');
                    weekNum.innerText = parms.getLockDate[0].weekNum;
                    var options = "";
                    for (var i = 0; i < res.data.length; i++) {
                        options += "<option value='" + res.data[i].lockDate + "'>" + res.data[i].lockDate + "</option>";
                    }
                    $("#mySelect").html(options);
                },error: function(error) {
                    console.log(error);
                }
            })
        }
    }
    //获取用户点击锁定的截止日期
    const selectElement = document.getElementById('mySelect');
    selectElement.addEventListener('change', function() {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const selectedValue = selectedOption.value;
        const selectedText = selectedOption.text;
        const weekNum = document.getElementById('weekNum');
        if(alertTitle.innerText == "锁定计划"){
            const text = parms.getLockDate.find(item=>item.lockDate==selectedValue);
            weekNum.innerText = text.weekNum;
        }else{
            const text = parms.getLockDate.find(item=>item.unLockDate==selectedValue);
            weekNum.innerText = text.weekNum;
        }
    });
    //
    /**
     * 锁定确定按钮事件
     * @param save
     */
    function save(){
        const datetimeLocalInput = document.getElementById('mySelect');
        const myVal = datetimeLocalInput.value.substring(0,10);
        let url = alertTitle.innerText == "锁定计划"?Api+`admin/scheduproductplanmonth/lockScheduPlan?level=${parms.level}&endDate=${myVal}`
            :Api+`admin/scheduproductplanmonth/unLockScheduPlan?level=${parms.level}&endDate=${myVal}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                myAlert.style.display = "none";
                mybg.style.display = "none";
                res.msg=="操作成功"?LayerMsgBox.success(res.msg):LayerMsgBox.error(res.msg,4000);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    //弹出层关闭事件
    mClose.onclick = function(){
        myAlert.style.display = "none";
        mybg.style.display = "none";
    }
    //取消按钮事件
    mClose_But.onclick = function(){
        myAlert.style.display = "none";
        mybg.style.display = "none";
    }
    /**
     * 解锁计划
     * @param unLock
     */
    function unLock(){
        myAlert.style.display = "block";
        alertTitle.innerText = "解锁计划";
        myAlert.style.position = "absolute";
        myAlert.style.top = "50%";
        myAlert.style.left = "50%";
        myAlert.style.marginTop = "-75px";
        myAlert.style.marginLeft = "-150px";
        mybg = document.createElement("div");
        mybg.setAttribute("id", "mybg");
        mybg.style.background = "#000";
        mybg.style.width = "100%";
        mybg.style.height = "100%";
        mybg.style.position = "absolute";
        mybg.style.top = "0";
        mybg.style.left = "0";
        mybg.style.zIndex = "500";
        mybg.style.opacity = "0.3";
        document.body.appendChild(mybg);
        document.body.style.overflow = "hidden";
        let url = Api+`admin/scheduproductplanmonth/getUnLockDate?level=${parms.level}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                parms.getLockDate = res.data;
                let weekNum = document.getElementById('weekNum');
                weekNum.innerText = parms.getLockDate[0].weekNum;
                var options = "";
                for (var i = 0; i < res.data.length; i++) {
                    options += "<option value='" + res.data[i].unLockDate + "'>" + res.data[i].unLockDate + "</option>";
                }
                $("#mySelect").html(options);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * @param 保存层级
     */
    function saveLevel(){
        let jsonArray = JSON.stringify(parms.tableData);
        let url = Api+ `admin/scheduproductplanmonth/saveLevel?data=${jsonArray}`;
        if(parms.tableData.length>0){
            $.ajax({
                url,
                type:'post',
                dataType:'json',
                success:function (res){
                    if(res.msg=="操作成功"){
                        LayerMsgBox.success(res.msg);
                        initData();
                        parms.tableData.length=0;
                    }else{
                        LayerMsgBox.error(res.msg,500);
                    }
                },error: function(error) {
                    console.log(error);
                }
            })
        }else{
            LayerMsgBox.error("数据没有发生改变，保存无效",2000);
        }
    }

    //给排产弹窗添加一个滑动区域，避免数据太长而造成样式崩塌
    const myTable = document.getElementById('popup_table');
    const tableContainer = document.getElementById('popup-layer');
    // 添加滚动事件处理程序
    tableContainer.addEventListener('scroll', function() {
        // 获取表头元素
        const tableHeader = myTable.querySelector('thead');
    });
</script>
#end
