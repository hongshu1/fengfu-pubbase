#@jboltLayout()
#define css()
<link href="assets/plugins/Grape/16.0.2/css/gc.spread.sheets.16.0.2.css" rel="stylesheet">
<style>
    .spread-container {
        height:75.5vh;
    }

    .gc-statusbar {
        height: 25px;
        min-height: 25px;
        background: #217346;
        font-size: 0.6rem;
        color: aliceblue;
    }
    body,p {
        margin: 0px;
        padding: 0px;
        font-size: 12px;
        color: black;
    }

    #box {
        height: 100vh;
        font-weight: bold;
    }

    /* 头部用户数据 */
    .nav_title {
        text-indent: 1rem;
        padding: 10px 0px;
        font-size: 0.9rem;
        color: #5C5C5C;
        border: 1px solid #CCCCCC;
    }

    .search {
        display: flex;
        padding: 10px 0px;
    }

    /* 下拉框文字样式 */
    .select {
        margin-right: 15px;
    }

    .span {
        color: #333333;
    }

    .select:nth-child(1) {
        margin-left: 10px;
    }

    /* 搜索重置按钮样式 */
    .button {
        margin: 0px 10px;
        padding: 3px 10px;
        background-color: #fff;
        border: #797979 1px solid;
    }

    /* 表格工具 */
    .but_box {
        padding: 15px 0px;
        padding-left: 15px;
        border-bottom: none;
    }

    /* 表格按钮 */
    .but_box button {
        padding: 3px 10px;
        margin-right: 8px;
        background-color: #fff;
        border: #797979 1px solid;
        border-radius: 5px;
    }
    /*  锁定弹出框样式  */
    #alert{
        border: 1px solid rgba(215, 215, 215, 1);
        background-color:#fff;
        width: 430px;
        height: 190px;
        z-index: 1000;
        position: absolute;
        display: none;
    }
    #alert .alert_title{
        display: flex;
        font-size: 14px;
        border-bottom: 3px solid rgba(215, 215, 215, 1);
        padding: 7px 0px;
        text-indent: 0.8rem
    }
    #alert .alert_title span:nth-child(1){
        flex: 1;
    }
    #alert .alert_title #close{
        font-size: 18px;
        margin-right: 10px;
        cursor: pointer;
    }
    #alert .alert_but{
        width: 100%;
    }
    #alert .alert_but button{
        margin: 10px 10px;
        padding: 3px 13px;
        background-color: #fff;
        border: #797979 1px solid;
        border-radius: 5px;
        float: right;
    }
/*    */
    .popup-layer{
        border: 1px solid rgba(215, 215, 215, 1);
        background-color:#fff;
        width: 560px;
        height: 400px;
        padding: 20px;
        z-index: 1000;
        position: absolute;
        overflow-y: scroll;
        display: none;
    }
    .popup-confirm{
        margin-bottom: 20px;
    }
    #popup_table{
        text-align: center;
        margin-bottom: 20px;
    }
    #popup_table tr{
        height: 40px;
    }
/*  消息提示框  */
    #message-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        text-align: center;
    }

    .message {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        animation: slide-in 0.3s ease-out;
    }

    .hidden {
        display: none !important;
    }

    @keyframes slide-in {
        from {
            transform: translateY(-100%);
        }
        to {
            transform: translateY(0);
        }
    }
    /* 遮罩层样式 */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9;
        display: none;
    }

    /* 弹出框样式 */
    .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: none;
    }
    .popup p{
        margin-bottom: 10px;
        margin-top: 0px;
        display: flex;
        line-height: 45px;
        font-size: 16px;
    }
    .popup p span:nth-child(1){
        flex: 1;
    }
    .popup p span:nth-child(2){
        font-size: 30px;
        cursor: pointer;
    }
    /* 输入框样式 */
    input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        margin-bottom: 10px;
    }
</style>
#end

#define main()
#set(pageId=RandomUtil.random(6))
<div class="jbolt_page" data-key="#(pmkey)" >
    <div class="jbolt_page_title">
        <nav>
            <p class="nav_title">月周生产计划</p>
        </nav>
        <!-- 头部标题结束 -->
        <!-- 搜索工具类开始 -->
        <div class="search">
            <div class="select">
                <span>产线名称:</span>
                <input style="width:150px;height:20px;" id="cworkname"/>
            </div>
            <div class="select">
                <span>存货编码:</span>
                <input style="width:150px;height:20px;" id="cinvcode"/>
            </div>
            <div class="select">
                <span>客户部番:</span>
                <input style="width:150px;height:20px;" id="cinvcode1"/>
            </div>
            <div class="select">
                <span>部品名称:</span>
                <input style="width:150px;height:20px;" id="cinvname1"/>
            </div>
            <button class="button" onClick="search()">搜索</button>
            <button class="button">重置</button>
        </div>
    </div>
    <div class="jbolt_page_content">
        <div class="sample-container">
            <!-- 表格 -->
            <div id="table-tool">
                <!-- 表格工具开始 -->
                <div class="but_box">
                    <button onClick="openPopup()">排产</button>
                    <button onClick="excelFileSave()">数据导出</button>
                    <button id="loadExcel">数据导入</button>
                    <button>保存层级</button>
                    <button>计划使用刷新</button>
                    <button id="content" onClick="lock()">锁定</button>
                    <button onClick="unLock()">解锁</button>
                </div>
                <!-- 创建表格目标DOM元素，id为ss的HTML -->
                <div id="ss" class="spread-container"></div>
                <div id="statusBar" class="gc-statusbar"></div>
            </div>
        </div>
        <!--锁定弹框-->
        <div id="alert">
            <p class="alert_title"><span id="title"></span><span id="close">X</span></p>
            <div class="select" style="margin-top: 15px;margin-left: 20px;margin-bottom: 15px;">
                <form>
                    <div class="form-group row" style="margin-top: 20px;display: flex;margin-bottom: 0px">
                        <span style="display:block;line-height: 25px;margin-left: 15px">截止日期：</span>
                        <select id="mySelect" style="width:180px">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </form>
            </div>
            <div style="text-indent: 1.5rem">
                <span>周次：</span>
                <span id="weekNum">第二周</span>
            </div>
            <p class="alert_but"><button id="close_but">取消</button><button onClick="save()">确定</button></p>
        </div>
        <!-- 排产弹出层 -->
        <div class="popup-layer" id="popup-layer">
            <!-- 确定按钮 -->
            <div style="width: 100%;margin-bottom: 20px;">
                <button class="button" onclick="savePopup()">确定</button>
                <button class="button" onclick="closePopup()">取消</button>
            </div>
            <!-- 表格 -->
            <div style="display: flex">
                <p style="float: left;width: 70px">已排层级：</p>
                <table border width="100%" id="popup_table">
                    <thead>
                    <tr>
                        <th>排产层级</th>
                        <th>排场截止时间</th>
                        <th>锁定截止时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="layer_tr"></tbody>
                </table>
            </div>
            <!-- 下拉框 -->
            <div class="popup-select">
                <div>
                    <label for="deadline">截止日期：</label>
                    <input type="datetime-local" id="datetime-local" name="datetime-local" style="display: inline-block; width: 200px">
                </div>
                <div>
                    <label for="level">排产层级：</label>
                    <select id="level">
                        <option value="1">层级1</option>
                        <option value="2">层级2</option>
                        <option value="3">层级3</option>
                        <option value="4">层级4</option>
                        <option value="5">层级5</option>
                    </select>
                </div>
            </div>
        </div>
        <!--排产弹出框结束-->
        <!--消息提示框开始-->
        <div id="message-box" class="hidden">
            <div class="message">
                <p>提示</p>
                <p id="msg"></p>
            </div>
        </div>
        <!--消息提示框结束-->
        <!--导出弹出框开始-->
        <div class="overlay" id="overlay"></div>
        <div class="popup" id="popup">
            <p><span>请输入导出表格名称</span><span onClick="hidePopup()">x</span></p>
            <input type="text" placeholder="请输入名称" id="input">
            <button onclick="submit()" class="button" style="float: right;width: 60px">确定</button>
        </div>
        <!--导出弹出框结束-->
        <!--导入弹出框开始-->
        <div class="overlay" id="overlay"></div>
        <div class="popup" id="popup1">
            <p><span>请上传要导入的文件</span><span onClick="hidePopup()">x</span></p>
            <input type="file" id="fileDemo" class="input">
            <button onclick="importSubmit()" class="button" style="float: right;width: 60px">确定</button>
        </div>
        <!--导入弹出框结束-->
    </div>
</div>
#end

#define js()
<script type="text/javascript" src="assets/plugins/Grape/16.0.2/js/gc.spread.sheets.all.16.0.2.min.js"></script>
<script type="text/javascript" src="assets/plugins/Grape/16.0.2/js/gc.spread.excelio.16.0.2.min.js"></script>
<script type="text/javascript" src="assets/plugins/Grape/FileSaver.min.js"></script>
<script type="text/javascript">
    /**
     * @param Api 公共接口
     */
    const Api = 'http://localhost:8081/';
    /**
     * @param urlParams 获取跳转携带的参数
     * @param id 跳转携带的id
     */
    window.onload=function () {
        const urlParams = new URLSearchParams(window.location.search);
        const iWeekScheduleId = urlParams.get('iWeekScheduleId');
        const ilevel = urlParams.get('level');
        if(iWeekScheduleId!=null){
            loadInit();
            initDate();
            parms.id=iWeekScheduleId;
            parms.level=ilevel;
            initData(iWeekScheduleId,ilevel);
        }
    }
    var spread = new GC.Spread.Sheets.Workbook(document.getElementById('ss'), {sheetCount: 1,calcOnDemand: true});
    var excelIo = new GC.Spread.Excel.IO();
    //设置状态栏
    var statusBar = new GC.Spread.Sheets.StatusBar.StatusBar(document.getElementById('statusBar'));
    var sheet = spread.getSheet(0);//按照下标获取表单
    //设置全局内容水平垂直居中
    sheet.getRange(-1,-1,-1,-1).hAlign(GC.Spread.Sheets.HorizontalAlign.center).vAlign(GC.Spread.Sheets.VerticalAlign.center);
    //设置全局的字体样式
    sheet.getRange(-1, -1,-1,-1).font('宋体 bold 10px');
    //状态栏
    statusBar.bind(spread);
    spread.getSheet(0).options.colHeaderAutoText = GC.Spread.Sheets.HeaderAutoText["numbers"];//表头列号换成数字
    spread.getSheet(0).options.isProtected = true;//表单设为保护状态
    spread.getSheet(0).options.protectionOptions = {allowFilter: true};//保护状态允许筛选
    spread.getSheet(0).getDefaultStyle().locked = false;//默认样式设为非锁定
    var parmsDefault = {
        id:null,                //全局公共id
        level:'',               //排场层级
        resourcesList: [],      //资源列表
        RowCount:27,           //一列多少单元格
        ColumnCount:41,         //一行多少单元格
        countday: 93,			//展示天数
        monthday: [],			//每月天数
        rowindex:0,				//x轴索引
        columnindex:0,			//y轴索引
        dataStartCol: 7,		//日期开始列索引前的列数
        data: [],				//当月时间数据
        dayLength:0,            //获取接口返回的当月天数长度
        currentRow: 0,			//当前选中的单元格行
        currentCol: 0,			//当前选中的单元格列
        dayRow:9,               //day渲染起始下标
        weekRow:9,              //week渲染起始下标
        info:{},                //存储单击之后的单元格
        lockCells:[],           //存储选中的单元格
        tableData:[],           //接收添加的数据
        planListRowIndex:3,     //计划排产列表起始行下标
        planListColIndex:7,     //计划排产列表起始列下标
        openBoxTime:'',         //打开锁定弹框的时间戳
        getLockDate:[],         //存储锁定计划的全部截止日期
        dschedulebeginData:[],  //已排层级展示数据
    };
    var parmsArr = [Object.assign({},parmsDefault)];
    //添加属性
    parmsArr[0]['spread'] = spread;
    parmsArr[0]['activeSheet'] = spread.getSheet(0);//获取指定的表单
    var parms = parmsArr[0];
    //设置全局表单的背景颜色
    spread.options.grayAreaBackColor = '#fff';
    /*工作簿暂停活性*/
    function spreadSuspend() {
        spread.suspendPaint(); //渲染前失活(提升性能)
        spread.suspendCalcService(); //暂停计算服务
    }
    /*工作簿开启活性*/
    function spreadResume() {
        spread.resumeCalcService(); //开启计算服务
        spread.resumePaint(); //恢复绘制
    }
    // var colCount = sheet.getColumnCount(GC.Spread.Sheets.SheetArea.viewport);//获取列数
    // var rowCount = sheet.getRowCount();//获取行数
    /**
     * 数据导入
     * @param loadExcel 按钮节点
     */
    document.getElementById('loadExcel').onclick = function () {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup1").style.display = "block";
    };
    /**
     * 表格数据导出
     * @param excelFileSave
     */
    function excelFileSave() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup").style.display = "block";
    };

    /**
     * 提交输入框内容
     * @param submit
     */
    function submit() {
        var fileName = document.getElementById("input").value;
        if(fileName!=''){
            fileName += '.xlsx';
            var json = spread.toJSON();//转为json格式
            excelIo.save(json, function (blob) {
                saveAs(blob, fileName);//转成xlsx
            });
            hidePopup();
        }
    }
    /**
     * 确定导入文件
     * @param importSubmit
     */
    function importSubmit() {
        var excelFile = document.getElementById("fileDemo").files[0];//获取用户上传文件
        excelIo.open(excelFile, function (json) {
            var workbookObj = json;
            spread.fromJSON(workbookObj);
        }, function (e) {
            alert(e.errorMessage);
        });
        hidePopup();
    }
    /**
     * 隐藏数据导出弹出框
     * @param hidePopup
     */
    function hidePopup() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("popup").style.display = "none";
        document.getElementById("popup1").style.display = "none";
    }
    /**
     * 初始化产线数据
     * @param loadInit
     */
    function loadInit(){
        //设置全局的列宽行高
        sheet.defaults.colWidth = 80;
        sheet.defaults.rowHeight = 25;
        spread.getSheet(0).setRowCount(parms.RowCount); //设置一列单元格的个数
        spread.getSheet(0).setColumnCount(parms.ColumnCount); //设置一行有多少个单元格
        var cellType = new GC.Spread.Sheets.CellTypes.CheckBox();//定义多选按钮
        //设置value值和该单元格的对齐方式
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex).cellType(cellType);
        parms.activeSheet.setColumnWidth(parms.columnindex, 40);//设置指定单元格的width
        sheet.addSpan(0,0,3,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+1).text("序号");
        parms.activeSheet.setColumnWidth(parms.columnindex+1, 60);//设置指定单元格的width
        parms.activeSheet.addSpan(0,1,3,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+2).text("排产层级");
        parms.activeSheet.addSpan(0,2,3,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+3).text("产线名称");
        parms.activeSheet.addSpan(0,3,3,1);
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+4).text("存货编码");
        parms.activeSheet.addSpan(0,4,3,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+4, 100);//设置指定单元格的width
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+5).text("客户部番");
        parms.activeSheet.addSpan(0,5,3,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+5, 120);//设置指定单元格的width
        parms.activeSheet.getCell(parms.rowindex, parms.columnindex+6).text("部品名称");
        parms.activeSheet.addSpan(0,6,3,1);
        parms.activeSheet.setColumnWidth(parms.columnindex+6, 150);//设置指定单元格的width
        parms.activeSheet.setColumnWidth(parms.columnindex+8, 70);//设置指定单元格的width
    }
    /**
     * 获取接口返回的日期数据
     * @param initDate
     */
    function initDate() {
        let url = Api+"admin/scheduproductplanmonth/getTableHead";
        //获取接口数据
        Ajax.get(url,(res)=>{
            spreadSuspend();//暂停绘制
            parms.data = res.data;
            parms.dayLength = res.data.day.length;
            let date = new Date();//获取当前年月
            sheet.setValue(parms.rowindex, parms.columnindex+9,date);//插入数据
            sheet.setFormatter(parms.rowindex, parms.columnindex+9,"YYY年MM月");//转换日期格式
            parms.activeSheet.setColumnWidth(parms.columnindex+1, 60);//设置指定单元格的width
            sheet.addSpan(0,9,1,parms.dayLength);//跨行列
            for (let i = 0; i < parms.dayLength; i++) {
                sheet.setValue(1,parms.dayRow++,parms.data.day[i]);
                sheet.setValue(2,parms.weekRow++,parms.data.week[i]);
            }
            //设置合计字段
            parms.activeSheet.getCell(1, 40).text("合计");
            //设置周六日背景色条件格式
            let style3Sat = new GC.Spread.Sheets.Style();
            style3Sat.foreColor = '#000';
            style3Sat.backColor = "#00FFFF";
            parms.activeSheet.conditionalFormats.addSpecificTextRule(GC.Spread.Sheets.ConditionalFormatting.TextComparisonOperators.contains,'Sat',style3Sat,[new GC.Spread.Sheets.Range(2, 14, 1, 31)]);
            let style3Sun = new GC.Spread.Sheets.Style();
            style3Sun.foreColor = '#000';
            style3Sun.backColor = "#00FFFF";
            parms.activeSheet.conditionalFormats.addSpecificTextRule(GC.Spread.Sheets.ConditionalFormatting.TextComparisonOperators.contains,'Sun',style3Sun,[new GC.Spread.Sheets.Range(2, 14, 1, 31)]);
            // //设置边框线
            // var border = new GC.Spread.Sheets.LineBorder
            // border.color = "#000";
            // border.style = GC.Spread.Sheets.LineStyle.thin;
            // var cell = sheet.getCell(2, 14, GC.Spread.Sheets.SheetArea.viewport);
            // cell.setBorder(new GC.Spread.Sheets.LineBorder("#D0D7E5",GC.Spread.Sheets.LineStyle.thick), { all:true });
            spreadResume();// 恢复绘制
        });
    }
    /**
     * 初始化产线数据
     * @param initData
     */
    function initData(id,ilevel){
        let url = Api + `admin/scheduproductplanmonth/getScheduPlanMonthList?iWeekScheduleId=${id}&level=${ilevel}&cworkname=${searchData.cworkname}&cinvcode=${searchData.cinvcode}&cinvcode1=${searchData.cinvcode1}&cinvname1=${searchData.cinvname1}`;
        $.ajax({
            url,
            type: 'get',
            dataType: 'json',
            success: function (res) {
                spreadSuspend();//暂停绘制
                let rowIndex = 3;
                let colIndex = 0;
                console.log(res);

                for (let i = 0; i < res.length; i++) {
                    //定义多选按钮
                    var cellType = new GC.Spread.Sheets.CellTypes.CheckBox();
                    parms.activeSheet.getCell(rowIndex, colIndex).cellType(cellType);
                    sheet.addSpan(rowIndex, colIndex, 6, 1);
                    //序号
                    sheet.setValue(rowIndex, 1 + colIndex, i);
                    parms.activeSheet.addSpan(rowIndex, 1 + colIndex, 6, 1);
                    //排产层级
                    sheet.setValue(rowIndex, 2 + colIndex, res[i].iPsLevel);
                    parms.activeSheet.addSpan(rowIndex, 2 + colIndex, 6, 1);
                    //产线名称
                    sheet.setValue(rowIndex, 3 + colIndex, res[i].cWorkName);
                    parms.activeSheet.addSpan(rowIndex, 3 + colIndex, 6, 1);
                    parms.activeSheet.setColumnWidth(3 + colIndex, 120);//设置指定单元格的width
                    //存货编码
                    sheet.setValue(rowIndex, 4 + colIndex, res[i].cInvCode);
                    parms.activeSheet.addSpan(rowIndex, 4 + colIndex, 6, 1);
                    parms.activeSheet.setColumnWidth(4 + colIndex, 120);//设置指定单元格的width
                    //客户部番
                    sheet.setValue(rowIndex, 5 + colIndex, res[i].cInvCode1);
                    parms.activeSheet.addSpan(rowIndex, 5 + colIndex, 6, 1);
                    parms.activeSheet.setColumnWidth(5 + colIndex, 140);//设置指定单元格的width
                    //部品名称
                    sheet.setValue(rowIndex, 6 + colIndex, res[i].cInvName1);
                    parms.activeSheet.addSpan(rowIndex, 6 + colIndex, 6, 1);
                    parms.activeSheet.setColumnWidth(6 + colIndex, 180);//设置指定单元格的width
                    rowIndex += 6;

                    parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划使用");
                    parms.activeSheet.setColumnWidth(parms.planListRowIndex, 70);//设置指定单元格的width
                    parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划/1S");
                    // let cell_T13 = parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex);//计划变更数
                    // cell_T13.value('计划/1S').locked(true);
                    // let style_T13 = new GC.Spread.Sheets.Style();
                    // style_T13.font = '0 15pt 宋体';
                    // style_T13.locked = true;
                    // style_T13.backColor = "#FFE1CC"
                    // // //设置边框线
                    // var border = new GC.Spread.Sheets.LineBorder
                    // border.color = "#000";
                    // border.style = GC.Spread.Sheets.LineStyle.thin;
                    // cell_T13.setBorder(new GC.Spread.Sheets.LineBorder("#D0D7E5",GC.Spread.Sheets.LineStyle.thick), { all:true });
                    //
                    // parms.activeSheet.setStyle(parms.planListRowIndex++, parms.planListColIndex,style_T13);

                    parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划/2S");
                    parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划/3S");
                    parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("计划在库");
                    parms.activeSheet.getCell(parms.planListRowIndex++, parms.planListColIndex).text("在库天数");
                    //日计划排版
                    let shiyongRow = 3;//计划使用行下标
                    let shiyongCol = 9;
                    let zaikuCol = 8;
                    sheet.options.isProtected = true;//开启表单保护
                    //渲染计划数据
                    for (var j = 0; j < res[i].day.length; j++) {
                        if (i == 0) {
                            sheet.setValue(shiyongRow, shiyongCol + j, res[i].day[j].shiyong);
                            sheet.setValue(1 + shiyongRow, shiyongCol + j, res[i].day[j].one);
                            sheet.getCell(shiyongRow,shiyongCol).locked(res[i].day[j].lock);
                            sheet.setValue(2 + shiyongRow, shiyongCol + j, res[i].day[j].two);
                            sheet.getCell(shiyongRow,shiyongCol).locked(res[i].day[j].lock);
                            sheet.setValue(3 + shiyongRow, shiyongCol + j, res[i].day[j].three);
                            sheet.getCell(shiyongRow,shiyongCol).locked(res[i].day[j].lock);
                            sheet.setValue(4 + shiyongRow, zaikuCol, res[i].day[j].zaiku);
                            sheet.setValue(5 + shiyongRow, shiyongCol + j, res[i].day[j].tianshu);
                        } else {
                            sheet.setValue(6 * i + shiyongRow, shiyongCol + j, res[i].day[j].shiyong);
                            sheet.setValue(6 * i + shiyongRow + 1, shiyongCol + j, res[i].day[j].one);
                            sheet.setValue(6 * i + shiyongRow + 2, shiyongCol + j, res[i].day[j].two);
                            sheet.setValue(6 * i + shiyongRow + 3, shiyongCol + j, res[i].day[j].three);
                            sheet.setValue(6 * i + shiyongRow + 4, zaikuCol, res[i].day[j].zaiku);
                            sheet.setValue(6 * i + shiyongRow + 5, shiyongCol + j, res[i].day[j].tianshu);
                        }
                        if(res[i].day[j].lock){
                            if(i==0){
                                let style_1S = new GC.Spread.Sheets.Style();
                                style_1S.locked = res[i].day[j].lock;
                                style_1S.backColor = "#F0F0F0";
                                parms.activeSheet.setStyle(1+shiyongRow, shiyongCol+j,style_1S);
                                let style_2S = new GC.Spread.Sheets.Style();
                                style_2S.locked = res[i].day[j].lock;
                                style_2S.backColor = "#F0F0F0";
                                parms.activeSheet.setStyle(2+shiyongRow, shiyongCol+j,style_2S);
                                let style_3S = new GC.Spread.Sheets.Style();
                                style_3S.locked = res[i].day[j].lock;
                                style_3S.backColor = "#F0F0F0";
                                parms.activeSheet.setStyle(3+shiyongRow, shiyongCol+j,style_3S);
                            }else{
                                let style_1S = new GC.Spread.Sheets.Style();
                                style_1S.locked = res[i].day[j].lock;
                                style_1S.backColor = "#F0F0F0";
                                parms.activeSheet.setStyle(6*i+shiyongRow+1, shiyongCol+j,style_1S);
                                let style_2S = new GC.Spread.Sheets.Style();
                                style_2S.locked = res[i].day[j].lock;
                                style_2S.backColor = "#F0F0F0";
                                parms.activeSheet.setStyle(6*i+shiyongRow+2, shiyongCol+j,style_2S);
                                let style_3S = new GC.Spread.Sheets.Style();
                                style_3S.locked = res[i].day[j].lock;
                                style_3S.backColor = "#F0F0F0";
                                parms.activeSheet.setStyle(6*i+shiyongRow+3, shiyongCol+j,style_3S);
                            }
                        }
                    }
                    // 根据数据长度添加表格行列
                    var addCol = res.length+6,addRow = 41;
                    var row = parms.ColumnCount+addRow;
                    var col = parms.RowCount+addCol;
                    spread.getSheet(0).setRowCount(col); //设置一列单元格的个数
                    spread.getSheet(0).setColumnCount(row); //设置一行有多少个单元格
                    parms.RowCount=col;
                    parms.ColumnCount=row;
                }
                let cell_T17 = parms.activeSheet.getCell(7,9);//保留数
                cell_T17.formula(`=SUM(R${6}:C${5},R${7}:C${5})`);
                spreadResume();// 恢复绘制
            }, error: function () {
                console.log('error')
            }
        })
    }
    /**
     * 打开弹出层
     * @param openPopup
     */
    function openPopup() {
        var popup = document.querySelector('.popup-layer');
        popup.style.display = 'block';
        popup.style.position = "absolute";
        popup.style.top = "35%";
        popup.style.left = "50%";
        popup.style.marginTop = "-75px";
        popup.style.marginLeft = "-150px";
        mybgs = document.createElement("div");
        mybgs.setAttribute("id", "mybgs");
        mybgs.style.background = "#000";
        mybgs.style.width = "100%";
        mybgs.style.height = "100%";
        mybgs.style.position = "absolute";
        mybgs.style.top = "0";
        mybgs.style.left = "0";
        mybgs.style.zIndex = "500";
        mybgs.style.opacity = "0.3";
        document.body.appendChild(mybgs);
        document.body.style.overflow = "hidden";
        let url = Api+"admin/scheduproductplanmonth/getApsWeekscheduleList";
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                parms.dschedulebeginData = res.data;
                var str = "";
                for (var i = 0; i < res.data.length; i++) {
                    str += `<tr>
                                <td>${res.data[i].ilevel}</td>
                                <td>${res.data[i].dscheduleendtime}</td>
                                <td>${res.data[i].dlockendtime==undefined?'':res.data[i].dlockendtime}</td>
                                <td width='130px'>
                                  <span onClick='levelSearch(${i},${res.data[i].ilevel})' style="margin-right:10px;cursor: pointer;color: #0000FF;">查看</span>
                                  <span style="margin-right:10px;cursor: pointer;color: #0000FF;">编辑</span>
                                  <span onClick='levelDelete(${i})'style="cursor: pointer;color: #0000FF;">删除</span>
                                 </td>
                               </tr>`;
                }
                $("#layer_tr").html(str);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    //表格数据查看
    function levelSearch(index,ilevel){
        let id = parms.dschedulebeginData[index].iautoid;
        window.location.replace(`admin/scheduproductplanmonth/monthweekSchedule?_jb_rqtype_=iframe&iWeekScheduleId=${id}&level=${ilevel}`);
    }
    //删除表格数据
    function levelDelete(index){
        let id = parms.dschedulebeginData[index].iautoid;
        let url = Api+`admin/scheduproductplanmonth/deleteApsWeekschedule?iWeekScheduleId=${id}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                if(res.msg=="操作成功"){
                    closePopup();//隐藏弹出层
                }
                showMessage(res.msg);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * 搜索事件
     * @param search
     * @param searchData 搜索需携带参数
     */
    let searchData={
        cworkname:'',
        cinvcode:'',
        cinvcode1:'',
        cinvname1:'',
    }
    function search(){
        const cworkname = document.getElementById('cworkname').value;
        const cinvcode = document.getElementById('cinvcode').value;
        const cinvcode1 = document.getElementById('cinvcode1').value;
        const cinvname1 = document.getElementById('cinvname1').value;
        searchData={
            cworkname,
            cinvcode,
            cinvcode1,
            cinvname1
        }
        initData(parms.id,parms.level);
    }
    //排场确定事件
    function savePopup(){
        //获取用户选择的时间
        const datetimeLocalInput = document.getElementById('datetime-local');
        const myVal = datetimeLocalInput.value.substring(0,10);
        const level = document.getElementById('level').value;
        let url = Api+`admin/scheduproductplanmonth/scheduPlanMonth?level=${level}&endDate=${myVal}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                    loadInit(parms);
                    initDate(parms,sheet);
                    initData();
                    closePopup();//隐藏弹出层
                showMessage(res.data.msg);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    /**
     * 关闭弹出层
     * @param closePopup
     */
    function closePopup() {
        var popup = document.querySelector('.popup-layer');
        popup.style.display = 'none';
        mybgs.style.display = "none";
    }
    //获取表格中输入或修改的值
    sheet.bind(GC.Spread.Sheets.Events.ValueChanged, function (e, info) {
        let a = {
            text:info.newValue,
            row:info.row,
            col:info.col
        }
        //每次添加之后往数组内进行存储
        parms.tableData.push(a);
    //
        let s = sheet.comments.get(info.row, info.col).locked(true).displayMode(1);
        console.log(a,"parms.tableData")
    });
    //spread获取当前点击的单元格
    sheet.bind(GC.Spread.Sheets.Events.CellClick, function (e, info) {
        // if (info.sheetArea === GC.Spread.Sheets.SheetArea.viewport) {
        //     parms.info=info;
        //     let {row,col} = parms.info;
        //     let a = {
        //         row:row,
        //         col:col
        //     }
        //     //每次添加之后往数组内进行存储
        //     parms.lockCells.push(a);
        //     //数组去重处理
        //     const unique = [];
        //     for (const item of parms.lockCells) {
        //         const duplicate = unique.find((key) => key.row === item.row && key.col === item.col);
        //         if (!duplicate) {
        //             unique.push(item);
        //         }
        //     }
        //     parms.lockCells=unique;
        //     console.log(parms.lockCells,"获取当前点击的单元格")
        // }
    });


    //锁定弹出框
    var myAlert = document.getElementById("alert");
    var reg = document.getElementById("content");
    var mClose = document.getElementById("close");
    var mClose_But = document.getElementById("close_but");
    var alertTitle = document.getElementById("title");

    //锁定打开弹出层
    reg.onclick = function(){
        if(myAlert.style.display !== "block"){
            myAlert.style.display = "block";
            alertTitle.innerText = "锁定计划";
            myAlert.style.position = "absolute";
            myAlert.style.top = "50%";
            myAlert.style.left = "50%";
            myAlert.style.marginTop = "-75px";
            myAlert.style.marginLeft = "-150px";
            mybg = document.createElement("div");
            mybg.setAttribute("id", "mybg");
            mybg.style.background = "#000";
            mybg.style.width = "100%";
            mybg.style.height = "100%";
            mybg.style.position = "absolute";
            mybg.style.top = "0";
            mybg.style.left = "0";
            mybg.style.zIndex = "500";
            mybg.style.opacity = "0.3";
            document.body.appendChild(mybg);
            document.body.style.overflow = "hidden";
            //锁定截止日期
            let url = Api+`admin/scheduproductplanmonth/getLockDate?iWeekScheduleId=${parms.id}`;
            $.ajax({
                url,
                type:'post',
                dataType:'json',
                success:function (res){
                    console.log(res)
                    parms.getLockDate = res.data;
                    const weekNum = document.getElementById('weekNum');
                    weekNum.innerText = parms.getLockDate[0].weekNum;
                    var options = "";
                    for (var i = 0; i < res.data.length; i++) {
                        options += "<option value='" + res.data[i].lockDate + "'>" + res.data[i].lockDate + "</option>";
                    }
                    $("#mySelect").html(options);
                },error: function(error) {
                    console.log(error);
                }
            })
        }
    }
    //获取用户点击锁定的截止日期
    const selectElement = document.getElementById('mySelect');
    selectElement.addEventListener('change', function() {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const selectedValue = selectedOption.value;
        const selectedText = selectedOption.text;
        const weekNum = document.getElementById('weekNum');
        if(alertTitle.innerText == "锁定计划"){
            const text = parms.getLockDate.find(item=>item.lockDate==selectedValue);
            weekNum.innerText = text.weekNum;
        }else{
            const text = parms.getLockDate.find(item=>item.unLockDate==selectedValue);
            weekNum.innerText = text.weekNum;
        }
    });
    //
    /**
     * 锁定确定按钮事件
     * @param save
     */
    function save(){
        const datetimeLocalInput = document.getElementById('mySelect');
        const myVal = datetimeLocalInput.value.substring(0,10);
        let url = alertTitle.innerText == "锁定计划"?Api+`admin/scheduproductplanmonth/lockScheduPlan?iWeekScheduleId=${parms.id}&endDate=${myVal}`
            :Api+`admin/scheduproductplanmonth/unLockScheduPlan?iWeekScheduleId=${parms.id}&endDate=${myVal}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                myAlert.style.display = "none";
                mybg.style.display = "none";
                initData();
                //设置表单保护，单元格不可编辑
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 7; j++) {
                        // 修改sheet默认locked为false
                        var defaultStyle = new GC.Spread.Sheets.Style();
                        defaultStyle.locked = false;
                        sheet.setDefaultStyle(defaultStyle, GC.Spread.Sheets.SheetArea.viewport);//设置第1行不可编辑
                        var style = new GC.Spread.Sheets.Style();
                        style.locked = true;
                        style.backColor = "#F0F0F0";
                        sheet.setStyle(i+4, j+9, style);
                        // 设置表单保护
                        sheet.options.isProtected = true;
                    }
                }
            },error: function(error) {
                console.log(error);
            }
        })
    }
    //弹出层关闭事件
    mClose.onclick = function(){
        myAlert.style.display = "none";
        mybg.style.display = "none";
    }
    //取消按钮事件
    mClose_But.onclick = function(){
        myAlert.style.display = "none";
        mybg.style.display = "none";
    }
    /**
     * 解锁计划
     * @param unLock
     */
    function unLock(){
        myAlert.style.display = "block";
        alertTitle.innerText = "解锁计划";
        myAlert.style.position = "absolute";
        myAlert.style.top = "50%";
        myAlert.style.left = "50%";
        myAlert.style.marginTop = "-75px";
        myAlert.style.marginLeft = "-150px";
        mybg = document.createElement("div");
        mybg.setAttribute("id", "mybg");
        mybg.style.background = "#000";
        mybg.style.width = "100%";
        mybg.style.height = "100%";
        mybg.style.position = "absolute";
        mybg.style.top = "0";
        mybg.style.left = "0";
        mybg.style.zIndex = "500";
        mybg.style.opacity = "0.3";
        document.body.appendChild(mybg);
        document.body.style.overflow = "hidden";
        let url = Api+`admin/scheduproductplanmonth/getUnLockDate?iWeekScheduleId=${parms.id}`;
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                parms.getLockDate = res.data;
                let weekNum = document.getElementById('weekNum');
                weekNum.innerText = parms.getLockDate[0].weekNum;
                var options = "";
                for (var i = 0; i < res.data.length; i++) {
                    options += "<option value='" + res.data[i].unLockDate + "'>" + res.data[i].unLockDate + "</option>";
                }
                $("#mySelect").html(options);
            },error: function(error) {
                console.log(error);
            }
        })
    }
    //测试向后端发送数据
    function edit(){
        let url = Api+"admin/scheduproductplanmonth/lockScheduPlan?iWeekScheduleId=1659809519734398976&endDate=2023-05-28";
        $.ajax({
            url,
            type:'post',
            dataType:'json',
            success:function (res){
                console.log(res);
                // myAlert.style.display = "none";
                // mybg.style.display = "none";
            },error: function(error) {
                console.log(error);
            }
        })
    }

    //给排产弹窗添加一个滑动区域，避免数据太长而造成样式崩塌
    const myTable = document.getElementById('popup_table');
    const tableContainer = document.getElementById('popup-layer');
    // 添加滚动事件处理程序
    tableContainer.addEventListener('scroll', function() {
        // 获取表头元素
        const tableHeader = myTable.querySelector('thead');
    });
    /**
     * @param messageBox 消息弹窗节点
     */
    const messageBox = document.getElementById('message-box');
    /**
     * @param showMessage 消息提示框显示
     * @param text 要显示的内容
     */
    function showMessage(text) {
        const msg = document.getElementById('msg');
        msg.innerText = text;
        messageBox.classList.remove('hidden');
        setTimeout(hideMessage, 1000); // 1秒后自动隐藏
    }
    /**
     * @param showMessage 消息提示框隐藏
     */
    function hideMessage() {
        messageBox.classList.add('hidden');
    }
</script>
#end
